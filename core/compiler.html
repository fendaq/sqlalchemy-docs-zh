<h1><span class="yiyi-st" id="yiyi-52">&#x81EA;&#x5B9A;&#x4E49;SQL&#x6784;&#x9020;&#x548C;&#x7F16;&#x8BD1;&#x6269;&#x5C55;<a class="headerlink" href="#module-sqlalchemy.ext.compiler" title="Permalink to this headline">&#xB6;</a></span></h1><p><span class="yiyi-st" id="yiyi-53">&#x63D0;&#x4F9B;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x81EA;&#x5B9A;&#x4E49;ClauseElements&#x548C;&#x7F16;&#x8BD1;&#x5668;&#x7684;API&#x3002;</span></p><div class="section" id="synopsis"><h2><span class="yiyi-st" id="yiyi-54">&#x6982;&#x8981;<a class="headerlink" href="#synopsis" title="Permalink to this headline">&#xB6; T0&gt;</a></span></h2><p><span class="yiyi-st" id="yiyi-55">&#x7528;&#x6CD5;&#x6D89;&#x53CA;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;<a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ClauseElement" title="sqlalchemy.sql.expression.ClauseElement"><code class="xref py py-class docutils literal"><span class="pre">ClauseElement</span></code></a>&#x5B50;&#x7C7B;&#x548C;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x5B9A;&#x4E49;&#x5176;&#x7F16;&#x8BD1;&#x7684;&#x53EF;&#x8C03;&#x53C2;&#x6570;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="kn">import</span> <span class="n">compiles</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">ColumnClause</span>

<span class="k">class</span> <span class="nc">MyColumn</span><span class="p">(</span><span class="n">ColumnClause</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">MyColumn</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_mycolumn</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="o">.</span><span class="n">name</span></pre></div></div><p><span class="yiyi-st" id="yiyi-56">Above, <code class="docutils literal"><span class="pre">MyColumn</span></code> extends <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnClause" title="sqlalchemy.sql.expression.ColumnClause"><code class="xref py py-class docutils literal"><span class="pre">ColumnClause</span></code></a>, the base expression element for named column objects. </span><span class="yiyi-st" id="yiyi-57"><code class="docutils literal"><span class="pre">compiles</span></code>&#x4FEE;&#x9970;&#x7B26;&#x5411;<code class="docutils literal"><span class="pre">MyColumn</span></code>&#x7C7B;&#x6CE8;&#x518C;&#x81EA;&#x5DF1;&#xFF0C;&#x4EE5;&#x4FBF;&#x5728;&#x5BF9;&#x8C61;&#x7F16;&#x8BD1;&#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#x65F6;&#x8C03;&#x7528;&#x5B83;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">MyColumn</span><span class="p">(</span><span class="s1">&apos;x&apos;</span><span class="p">),</span> <span class="n">MyColumn</span><span class="p">(</span><span class="s1">&apos;y&apos;</span><span class="p">)])</span>
<span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-58">&#x751F;&#x4EA7;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span><span class="p">]</span></pre></div></div></div><div class="section" id="dialect-specific-compilation-rules"><h2><span class="yiyi-st" id="yiyi-59">&#x7279;&#x5B9A;&#x4E8E;&#x65B9;&#x8A00;&#x7684;&#x7F16;&#x8BD1;&#x89C4;&#x5219;<a class="headerlink" href="#dialect-specific-compilation-rules" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-60">&#x7F16;&#x8BD1;&#x5668;&#x4E5F;&#x53EF;&#x4EE5;&#x5236;&#x4F5C;&#x65B9;&#x8A00;&#x7279;&#x5B9A;&#x7684;&#x3002;</span><span class="yiyi-st" id="yiyi-61">&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x65B9;&#x8A00;&#x5C06;&#x8C03;&#x7528;&#x9002;&#x5F53;&#x7684;&#x7F16;&#x8BD1;&#x5668;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="kn">import</span> <span class="n">DDLElement</span>

<span class="k">class</span> <span class="nc">AlterColumn</span><span class="p">(</span><span class="n">DDLElement</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">AlterColumn</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">visit_alter_column</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;ALTER COLUMN </span><span class="si">%s</span><span class="s2"> ...&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">name</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">AlterColumn</span><span class="p">,</span> <span class="s1">&apos;postgresql&apos;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">visit_alter_column</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;ALTER TABLE </span><span class="si">%s</span><span class="s2"> ALTER COLUMN </span><span class="si">%s</span><span class="s2"> ...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                   <span class="n">element</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-62">&#x5F53;&#x4F7F;&#x7528;&#x4EFB;&#x4F55;<code class="docutils literal"><span class="pre">postgresql</span></code>&#x65B9;&#x8A00;&#x65F6;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;<code class="docutils literal"><span class="pre">visit_alter_table</span></code>&#x5C06;&#x88AB;&#x8C03;&#x7528;&#x3002;</span></p></div><div class="section" id="compiling-sub-elements-of-a-custom-expression-construct"><h2><span class="yiyi-st" id="yiyi-63">&#x7F16;&#x8BD1;&#x81EA;&#x5B9A;&#x4E49;&#x8868;&#x8FBE;&#x5F0F;&#x7ED3;&#x6784;<a class="headerlink" href="#compiling-sub-elements-of-a-custom-expression-construct" title="Permalink to this headline">&#xB6;</a>&#x7684;&#x5B50;&#x5143;&#x7D20;</span></h2><p><span class="yiyi-st" id="yiyi-64"><code class="docutils literal"><span class="pre">compiler</span></code>&#x53C2;&#x6570;&#x662F;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;<a class="reference internal" href="internals.html#sqlalchemy.engine.interfaces.Compiled" title="sqlalchemy.engine.interfaces.Compiled"><code class="xref py py-class docutils literal"><span class="pre">Compiled</span></code></a>&#x5BF9;&#x8C61;&#x3002;</span><span class="yiyi-st" id="yiyi-65">&#x53EF;&#x4EE5;&#x68C0;&#x67E5;&#x6B64;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x6709;&#x4EFB;&#x4F55;&#x5173;&#x4E8E;&#x6B63;&#x5728;&#x8FDB;&#x884C;&#x7684;&#x7F16;&#x8BD1;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5305;&#x62EC;<code class="docutils literal"><span class="pre">compiler.dialect</span></code>&#xFF0C;<code class="docutils literal"><span class="pre">compiler.statement</span></code>&#x7B49;&#x3002;</span><span class="yiyi-st" id="yiyi-66"><a class="reference internal" href="internals.html#sqlalchemy.sql.compiler.SQLCompiler" title="sqlalchemy.sql.compiler.SQLCompiler"><code class="xref py py-class docutils literal"><span class="pre">SQLCompiler</span></code></a>&#x548C;<a class="reference internal" href="internals.html#sqlalchemy.sql.compiler.DDLCompiler" title="sqlalchemy.sql.compiler.DDLCompiler"><code class="xref py py-class docutils literal"><span class="pre">DDLCompiler</span></code></a>&#x90FD;&#x5305;&#x542B;&#x4E00;&#x4E2A;<code class="docutils literal"><span class="pre">process()</span></code>&#x65B9;&#x6CD5;&#xFF0C;&#x53EF;&#x7528;&#x4E8E;&#x7F16;&#x8BD1;&#x5D4C;&#x5165;&#x5C5E;&#x6027;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">Executable</span><span class="p">,</span> <span class="n">ClauseElement</span>

<span class="k">class</span> <span class="nc">InsertFromSelect</span><span class="p">(</span><span class="n">Executable</span><span class="p">,</span> <span class="n">ClauseElement</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="n">select</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">InsertFromSelect</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">visit_insert_from_select</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;INSERT INTO </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">asfrom</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">select</span><span class="p">)</span>
    <span class="p">)</span>

<span class="n">insert</span> <span class="o">=</span> <span class="n">InsertFromSelect</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">select</span><span class="p">([</span><span class="n">t1</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">))</span>
<span class="k">print</span> <span class="n">insert</span></pre></div></div><p><span class="yiyi-st" id="yiyi-67">&#x751F;&#x4EA7;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>&quot;INSERT INTO mytable (SELECT mytable.x, mytable.y, mytable.z
                      FROM mytable WHERE mytable.x &gt; :x_1)&quot;</pre></div></div><div class="admonition note"><p class="first admonition-title"><span class="yiyi-st" id="yiyi-68">&#x6CE8;&#x610F;</span></p><p class="last"><span class="yiyi-st" id="yiyi-69">&#x4E0A;&#x9762;&#x7684;<code class="docutils literal"><span class="pre">InsertFromSelect</span></code>&#x7ED3;&#x6784;&#x4EC5;&#x4EC5;&#x662F;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x8FD9;&#x4E2A;&#x5B9E;&#x9645;&#x7684;&#x529F;&#x80FD;&#x5DF2;&#x7ECF;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<a class="reference internal" href="dml.html#sqlalchemy.sql.expression.Insert.from_select" title="sqlalchemy.sql.expression.Insert.from_select"><code class="xref py py-meth docutils literal"><span class="pre">Insert.from_select()</span></code></a>&#x65B9;&#x6CD5;&#x4E86;&#x3002;</span></p></div><div class="admonition note"><p class="first admonition-title"><span class="yiyi-st" id="yiyi-70">&#x6CE8;&#x610F;</span></p><p class="last"><span class="yiyi-st" id="yiyi-71">&#x4E0A;&#x9762;&#x7684;<code class="docutils literal"><span class="pre">InsertFromSelect</span></code>&#x6784;&#x9020;&#x53EF;&#x80FD;&#x5E0C;&#x671B;&#x542F;&#x7528;&#x201C;autocommit&#x201D;&#x3002;</span><span class="yiyi-st" id="yiyi-72">&#x6709;&#x5173;&#x6B64;&#x6B65;&#x9AA4;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="#enabling-compiled-autocommit"><span>Enabling Autocommit on a Construct</span></a>&#x3002;</span></p></div><div class="section" id="cross-compiling-between-sql-and-ddl-compilers"><h3><span class="yiyi-st" id="yiyi-73">&#x5728;SQL&#x548C;DDL&#x7F16;&#x8BD1;&#x5668;&#x4E4B;&#x95F4;&#x4EA4;&#x53C9;&#x7F16;&#x8BD1;<a class="headerlink" href="#cross-compiling-between-sql-and-ddl-compilers" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-74">SQL&#x548C;DDL&#x7ED3;&#x6784;&#x5206;&#x522B;&#x4F7F;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x57FA;&#x672C;&#x7F16;&#x8BD1;&#x5668; -  <code class="docutils literal"><span class="pre">SQLCompiler</span></code>&#x548C;<code class="docutils literal"><span class="pre">DDLCompiler</span></code>&#x8FDB;&#x884C;&#x7F16;&#x8BD1;&#x3002;</span><span class="yiyi-st" id="yiyi-75">&#x5E38;&#x89C1;&#x7684;&#x9700;&#x6C42;&#x662F;&#x4ECE;DDL&#x8868;&#x8FBE;&#x5F0F;&#x4E2D;&#x8BBF;&#x95EE;SQL&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x7F16;&#x8BD1;&#x89C4;&#x5219;&#x3002;</span><span class="yiyi-st" id="yiyi-76">&#x7531;&#x4E8E;&#x8FD9;&#x4E2A;&#x539F;&#x56E0;&#xFF0C;<code class="docutils literal"><span class="pre">DDLCompiler</span></code>&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x8BBF;&#x95EE;&#x5668;<code class="docutils literal"><span class="pre">sql_compiler</span></code>&#xFF0C;&#x6BD4;&#x5982;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x5D4C;&#x5165;SQL&#x8868;&#x8FBE;&#x5F0F;&#x7684;CHECK&#x7EA6;&#x675F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@compiles</span><span class="p">(</span><span class="n">MyConstraint</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_my_constraint</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">ddlcompiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;CONSTRAINT </span><span class="si">%s</span><span class="s2"> CHECK (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">constraint</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">ddlcompiler</span><span class="o">.</span><span class="n">sql_compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
            <span class="n">constraint</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span> <span class="n">literal_binds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-77">&#x4E0A;&#x9762;&#xFF0C;&#x6211;&#x4EEC;&#x5728;<code class="xref py py-meth docutils literal"><span class="pre">SQLCompiler.process()</span></code>&#xFF08;&#x5373;<code class="docutils literal"><span class="pre">literal_binds</span></code>&#xFF09;&#x6807;&#x5FD7;&#x8C03;&#x7528;&#x7684;&#x8FC7;&#x7A0B;&#x6B65;&#x9AA4;&#x4E2D;&#x6DFB;&#x52A0;&#x4E86;&#x4E00;&#x4E2A;&#x989D;&#x5916;&#x7684;&#x6807;&#x5FD7;&#x3002;</span><span class="yiyi-st" id="yiyi-78">This indicates that any SQL expression which refers to a <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.BindParameter" title="sqlalchemy.sql.expression.BindParameter"><code class="xref py py-class docutils literal"><span class="pre">BindParameter</span></code></a> object or other &#x201C;literal&#x201D; object such as those which refer to strings or integers should be rendered <strong>in-place</strong>, rather than being referred to as a bound parameter; when emitting DDL, bound parameters are typically not supported.</span></p></div></div><div class="section" id="enabling-autocommit-on-a-construct"><h2><span class="yiyi-st" id="yiyi-79">&#x5728;&#x6784;&#x9020;&#x4E0A;&#x542F;&#x7528;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;<a class="headerlink" href="#enabling-autocommit-on-a-construct" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-80">&#x5F53;&#x88AB;&#x8981;&#x6C42;&#x5728;&#x6CA1;&#x6709;&#x7528;&#x6237;&#x5B9A;&#x4E49;&#x4E8B;&#x52A1;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x6267;&#x884C;&#x6784;&#x9020;&#x65F6;&#xFF0C;&#x56DE;&#x987E;<a class="reference internal" href="connections.html#autocommit"><span>Understanding Autocommit</span></a>&#x65F6;&#xFF0C;<a class="reference internal" href="connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x68C0;&#x6D4B;&#x7ED9;&#x5B9A;&#x6784;&#x9020;&#x662F;&#x5426;&#x8868;&#x793A;DML&#x6216;DDL&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x6570;&#x636E;&#x4FEE;&#x6539;&#x6216;&#x6570;&#x636E;&#x5B9A;&#x4E49;&#x8BED;&#x53E5;&#x9700;&#x8981;&#xFF08;&#x6216;&#x8005;&#x53EF;&#x80FD;&#x9700;&#x8981;&#xFF0C;&#x5728;DDL&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF09;&#x7531;DBAPI&#x751F;&#x6210;&#x7684;&#x4E8B;&#x52A1;&#x88AB;&#x63D0;&#x4EA4;&#xFF08;&#x56DE;&#x60F3;&#x8D77;&#xFF0C;&#x65E0;&#x8BBA;SQLAlchemy&#x505A;&#x4EC0;&#x4E48;&#xFF0C;DBAPI&#x603B;&#x662F;&#x6709;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x6B63;&#x5728;&#x8FDB;&#x884C;&#xFF09;&#x3002;</span><span class="yiyi-st" id="yiyi-81">&#x901A;&#x8FC7;&#x68C0;&#x67E5;&#x7ED3;&#x6784;&#x4E0A;&#x7684;&#x201C;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;&#x201D;&#x6267;&#x884C;&#x9009;&#x9879;&#x5B9E;&#x9645;&#x4E0A;&#x53EF;&#x4EE5;&#x5B8C;&#x6210;&#x68C0;&#x67E5;&#x3002;</span><span class="yiyi-st" id="yiyi-82">&#x5728;&#x6784;&#x5EFA;&#x50CF;INSERT&#x6D3E;&#x751F;&#xFF0C;&#x65B0;&#x7684;DDL&#x7C7B;&#x578B;&#x6216;&#x53EF;&#x80FD;&#x6539;&#x53D8;&#x6570;&#x636E;&#x7684;&#x5B58;&#x50A8;&#x8FC7;&#x7A0B;&#x7684;&#x6784;&#x9020;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x201C;autocommit&#x201D;&#x9009;&#x9879;&#x4EE5;&#x4F7F;&#x8BED;&#x53E5;&#x5728;&#x201C;&#x65E0;&#x8FDE;&#x63A5;&#x201D;&#x6267;&#x884C;&#x65F6;&#x8FD0;&#x884C;&#xFF08;&#x5982;<a class="reference internal" href="connections.html#dbengine-implicit"><span>Connectionless Execution, Implicit Execution</span></a>&#xFF09;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-83">&#x76EE;&#x524D;&#xFF0C;&#x4E00;&#x4E2A;&#x5FEB;&#x901F;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x5C06;<a class="reference internal" href="selectable.html#sqlalchemy.sql.expression.Executable" title="sqlalchemy.sql.expression.Executable"><code class="xref py py-class docutils literal"><span class="pre">Executable</span></code></a>&#x5B50;&#x7C7B;&#x5316;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x201C;autocommit&#x201D;&#x6807;&#x5FD7;&#x6DFB;&#x52A0;&#x5230;<code class="docutils literal"><span class="pre">_execution_options</span></code>&#x5B57;&#x5178;&#x4E2D;&#xFF08;&#x6CE8;&#x610F;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x201C;&#x51BB;&#x7ED3;&#x201D; <code class="docutils literal"><span class="pre">union()</span></code>&#x65B9;&#x6CD5;&#xFF09;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">Executable</span><span class="p">,</span> <span class="n">ClauseElement</span>

<span class="k">class</span> <span class="nc">MyInsertThing</span><span class="p">(</span><span class="n">Executable</span><span class="p">,</span> <span class="n">ClauseElement</span><span class="p">):</span>
    <span class="n">_execution_options</span> <span class="o">=</span> \
        <span class="n">Executable</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">union</span><span class="p">({</span><span class="s1">&apos;autocommit&apos;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span></pre></div></div><p><span class="yiyi-st" id="yiyi-84">More succinctly, if the construct is truly similar to an INSERT, UPDATE, or DELETE, <a class="reference internal" href="dml.html#sqlalchemy.sql.expression.UpdateBase" title="sqlalchemy.sql.expression.UpdateBase"><code class="xref py py-class docutils literal"><span class="pre">UpdateBase</span></code></a> can be used, which already is a subclass of <a class="reference internal" href="selectable.html#sqlalchemy.sql.expression.Executable" title="sqlalchemy.sql.expression.Executable"><code class="xref py py-class docutils literal"><span class="pre">Executable</span></code></a>, <a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ClauseElement" title="sqlalchemy.sql.expression.ClauseElement"><code class="xref py py-class docutils literal"><span class="pre">ClauseElement</span></code></a> and includes the <code class="docutils literal"><span class="pre">autocommit</span></code> flag:</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">UpdateBase</span>

<span class="k">class</span> <span class="nc">MyInsertThing</span><span class="p">(</span><span class="n">UpdateBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="o">...</span></pre></div></div><p><span class="yiyi-st" id="yiyi-85">&#x5B50;&#x7C7B;<a class="reference internal" href="ddl.html#sqlalchemy.schema.DDLElement" title="sqlalchemy.schema.DDLElement"><code class="xref py py-class docutils literal"><span class="pre">DDLElement</span></code></a>&#x7684;DDL&#x5143;&#x7D20;&#x5DF2;&#x7ECF;&#x6253;&#x5F00;&#x4E86;&#x201C;autocommit&#x201D;&#x6807;&#x5FD7;&#x3002;</span></p></div><div class="section" id="changing-the-default-compilation-of-existing-constructs"><h2><span class="yiyi-st" id="yiyi-86">&#x66F4;&#x6539;&#x73B0;&#x6709;&#x6784;&#x9020;&#x7684;&#x9ED8;&#x8BA4;&#x7F16;&#x8BD1;<a class="headerlink" href="#changing-the-default-compilation-of-existing-constructs" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-87">&#x7F16;&#x8BD1;&#x5668;&#x6269;&#x5C55;&#x4E5F;&#x9002;&#x7528;&#x4E8E;&#x73B0;&#x6709;&#x7684;&#x6784;&#x9020;&#x3002;</span><span class="yiyi-st" id="yiyi-88">&#x5F53;&#x8986;&#x76D6;&#x5185;&#x7F6E;&#x7684;SQL&#x6784;&#x9020;&#x7684;&#x7F16;&#x8BD1;&#x65F6;&#xFF0C;@compiles&#x88C5;&#x9970;&#x5668;&#x5C06;&#x5728;&#x9002;&#x5F53;&#x7684;&#x7C7B;&#x4E0A;&#x8C03;&#x7528;&#xFF08;&#x786E;&#x4FDD;&#x4F7F;&#x7528;&#x8BE5;&#x7C7B;&#xFF0C;&#x5373;<code class="docutils literal"><span class="pre">Insert</span></code>&#x6216;<code class="docutils literal"><span class="pre">Select</span></code>&#xFF09;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x521B;&#x5EFA;&#x51FD;&#x6570;&#xFF0C;&#x5982;<code class="docutils literal"><span class="pre">insert()</span></code>&#x6216;<code class="docutils literal"><span class="pre">select()</span></code>&#xFF09;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-89">&#x5728;&#x65B0;&#x7684;&#x7F16;&#x8BD1;&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x4E3A;&#x4E86;&#x83B7;&#x5F97;&#x201C;&#x539F;&#x59CB;&#x201D;&#x7F16;&#x8BD1;&#x4F8B;&#x7A0B;&#xFF0C;&#x4F7F;&#x7528;&#x9002;&#x5F53;&#x7684;visit_XXX&#x65B9;&#x6CD5; - &#x8FD9;&#x662F;&#x56E0;&#x4E3A;compiler.process()&#x5C06;&#x8C03;&#x7528;&#x91CD;&#x5199;&#x4F8B;&#x7A0B;&#x5E76;&#x5BFC;&#x81F4;&#x65E0;&#x9650;&#x5FAA;&#x73AF;&#x3002;</span><span class="yiyi-st" id="yiyi-90">&#x6BD4;&#x5982;&#xFF0C;&#x4E3A;&#x6240;&#x6709;&#x63D2;&#x5165;&#x8BED;&#x53E5;&#x6DFB;&#x52A0;&#x201C;&#x524D;&#x7F00;&#x201D;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">Insert</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">Insert</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">prefix_inserts</span><span class="p">(</span><span class="n">insert</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">visit_insert</span><span class="p">(</span><span class="n">insert</span><span class="o">.</span><span class="n">prefix_with</span><span class="p">(</span><span class="s2">&quot;some prefix&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-91">&#x4E0A;&#x9762;&#x7684;&#x7F16;&#x8BD1;&#x5668;&#x4F1A;&#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x4E3A;&#x6240;&#x6709;INSERT&#x8BED;&#x53E5;&#x52A0;&#x4E0A;&#x201C;some prefix&#x201D;&#x3002;</span></p></div><div class="section" id="changing-compilation-of-types"><h2><span class="yiyi-st" id="yiyi-92">&#x66F4;&#x6539;&#x7C7B;&#x578B;&#x7684;&#x7F16;&#x8BD1;<a class="headerlink" href="#changing-compilation-of-types" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-93"><code class="docutils literal"><span class="pre">compiler</span></code>&#x4E5F;&#x9002;&#x7528;&#x4E8E;&#x7C7B;&#x578B;&#xFF0C;&#x4F8B;&#x5982;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x4E3A;<code class="docutils literal"><span class="pre">String</span></code> / <code class="docutils literal"><span class="pre">VARCHAR</span></code>&#x5B9E;&#x73B0;&#x7279;&#x5B9A;&#x4E8E;MS-SQL&#x7684;&apos;max&apos;&#x5173;&#x952E;&#x5B57;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@compiles</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s1">&apos;mssql&apos;</span><span class="p">)</span>
<span class="nd">@compiles</span><span class="p">(</span><span class="n">VARCHAR</span><span class="p">,</span> <span class="s1">&apos;mssql&apos;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_varchar</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="s1">&apos;max&apos;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;VARCHAR(&apos;max&apos;)&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">visit_VARCHAR</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="n">foo</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&apos;foo&apos;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&apos;data&apos;</span><span class="p">,</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="s1">&apos;max&apos;</span><span class="p">))</span>
<span class="p">)</span></pre></div></div></div><div class="section" id="subclassing-guidelines"><h2><span class="yiyi-st" id="yiyi-94">&#x5B50;&#x7C7B;&#x6307;&#x5357;<a class="headerlink" href="#subclassing-guidelines" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-95">&#x4F7F;&#x7528;&#x7F16;&#x8BD1;&#x5668;&#x6269;&#x5C55;&#x7684;&#x5F88;&#x5927;&#x4E00;&#x90E8;&#x5206;&#x662F;&#x5BF9;SQLAlchemy&#x8868;&#x8FBE;&#x5F0F;&#x7ED3;&#x6784;&#x8FDB;&#x884C;&#x5B50;&#x7C7B;&#x5316;&#x3002;</span><span class="yiyi-st" id="yiyi-96">&#x4E3A;&#x4E86;&#x4F7F;&#x8FD9;&#x66F4;&#x5BB9;&#x6613;&#xFF0C;&#x8868;&#x8FBE;&#x5F0F;&#x548C;&#x6A21;&#x5F0F;&#x5305;&#x5305;&#x542B;&#x4E00;&#x7EC4;&#x7528;&#x4E8E;&#x5E38;&#x89C1;&#x4EFB;&#x52A1;&#x7684;&#x201C;&#x57FA;&#x7840;&#x201D;&#x3002;</span><span class="yiyi-st" id="yiyi-97">&#x7B80;&#x4ECB;&#x5982;&#x4E0B;&#xFF1A;</span></p><ul><li><p class="first"><span class="yiyi-st" id="yiyi-98"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ClauseElement" title="sqlalchemy.sql.expression.ClauseElement"><code class="xref py py-class docutils literal"><span class="pre">ClauseElement</span></code></a>  - &#x8FD9;&#x662F;&#x6839;&#x8868;&#x8FBE;&#x5F0F;&#x7C7B;&#x3002;</span><span class="yiyi-st" id="yiyi-99">&#x4EFB;&#x4F55;SQL&#x8868;&#x8FBE;&#x5F0F;&#x90FD;&#x53EF;&#x4EE5;&#x4ECE;&#x6B64;&#x57FA;&#x7840;&#x6D3E;&#x751F;&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x80FD;&#x662F;&#x66F4;&#x957F;&#x7684;&#x6784;&#x9020;&#xFF08;&#x5982;&#x4E13;&#x7528;INSERT&#x8BED;&#x53E5;&#xFF09;&#x7684;&#x6700;&#x4F73;&#x9009;&#x62E9;&#x3002;</span></p></li><li><p class="first"><span class="yiyi-st" id="yiyi-100"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><code class="xref py py-class docutils literal"><span class="pre">ColumnElement</span></code></a>  - &#x6240;&#x6709;&#x201C;&#x5217;&#x5F0F;&#x201D;&#x5143;&#x7D20;&#x7684;&#x6839;&#x3002;</span><span class="yiyi-st" id="yiyi-101">&#x4EFB;&#x4F55;&#x4F60;&#x653E;&#x5728;SELECT&#x8BED;&#x53E5;&#x7684;&#x201C;columns&#x201D;&#x5B50;&#x53E5;&#x4E2D;&#x7684;&#x4E1C;&#x897F;&#xFF08;&#x4EE5;&#x53CA;order by&#x548C;group by&#xFF09;&#x90FD;&#x53EF;&#x4EE5;&#x4ECE;&#x4E2D;&#x5F97;&#x5230; - &#x5BF9;&#x8C61;&#x5C06;&#x81EA;&#x52A8;&#x5177;&#x6709;Python&#x7684;&#x201C;&#x6BD4;&#x8F83;&#x201D;&#x884C;&#x4E3A;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-102"><a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><code class="xref py py-class docutils literal"><span class="pre">ColumnElement</span></code></a> classes want to have a <code class="docutils literal"><span class="pre">type</span></code> member which is expression&#x2019;s return type. </span><span class="yiyi-st" id="yiyi-103">&#x8FD9;&#x53EF;&#x4EE5;&#x5728;&#x6784;&#x9020;&#x51FD;&#x6570;&#x7684;&#x5B9E;&#x4F8B;&#x7EA7;&#x522B;&#x5EFA;&#x7ACB;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5728;&#x7C7B;&#x7EA7;&#x522B;&#x5EFA;&#x7ACB;&#xFF0C;&#x5982;&#x679C;&#x5B83;&#x901A;&#x5E38;&#x662F;&#x5E38;&#x91CF;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">timestamp</span><span class="p">(</span><span class="n">ColumnElement</span><span class="p">):</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">TIMESTAMP</span><span class="p">()</span></pre></div></div></li><li><p class="first"><span class="yiyi-st" id="yiyi-104"><a class="reference internal" href="functions.html#sqlalchemy.sql.functions.FunctionElement" title="sqlalchemy.sql.functions.FunctionElement"><code class="xref py py-class docutils literal"><span class="pre">FunctionElement</span></code></a>  - &#x8FD9;&#x662F;<code class="docutils literal"><span class="pre">ColumnElement</span></code>&#x548C;&#x201C;from&#x5B50;&#x53E5;&#x201D;&#x7C7B;&#x4F3C;&#x5BF9;&#x8C61;&#x7684;&#x6DF7;&#x5408;&#x4F53;&#xFF0C;&#x5E76;&#x4E14;&#x8868;&#x793A;SQL&#x51FD;&#x6570;&#x6216;&#x5B58;&#x50A8;&#x8FC7;&#x7A0B;&#x7C7B;&#x578B;&#x7684;&#x8C03;&#x7528;&#x3002;</span><span class="yiyi-st" id="yiyi-105">Since most databases support statements along the line of &#x201C;SELECT FROM <some function="">&#x201D; <code class="docutils literal"><span class="pre">FunctionElement</span></code> adds in the ability to be used in the FROM clause of a <code class="docutils literal"><span class="pre">select()</span></code> construct:</some></span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">FunctionElement</span>

<span class="k">class</span> <span class="nc">coalesce</span><span class="p">(</span><span class="n">FunctionElement</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&apos;coalesce&apos;</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">coalesce</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;coalesce(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">clauses</span><span class="p">)</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">coalesce</span><span class="p">,</span> <span class="s1">&apos;oracle&apos;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">clauses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;coalesce only supports two arguments on Oracle&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;nvl(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">clauses</span><span class="p">)</span></pre></div></div></li><li><p class="first"><span class="yiyi-st" id="yiyi-106"><a class="reference internal" href="ddl.html#sqlalchemy.schema.DDLElement" title="sqlalchemy.schema.DDLElement"><code class="xref py py-class docutils literal"><span class="pre">DDLElement</span></code></a>  - &#x6240;&#x6709;DDL&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x6839;&#xFF0C;&#x4F8B;&#x5982;CREATE TABLE&#xFF0C;ALTER TABLE&#x7B49;&#x3002;</span><span class="yiyi-st" id="yiyi-107"><code class="docutils literal"><span class="pre">DDLElement</span></code>&#x5B50;&#x7C7B;&#x7684;&#x7F16;&#x8BD1;&#x7531;<code class="docutils literal"><span class="pre">DDLCompiler</span></code>&#x800C;&#x4E0D;&#x662F;<code class="docutils literal"><span class="pre">SQLCompiler</span></code>&#x53D1;&#x5E03;&#x3002;</span><span class="yiyi-st" id="yiyi-108"><code class="docutils literal"><span class="pre">DDLElement</span></code> also features <code class="docutils literal"><span class="pre">Table</span></code> and <code class="docutils literal"><span class="pre">MetaData</span></code> event hooks via the <code class="docutils literal"><span class="pre">execute_at()</span></code> method, allowing the construct to be invoked during CREATE TABLE and DROP TABLE sequences.</span></p></li><li><p class="first"><span class="yiyi-st" id="yiyi-109"><a class="reference internal" href="selectable.html#sqlalchemy.sql.expression.Executable" title="sqlalchemy.sql.expression.Executable"><code class="xref py py-class docutils literal"><span class="pre">Executable</span></code></a> - This is a mixin which should be used with any expression class that represents a &#x201C;standalone&#x201D; SQL statement that can be passed directly to an <code class="docutils literal"><span class="pre">execute()</span></code> method. </span><span class="yiyi-st" id="yiyi-110">&#x5B83;&#x5DF2;&#x7ECF;&#x9690;&#x542B;&#x5728;<code class="docutils literal"><span class="pre">DDLElement</span></code>&#x548C;<code class="docutils literal"><span class="pre">FunctionElement</span></code>&#x4E2D;&#x3002;</span></p></li></ul></div><div class="section" id="further-examples"><h2><span class="yiyi-st" id="yiyi-111">&#x66F4;&#x591A;&#x793A;&#x4F8B;<a class="headerlink" href="#further-examples" title="Permalink to this headline">&#xB6;</a></span></h2><div class="section" id="utc-timestamp-function"><h3><span class="yiyi-st" id="yiyi-112">&#x201C;UTC&#x65F6;&#x95F4;&#x6233;&#x201D;&#x529F;&#x80FD;<a class="headerlink" href="#utc-timestamp-function" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-113">&#x4E00;&#x79CD;&#x7C7B;&#x4F3C;&#x4E8E;&#x201C;CURRENT_TIMESTAMP&#x201D;&#x7684;&#x51FD;&#x6570;&#x9664;&#x4E86;&#x5E94;&#x7528;&#x9002;&#x5F53;&#x7684;&#x8F6C;&#x6362;&#x4EE5;&#x4FBF;&#x65F6;&#x95F4;&#x4E3A;UTC&#x65F6;&#x95F4;&#x3002;</span><span class="yiyi-st" id="yiyi-114">&#x65F6;&#x95F4;&#x6233;&#x6700;&#x597D;&#x4F5C;&#x4E3A;UTC&#x5B58;&#x50A8;&#x5728;&#x5173;&#x7CFB;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#xFF0C;&#x4E0D;&#x5E26;&#x65F6;&#x533A;&#x3002;</span><span class="yiyi-st" id="yiyi-115">UTC&#xFF0C;&#x8FD9;&#x6837;&#x60A8;&#x7684;&#x6570;&#x636E;&#x5E93;&#x5C31;&#x4E0D;&#x4F1A;&#x8BA4;&#x4E3A;&#x590F;&#x4EE4;&#x65F6;&#x7ED3;&#x675F;&#x65F6;&#xFF0C;&#x65F6;&#x95F4;&#x6CA1;&#x6709;&#x53CD;&#x8FC7;&#x6765;&#xFF0C;&#x56E0;&#x4E3A;&#x65F6;&#x533A;&#x5C31;&#x50CF;&#x5B57;&#x7B26;&#x7F16;&#x7801;&#x4E00;&#x6837;&#xFF0C;&#x6CA1;&#x6709;&#x65F6;&#x533A; - &#x5B83;&#x4EEC;&#x6700;&#x597D;&#x53EA;&#x5E94;&#x7528;&#x4E8E;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x7AEF;&#x70B9;&#xFF08;&#x5373;&#x5728;&#x7528;&#x6237;&#x8F93;&#x5165;&#x65F6;&#x8F6C;&#x6362;&#x4E3A;UTC &#xFF0C;&#x5728;&#x663E;&#x793A;&#x65F6;&#x91CD;&#x65B0;&#x5E94;&#x7528;&#x671F;&#x671B;&#x7684;&#x65F6;&#x533A;&#xFF09;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-116">&#x5BF9;&#x4E8E;Postgresql&#x548C;Microsoft SQL Server&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">expression</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="kn">import</span> <span class="n">compiles</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">DateTime</span>

<span class="k">class</span> <span class="nc">utcnow</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">FunctionElement</span><span class="p">):</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">()</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">utcnow</span><span class="p">,</span> <span class="s1">&apos;postgresql&apos;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pg_utcnow</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;TIMEZONE(&apos;utc&apos;, CURRENT_TIMESTAMP)&quot;</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">utcnow</span><span class="p">,</span> <span class="s1">&apos;mssql&apos;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ms_utcnow</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;GETUTCDATE()&quot;</span></pre></div></div><p><span class="yiyi-st" id="yiyi-117">&#x7528;&#x6CD5;&#x793A;&#x4F8B;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">MetaData</span>
        <span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">event</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">utcnow</span><span class="p">())</span>
<span class="p">)</span></pre></div></div></div><div class="section" id="greatest-function"><h3><span class="yiyi-st" id="yiyi-118">&#x201C;GREATEST&#x201D;&#x529F;&#x80FD;<a class="headerlink" href="#greatest-function" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-119">&#x201C;GREATEST&#x201D;&#x51FD;&#x6570;&#x88AB;&#x8D4B;&#x4E88;&#x4EFB;&#x610F;&#x6570;&#x91CF;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x6700;&#x9AD8;&#x503C;&#x7684;&#x90A3;&#x4E2A; - &#x5B83;&#x7B49;&#x4EF7;&#x4E8E;Python&#x7684;<code class="docutils literal"><span class="pre">max</span></code>&#x51FD;&#x6570;&#x3002;</span><span class="yiyi-st" id="yiyi-120">SQL&#x6807;&#x51C6;&#x7248;&#x672C;&#x4E0E;&#x57FA;&#x4E8E;CASE&#x7684;&#x7248;&#x672C;&#x76F8;&#x6BD4;&#xFF0C;&#x5B83;&#x53EA;&#x9002;&#x7528;&#x4E8E;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">expression</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="kn">import</span> <span class="n">compiles</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="kn">import</span> <span class="n">Numeric</span>

<span class="k">class</span> <span class="nc">greatest</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">FunctionElement</span><span class="p">):</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Numeric</span><span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&apos;greatest&apos;</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">greatest</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">default_greatest</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">visit_function</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">greatest</span><span class="p">,</span> <span class="s1">&apos;sqlite&apos;</span><span class="p">)</span>
<span class="nd">@compiles</span><span class="p">(</span><span class="n">greatest</span><span class="p">,</span> <span class="s1">&apos;mssql&apos;</span><span class="p">)</span>
<span class="nd">@compiles</span><span class="p">(</span><span class="n">greatest</span><span class="p">,</span> <span class="s1">&apos;oracle&apos;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">case_greatest</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">clauses</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;CASE WHEN </span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%s</span><span class="s2"> THEN </span><span class="si">%s</span><span class="s2"> ELSE </span><span class="si">%s</span><span class="s2"> END&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">arg1</span><span class="p">),</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">arg2</span><span class="p">),</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">arg1</span><span class="p">),</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">arg2</span><span class="p">),</span>
    <span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-121">&#x7528;&#x6CD5;&#x793A;&#x4F8B;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Account</span><span class="p">)</span><span class="o">.</span>\
        <span class="nb">filter</span><span class="p">(</span>
            <span class="n">greatest</span><span class="p">(</span>
                <span class="n">Account</span><span class="o">.</span><span class="n">checking_balance</span><span class="p">,</span>
                <span class="n">Account</span><span class="o">.</span><span class="n">savings_balance</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000</span>
        <span class="p">)</span></pre></div></div></div><div class="section" id="false-expression"><h3><span class="yiyi-st" id="yiyi-122">&#x201C;false&#x201D;&#x8868;&#x8FBE;&#x5F0F;<a class="headerlink" href="#false-expression" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-123">&#x5448;&#x73B0;&#x201C;false&#x201D;&#x5E38;&#x91CF;&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x5728;&#x6CA1;&#x6709;&#x201C;false&#x201D;&#x5E38;&#x91CF;&#x7684;&#x5E73;&#x53F0;&#x4E0A;&#x5448;&#x73B0;&#x4E3A;&#x201C;0&#x201D;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">expression</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="kn">import</span> <span class="n">compiles</span>

<span class="k">class</span> <span class="nc">sql_false</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">ColumnElement</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">sql_false</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">default_false</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;false&quot;</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">sql_false</span><span class="p">,</span> <span class="s1">&apos;mssql&apos;</span><span class="p">)</span>
<span class="nd">@compiles</span><span class="p">(</span><span class="n">sql_false</span><span class="p">,</span> <span class="s1">&apos;mysql&apos;</span><span class="p">)</span>
<span class="nd">@compiles</span><span class="p">(</span><span class="n">sql_false</span><span class="p">,</span> <span class="s1">&apos;oracle&apos;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">int_false</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;0&quot;</span></pre></div></div><p><span class="yiyi-st" id="yiyi-124">&#x7528;&#x6CD5;&#x793A;&#x4F8B;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">union_all</span>

<span class="n">exp</span> <span class="o">=</span> <span class="n">union_all</span><span class="p">(</span>
    <span class="n">select</span><span class="p">([</span><span class="n">users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sql_false</span><span class="p">()</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;enrolled&quot;</span><span class="p">)]),</span>
    <span class="n">select</span><span class="p">([</span><span class="n">customers</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">customers</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">enrolled</span><span class="p">])</span>
<span class="p">)</span></pre></div></div><dl class="function"><dt id="sqlalchemy.ext.compiler.compiles"><span class="yiyi-st" id="yiyi-125"> <code class="descclassname">sqlalchemy.ext.compiler.</code><code class="descname">compiles</code><span class="sig-paren">(</span><em>class_</em>, <em>*specs</em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.ext.compiler.compiles" title="Permalink to this definition">&#xB6;</a></span></dt><dd><p><span class="yiyi-st" id="yiyi-126">&#x4E3A;&#x7ED9;&#x5B9A;&#x7684;<a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ClauseElement" title="sqlalchemy.sql.expression.ClauseElement"><code class="xref py py-class docutils literal"><span class="pre">ClauseElement</span></code></a>&#x7C7B;&#x578B;&#x6CE8;&#x518C;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x4F5C;&#x4E3A;&#x7F16;&#x8BD1;&#x5668;&#x3002;</span></p></dd></dl><dl class="function"><dt id="sqlalchemy.ext.compiler.deregister"><span class="yiyi-st" id="yiyi-127"><code class="descclassname"> sqlalchemy.ext.compiler&#x3002; T0&gt; <code class="descname">&#x6CE8;&#x9500; T1&gt; <span class="sig-paren">&#xFF08; T2&gt; <em>&#x7C7B;_  T3&gt; <span class="sig-paren">&#xFF09; T4&gt; <a class="headerlink" href="#sqlalchemy.ext.compiler.deregister" title="Permalink to this definition">&#xB6;&lt; / T5&gt;</a></span></em></span></code></code></span></dt><dd><p><span class="yiyi-st" id="yiyi-128">&#x5220;&#x9664;&#x4E0E;&#x7ED9;&#x5B9A;<a class="reference internal" href="sqlelement.html#sqlalchemy.sql.expression.ClauseElement" title="sqlalchemy.sql.expression.ClauseElement"><code class="xref py py-class docutils literal"><span class="pre">ClauseElement</span></code></a>&#x7C7B;&#x578B;&#x5173;&#x8054;&#x7684;&#x6240;&#x6709;&#x81EA;&#x5B9A;&#x4E49;&#x7F16;&#x8BD1;&#x5668;&#x3002;</span></p></dd></dl></div></div>