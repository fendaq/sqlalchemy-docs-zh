<h1><span class="yiyi-st" id="yiyi-44">&#x8FDE;&#x63A5;/&#x5F15;&#x64CE;<a class="headerlink" href="#connections-engines" title="Permalink to this headline">&#xB6;</a></span></h1><div class="contents faq local topic" id="contents"><ul class="simple"><li><span class="yiyi-st" id="yiyi-45"><a class="reference internal" href="#how-do-i-configure-logging" id="id1">&#x5982;&#x4F55;&#x914D;&#x7F6E;&#x65E5;&#x5FD7;&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-46"><a class="reference internal" href="#how-do-i-pool-database-connections-are-my-connections-pooled" id="id2">&#x6211;&#x5982;&#x4F55;&#x6C47;&#x96C6;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#xFF1F;&#x6211;&#x7684;&#x8FDE;&#x63A5;&#x662F;&#x5426;&#x5408;&#x5E76;&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-47"><a class="reference internal" href="#how-do-i-pass-custom-connect-arguments-to-my-database-api" id="id3">&#x5982;&#x4F55;&#x5C06;&#x81EA;&#x5B9A;&#x4E49;&#x8FDE;&#x63A5;&#x53C2;&#x6570;&#x4F20;&#x9012;&#x7ED9;&#x6211;&#x7684;&#x6570;&#x636E;&#x5E93;API&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-48"><a class="reference internal" href="#mysql-server-has-gone-away" id="id4">&#x201C;MySQL&#x670D;&#x52A1;&#x5668;&#x5DF2;&#x7ECF;&#x6D88;&#x5931;&#x201D;</a></span></li><li><span class="yiyi-st" id="yiyi-51"><a class="reference internal" href="#why-does-sqlalchemy-issue-so-many-rollbacks" id="id5">Why does SQLAlchemy issue so many ROLLBACKs?</a></span><ul><li><span class="yiyi-st" id="yiyi-49"><a class="reference internal" href="#i-m-on-myisam-how-do-i-turn-it-off" id="id6">I&#x2019;m on MyISAM - how do I turn it off?</a></span></li><li><span class="yiyi-st" id="yiyi-50"><a class="reference internal" href="#i-m-on-sql-server-how-do-i-turn-those-rollbacks-into-commits" id="id7">&#x6211;&#x5728;SQL Server&#x4E0A; - &#x5982;&#x4F55;&#x5C06;&#x8FD9;&#x4E9B;ROLLBACKs&#x8F6C;&#x6362;&#x4E3A;COMMIT&#xFF1F;</a></span></li></ul></li><li><span class="yiyi-st" id="yiyi-52"><a class="reference internal" href="#i-am-using-multiple-connections-with-a-sqlite-database-typically-to-test-transaction-operation-and-my-test-program-is-not-working" id="id8">&#x6211;&#x6B63;&#x5728;&#x4F7F;&#x7528;SQLite&#x6570;&#x636E;&#x5E93;&#x7684;&#x591A;&#x4E2A;&#x8FDE;&#x63A5;&#xFF08;&#x901A;&#x5E38;&#x7528;&#x4E8E;&#x6D4B;&#x8BD5;&#x4E8B;&#x52A1;&#x64CD;&#x4F5C;&#xFF09;&#xFF0C;&#x5E76;&#x4E14;&#x6211;&#x7684;&#x6D4B;&#x8BD5;&#x7A0B;&#x5E8F;&#x4E0D;&#x5DE5;&#x4F5C;&#xFF01;</a></span></li><li><span class="yiyi-st" id="yiyi-53"><a class="reference internal" href="#how-do-i-get-at-the-raw-dbapi-connection-when-using-an-engine" id="id9">&#x5982;&#x4F55;&#x5728;&#x4F7F;&#x7528;&#x5F15;&#x64CE;&#x65F6;&#x83B7;&#x5F97;&#x539F;&#x59CB;DBAPI&#x8FDE;&#x63A5;&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-54"><a class="reference internal" href="#how-do-i-use-engines-connections-sessions-with-python-multiprocessing-or-os-fork" id="id10">&#x6211;&#x5982;&#x4F55;&#x5728;Python&#x591A;&#x5904;&#x7406;&#x6216;os.fork()&#x4E2D;&#x4F7F;&#x7528;&#x5F15;&#x64CE;/&#x8FDE;&#x63A5;/&#x4F1A;&#x8BDD;&#xFF1F;</a></span></li></ul></div><div class="section" id="how-do-i-configure-logging"><h2><span class="yiyi-st" id="yiyi-55">&#x6211;&#x5982;&#x4F55;&#x914D;&#x7F6E;&#x65E5;&#x5FD7;&#xFF1F;<a class="headerlink" href="#how-do-i-configure-logging" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-56">&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="core_engines.html#dbengine-logging"><span>Configuring Logging</span></a>&#x3002;</span></p></div><div class="section" id="how-do-i-pool-database-connections-are-my-connections-pooled"><h2><span class="yiyi-st" id="yiyi-57">&#x6211;&#x5982;&#x4F55;&#x6C47;&#x96C6;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#xFF1F;</span><span class="yiyi-st" id="yiyi-58">&#x6211;&#x7684;&#x8FDE;&#x63A5;&#x662F;&#x5426;&#x5408;&#x5E76;&#xFF1F;<a class="headerlink" href="#how-do-i-pool-database-connections-are-my-connections-pooled" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-59">&#x5728;&#x5927;&#x591A;&#x6570;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;SQLAlchemy&#x4F1A;&#x81EA;&#x52A8;&#x6267;&#x884C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7EA7;&#x8FDE;&#x63A5;&#x6C60;&#x3002;</span><span class="yiyi-st" id="yiyi-60">&#x9664;SQLite&#x4EE5;&#x5916;&#xFF0C;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x5BF9;&#x8C61;&#x5C06;<a class="reference internal" href="core_pooling.html#sqlalchemy.pool.QueuePool" title="sqlalchemy.pool.QueuePool"><code class="xref py py-class docutils literal"><span class="pre">QueuePool</span></code></a>&#x4F5C;&#x4E3A;&#x8FDE;&#x63A5;&#x7684;&#x6765;&#x6E90;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-61">&#x6709;&#x5173;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="core_engines.html"><span>Engine Configuration</span></a>&#x548C;<a class="reference internal" href="core_pooling.html"><span>Connection Pooling</span></a>&#x3002;</span></p></div><div class="section" id="how-do-i-pass-custom-connect-arguments-to-my-database-api"><h2><span class="yiyi-st" id="yiyi-62">&#x5982;&#x4F55;&#x5C06;&#x81EA;&#x5B9A;&#x4E49;&#x8FDE;&#x63A5;&#x53C2;&#x6570;&#x4F20;&#x9012;&#x7ED9;&#x6211;&#x7684;&#x6570;&#x636E;&#x5E93;API&#xFF1F;<a class="headerlink" href="#how-do-i-pass-custom-connect-arguments-to-my-database-api" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-63"><a class="reference internal" href="core_engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal"><span class="pre">create_engine()</span></code></a>&#x8C03;&#x7528;&#x76F4;&#x63A5;&#x901A;&#x8FC7;<code class="docutils literal"><span class="pre">connect_args</span></code>&#x5173;&#x952E;&#x5B57;&#x53C2;&#x6570;&#x63A5;&#x53D7;&#x9644;&#x52A0;&#x53C2;&#x6570;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;mysql://scott:tiger@localhost/test&quot;</span><span class="p">,</span>
                    <span class="n">connect_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;utf8&quot;</span><span class="p">})</span></pre></div></div><p><span class="yiyi-st" id="yiyi-64">&#x6216;&#x8005;&#x5BF9;&#x4E8E;&#x57FA;&#x672C;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x548C;&#x6574;&#x6570;&#x53C2;&#x6570;&#xFF0C;&#x901A;&#x5E38;&#x53EF;&#x4EE5;&#x5728;URL&#x7684;&#x67E5;&#x8BE2;&#x5B57;&#x7B26;&#x4E32;&#x4E2D;&#x6307;&#x5B9A;&#x5B83;&#x4EEC;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;mysql://scott:tiger@localhost/test?encoding=utf8&quot;</span><span class="p">)</span></pre></div></div><div class="admonition seealso"><p class="first admonition-title"><span class="yiyi-st" id="yiyi-65">&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x770B;</span></p><p class="last"><span class="yiyi-st" id="yiyi-66"><a class="reference internal" href="core_engines.html#custom-dbapi-args"><span>Custom DBAPI connect() arguments</span></a></span></p></div></div><div class="section" id="mysql-server-has-gone-away"><h2><span class="yiyi-st" id="yiyi-67">&#x201C;MySQL&#x670D;&#x52A1;&#x5668;&#x5DF2;&#x7ECF;&#x6D88;&#x5931;&#x201D;<a class="headerlink" href="#mysql-server-has-gone-away" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-68">&#x8FD9;&#x4E2A;&#x9519;&#x8BEF;&#x6709;&#x4E24;&#x4E2A;&#x4E3B;&#x8981;&#x539F;&#x56E0;&#xFF1A;</span></p><p><span class="yiyi-st" id="yiyi-69">1. </span><span class="yiyi-st" id="yiyi-70">MySQL&#x5BA2;&#x6237;&#x7AEF;&#x5173;&#x95ED;&#x5DF2;&#x7ECF;&#x7A7A;&#x95F2;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x7684;&#x8FDE;&#x63A5;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;&#x516B;&#x4E2A;&#x5C0F;&#x65F6;&#x3002;</span><span class="yiyi-st" id="yiyi-71">&#x8FD9;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5728;<a class="reference internal" href="dialects_mysql.html#mysql-connection-timeouts"><span>Connection Timeouts</span></a>&#x4E2D;&#x63CF;&#x8FF0;&#x7684;<a class="reference internal" href="core_engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal"><span class="pre">create_engine()</span></code></a>&#x4F7F;&#x7528;<code class="docutils literal"><span class="pre">pool_recycle</span></code>&#x8BBE;&#x7F6E;&#x6765;&#x907F;&#x514D;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-72">2. </span><span class="yiyi-st" id="yiyi-73">MySQLdb <a class="reference internal" href="glossary.html#term-dbapi"><span class="xref std std-term">DBAPI</span></a>&#x6216;&#x7C7B;&#x4F3C;&#x7684;DBAPI&#x4EE5;&#x975E;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x7684;&#x65B9;&#x5F0F;&#x4F7F;&#x7528;&#xFF0C;&#x6216;&#x4EE5;&#x5176;&#x4ED6;&#x4E0D;&#x9002;&#x5F53;&#x7684;&#x65B9;&#x5F0F;&#x4F7F;&#x7528;&#x3002;</span><span class="yiyi-st" id="yiyi-74">MySQLdb&#x8FDE;&#x63A5;&#x5BF9;&#x8C61;&#x4E0D;&#x662F;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x7684; - &#x8FD9;&#x6269;&#x5C55;&#x5230;&#x4EFB;&#x4F55;&#x94FE;&#x63A5;&#x5230;&#x5305;&#x542B;ORM <a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x7684;&#x5355;&#x4E2A;&#x8FDE;&#x63A5;&#x7684;SQLAlchemy&#x7CFB;&#x7EDF;&#x3002;</span><span class="yiyi-st" id="yiyi-75">&#x6709;&#x5173;&#x5982;&#x4F55;&#x5728;&#x591A;&#x7EBF;&#x7A0B;&#x73AF;&#x5883;&#x4E2D;&#x4F7F;&#x7528;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x7684;&#x80CC;&#x666F;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="orm_session_basics.html#session-faq-threadsafe"><span>Is the session thread-safe?</span></a>&#x3002;</span></p></div><div class="section" id="why-does-sqlalchemy-issue-so-many-rollbacks"><h2><span class="yiyi-st" id="yiyi-76">&#x4E3A;&#x4EC0;&#x4E48;SQLAlchemy&#x53D1;&#x51FA;&#x5982;&#x6B64;&#x591A;&#x7684;ROLLBACK&#xFF1F;<a class="headerlink" href="#why-does-sqlalchemy-issue-so-many-rollbacks" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-77">SQLAlchemy&#x76EE;&#x524D;&#x5047;&#x5B9A;DBAPI&#x8FDE;&#x63A5;&#x5904;&#x4E8E;&#x201C;&#x975E;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;&#x201D;&#x6A21;&#x5F0F; - &#x8FD9;&#x662F;Python&#x6570;&#x636E;&#x5E93;API&#x7684;&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5FC5;&#x987B;&#x5047;&#x5B9A;&#x4E8B;&#x52A1;&#x59CB;&#x7EC8;&#x5728;&#x8FDB;&#x884C;&#x4E2D;&#x3002;</span><span class="yiyi-st" id="yiyi-78">&#x8FDE;&#x63A5;&#x6C60;&#x5728;&#x8FD4;&#x56DE;&#x8FDE;&#x63A5;&#x65F6;&#x53D1;&#x51FA;<code class="docutils literal"><span class="pre">connection.rollback()</span></code>&#x3002;</span><span class="yiyi-st" id="yiyi-79">&#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x91CA;&#x653E;&#x8FDE;&#x63A5;&#x4E0A;&#x5269;&#x4F59;&#x7684;&#x4EFB;&#x4F55;&#x4E8B;&#x52A1;&#x8D44;&#x6E90;&#x3002;</span><span class="yiyi-st" id="yiyi-80">&#x5728;Postgresql&#x6216;MSSQL&#x8FD9;&#x6837;&#x7684;&#x8868;&#x8D44;&#x6E90;&#x88AB;&#x5927;&#x91CF;&#x9501;&#x5B9A;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#xFF0C;&#x8FD9;&#x975E;&#x5E38;&#x5173;&#x952E;&#xFF0C;&#x56E0;&#x6B64;&#x884C;&#x548C;&#x8868;&#x4E0D;&#x4F1A;&#x5728;&#x4E0D;&#x518D;&#x4F7F;&#x7528;&#x7684;&#x8FDE;&#x63A5;&#x4E2D;&#x9501;&#x5B9A;&#x3002;</span><span class="yiyi-st" id="yiyi-81">&#x5426;&#x5219;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EF;&#x80FD;&#x4F1A;&#x6302;&#x8D77;&#x3002;</span><span class="yiyi-st" id="yiyi-82">&#x7136;&#x800C;&#xFF0C;&#x8FD9;&#x4E0D;&#x4EC5;&#x4EC5;&#x9002;&#x7528;&#x4E8E;&#x9501;&#xFF0C;&#x800C;&#x4E14;&#x5BF9;&#x4EFB;&#x4F55;&#x5177;&#x6709;&#x4EFB;&#x4F55;&#x4E8B;&#x52A1;&#x9694;&#x79BB;&#x7684;&#x6570;&#x636E;&#x5E93;&#xFF08;&#x5305;&#x62EC;&#x5E26;InnoDB&#x7684;MySQL&#xFF09;&#x90FD;&#x540C;&#x6837;&#x91CD;&#x8981;&#x3002;</span><span class="yiyi-st" id="yiyi-83">&#x5982;&#x679C;&#x5728;&#x9694;&#x79BB;&#x5185;&#x5DF2;&#x7ECF;&#x5728;&#x8BE5;&#x8FDE;&#x63A5;&#x4E0A;&#x67E5;&#x8BE2;&#x4E86;&#x8BE5;&#x6570;&#x636E;&#xFF0C;&#x90A3;&#x4E48;&#x4ECD;&#x65E7;&#x5728;&#x65E7;&#x4E8B;&#x52A1;&#x4E2D;&#x7684;&#x4EFB;&#x4F55;&#x8FDE;&#x63A5;&#x90FD;&#x5C06;&#x8FD4;&#x56DE;&#x9648;&#x65E7;&#x6570;&#x636E;&#x3002;</span><span class="yiyi-st" id="yiyi-84">&#x6709;&#x5173;&#x4E3A;&#x4EC0;&#x4E48;&#x60A8;&#x53EF;&#x80FD;&#x4F1A;&#x5728;MySQL&#x4E0A;&#x770B;&#x5230;&#x8FC7;&#x65F6;&#x6570;&#x636E;&#x7684;&#x80CC;&#x666F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a class="reference external" href="http://dev.mysql.com/doc/refman/5.1/en/innodb-transaction-model.html">http://dev.mysql.com/doc/refman/5.1/en/innodb-transaction-model.html</a></span></p><div class="section" id="i-m-on-myisam-how-do-i-turn-it-off"><h3><span class="yiyi-st" id="yiyi-85">&#x6211;&#x5728;MyISAM&#x4E0A; - &#x5982;&#x4F55;&#x5173;&#x95ED;&#x5B83;&#xFF1F;<a class="headerlink" href="#i-m-on-myisam-how-do-i-turn-it-off" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-86">&#x8FDE;&#x63A5;&#x6C60;&#x7684;&#x8FDE;&#x63A5;&#x8FD4;&#x56DE;&#x884C;&#x4E3A;&#x7684;&#x884C;&#x4E3A;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code class="docutils literal"><span class="pre">reset_on_return</span></code>&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.pool</span> <span class="kn">import</span> <span class="n">QueuePool</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&apos;mysql://scott:tiger@localhost/myisam_database&apos;</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="n">QueuePool</span><span class="p">(</span><span class="n">reset_on_return</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span></pre></div></div></div><div class="section" id="i-m-on-sql-server-how-do-i-turn-those-rollbacks-into-commits"><h3><span class="yiyi-st" id="yiyi-87">&#x6211;&#x5728;SQL Server&#x4E0A; - &#x5982;&#x4F55;&#x5C06;&#x8FD9;&#x4E9B;ROLLBACKs&#x8F6C;&#x6362;&#x4E3A;COMMIT&#xFF1F;<a class="headerlink" href="#i-m-on-sql-server-how-do-i-turn-those-rollbacks-into-commits" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-88">&#x9664;&#x4E86;<code class="docutils literal"><span class="pre">True</span></code>&#xFF0C;<code class="docutils literal"><span class="pre">False</span></code>&#x4EE5;&#x5916;&#xFF0C;<code class="docutils literal"><span class="pre">reset_on_return</span></code>&#x8FD8;&#x63A5;&#x53D7;<code class="docutils literal"><span class="pre">commit</span></code>&#xFF0C;<code class="docutils literal"><span class="pre">rollback</span></code> <code class="docutils literal"><span class="pre">None</span></code></span><span class="yiyi-st" id="yiyi-89">&#x8BBE;&#x7F6E;&#x4E3A;<code class="docutils literal"><span class="pre">commit</span></code>&#x4F1A;&#x5BFC;&#x81F4;COMMIT&#xFF0C;&#x56E0;&#x4E3A;&#x4EFB;&#x4F55;&#x8FDE;&#x63A5;&#x90FD;&#x4F1A;&#x8FD4;&#x56DE;&#x5230;&#x6C60;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&apos;mssql://scott:tiger@mydsn&apos;</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="n">QueuePool</span><span class="p">(</span><span class="n">reset_on_return</span><span class="o">=</span><span class="s1">&apos;commit&apos;</span><span class="p">))</span></pre></div></div></div></div><div class="section" id="i-am-using-multiple-connections-with-a-sqlite-database-typically-to-test-transaction-operation-and-my-test-program-is-not-working"><h2><span class="yiyi-st" id="yiyi-90">I am using multiple connections with a SQLite database (typically to test transaction operation), and my test program is not working!<a class="headerlink" href="#i-am-using-multiple-connections-with-a-sqlite-database-typically-to-test-transaction-operation-and-my-test-program-is-not-working" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-91">&#x5982;&#x679C;&#x4F7F;&#x7528;SQLite <code class="docutils literal"><span class="pre">:memory:</span></code>&#x6570;&#x636E;&#x5E93;&#x6216;0.7&#x7248;&#x4E4B;&#x524D;&#x7684;SQLAlchemy&#x7248;&#x672C;&#xFF0C;&#x5219;&#x9ED8;&#x8BA4;&#x8FDE;&#x63A5;&#x6C60;&#x662F;<a class="reference internal" href="core_pooling.html#sqlalchemy.pool.SingletonThreadPool" title="sqlalchemy.pool.SingletonThreadPool"><code class="xref py py-class docutils literal"><span class="pre">SingletonThreadPool</span></code></a>&#xFF0C;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x53EA;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;SQLite&#x8FDE;&#x63A5;&#x3002;</span><span class="yiyi-st" id="yiyi-92">&#x56E0;&#x6B64;&#xFF0C;&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x4E2D;&#x4F7F;&#x7528;&#x7684;&#x4E24;&#x4E2A;&#x8FDE;&#x63A5;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x76F8;&#x540C;&#x7684;SQLite&#x8FDE;&#x63A5;&#x3002;</span><span class="yiyi-st" id="yiyi-93">&#x786E;&#x4FDD;&#x4F60;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#xFF1A;memory&#xFF1A;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;<a class="reference internal" href="core_pooling.html#sqlalchemy.pool.NullPool" title="sqlalchemy.pool.NullPool"><code class="xref py py-class docutils literal"><span class="pre">NullPool</span></code></a>&#xFF0C;&#x8FD9;&#x662F;&#x5F53;&#x524D;SQLAlchemy&#x7248;&#x672C;&#x4E2D;&#x975E;&#x5185;&#x5B58;&#x6570;&#x636E;&#x5E93;&#x7684;&#x9ED8;&#x8BA4;&#x503C;&#x3002;</span></p><div class="admonition seealso"><p class="first admonition-title"><span class="yiyi-st" id="yiyi-94">&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x770B;</span></p><p class="last"><span class="yiyi-st" id="yiyi-95"><a class="reference internal" href="dialects_sqlite.html#pysqlite-threading-pooling"><span>Threading/Pooling Behavior</span></a> - info on PySQLite&#x2019;s behavior.</span></p></div></div><div class="section" id="how-do-i-get-at-the-raw-dbapi-connection-when-using-an-engine"><h2><span class="yiyi-st" id="yiyi-96">&#x5982;&#x4F55;&#x5728;&#x4F7F;&#x7528;&#x5F15;&#x64CE;&#x65F6;&#x83B7;&#x5F97;&#x539F;&#x59CB;DBAPI&#x8FDE;&#x63A5;&#xFF1F;<a class="headerlink" href="#how-do-i-get-at-the-raw-dbapi-connection-when-using-an-engine" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-97">&#x4F7F;&#x7528;&#x5E38;&#x89C4;&#x7684;SA&#x5F15;&#x64CE;&#x7EA7;&#x8FDE;&#x63A5;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a>&#x4E0A;&#x7684;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection.connection" title="sqlalchemy.engine.Connection.connection"><code class="xref py py-attr docutils literal"><span class="pre">Connection.connection</span></code></a>&#x5C5E;&#x6027;&#x83B7;&#x53D6;DBAPI&#x8FDE;&#x63A5;&#x7684;&#x6C60;&#x4EE3;&#x7406;&#x7248;&#x672C;&#xFF0C;&#x771F;&#x6B63;&#x7684;DBAPI&#x8FDE;&#x63A5;&#x53EF;&#x4EE5;&#x8C03;&#x7528;<code class="xref py py-attr docutils literal"><span class="pre">ConnectionFairy.connection</span></code>&#x5C5E;&#x6027; - &#x4F46;&#x4E0D;&#x5E94;&#x8BE5;&#x6709;&#x4EFB;&#x4F55;&#x9700;&#x8981;&#x8BBF;&#x95EE;&#x975E;&#x6C60;&#x4EE3;&#x7406;&#x7684;DBAPI&#x8FDE;&#x63A5;&#xFF0C;&#x56E0;&#x4E3A;&#x6240;&#x6709;&#x65B9;&#x6CD5;&#x90FD;&#x901A;&#x8FC7;&#x4EE5;&#x4E0B;&#x65B9;&#x5F0F;&#x4EE3;&#x7406;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>engine = create_engine(...)
conn = engine.connect()
conn.connection.&lt;do DBAPI things&gt;
cursor = conn.connection.cursor(&lt;DBAPI specific arguments..&gt;)</pre></div></div><p><span class="yiyi-st" id="yiyi-98">&#x60A8;&#x5FC5;&#x987B;&#x786E;&#x4FDD;&#x5C06;&#x8FDE;&#x63A5;&#x4E0A;&#x7684;&#x4EFB;&#x4F55;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x8BBE;&#x7F6E;&#x6216;&#x5176;&#x4ED6;&#x7279;&#x5B9A;&#x4E8E;&#x64CD;&#x4F5C;&#x7684;&#x8BBE;&#x7F6E;&#x6062;&#x590D;&#x4E3A;&#x6B63;&#x5E38;&#x72B6;&#x6001;&#xFF0C;&#x7136;&#x540E;&#x624D;&#x80FD;&#x5C06;&#x5176;&#x8FD4;&#x56DE;&#x5230;&#x6C60;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-99">&#x4F5C;&#x4E3A;&#x8FD8;&#x539F;&#x8BBE;&#x7F6E;&#x7684;&#x66FF;&#x4EE3;&#x65B9;&#x6CD5;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x5728;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a>&#x6216;&#x4EE3;&#x7406;&#x8FDE;&#x63A5;&#x4E0A;&#x8C03;&#x7528;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection.detach" title="sqlalchemy.engine.Connection.detach"><code class="xref py py-meth docutils literal"><span class="pre">Connection.detach()</span></code></a>&#x65B9;&#x6CD5;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x5C06;&#x4ECE;&#x6C60;&#x4E2D;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#x5F53;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection.close" title="sqlalchemy.engine.Connection.close"><code class="xref py py-meth docutils literal"><span class="pre">Connection.close()</span></code></a>&#x88AB;&#x8C03;&#x7528;&#x65F6;&#x5B83;&#x5C06;&#x88AB;&#x5173;&#x95ED;&#x5E76;&#x4E22;&#x5F03;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>conn = engine.connect()
conn.detach()  # detaches the DBAPI connection from the connection pool
conn.connection.&lt;go nuts&gt;
conn.close()  # connection is closed for real, the pool replaces it with a new connection</pre></div></div></div><div class="section" id="how-do-i-use-engines-connections-sessions-with-python-multiprocessing-or-os-fork"><h2><span class="yiyi-st" id="yiyi-100">&#x6211;&#x5982;&#x4F55;&#x4F7F;&#x7528;Python&#x591A;&#x5904;&#x7406;&#x5F15;&#x64CE;/&#x8FDE;&#x63A5;/&#x4F1A;&#x8BDD;&#x6216;os.fork()&#xFF1F;<a class="headerlink" href="#how-do-i-use-engines-connections-sessions-with-python-multiprocessing-or-os-fork" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-101">&#x591A;&#x4E2A;python&#x8FDB;&#x7A0B;&#x7684;&#x5173;&#x952E;&#x76EE;&#x6807;&#x662F;&#x9632;&#x6B62;&#x8DE8;&#x8FDB;&#x7A0B;&#x5171;&#x4EAB;&#x4EFB;&#x4F55;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x3002;</span><span class="yiyi-st" id="yiyi-102">&#x6839;&#x636E;&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x548C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x5177;&#x4F53;&#x60C5;&#x51B5;&#xFF0C;&#x8FD9;&#x91CC;&#x51FA;&#x73B0;&#x7684;&#x95EE;&#x9898;&#x5305;&#x62EC;&#x4ECE;&#x975E;&#x5DE5;&#x4F5C;&#x8FDE;&#x63A5;&#x5230;&#x591A;&#x4E2A;&#x8FDB;&#x7A0B;&#x5E76;&#x53D1;&#x4F7F;&#x7528;&#x7684;&#x5957;&#x63A5;&#x5B57;&#x8FDE;&#x63A5;&#xFF0C;&#x5BFC;&#x81F4;&#x65AD;&#x5F00;&#x7684;&#x6D88;&#x606F;&#x4F20;&#x9012;&#xFF08;&#x540E;&#x8005;&#x901A;&#x5E38;&#x6700;&#x5E38;&#x89C1;&#xFF09;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-103">SQLAlchemy <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x5BF9;&#x8C61;&#x5F15;&#x7528;&#x73B0;&#x6709;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x7684;&#x8FDE;&#x63A5;&#x6C60;&#x3002;</span><span class="yiyi-st" id="yiyi-104">&#x6240;&#x4EE5;&#x5F53;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x88AB;&#x590D;&#x5236;&#x5230;&#x4E00;&#x4E2A;&#x5B50;&#x8FDB;&#x7A0B;&#x65F6;&#xFF0C;&#x76EE;&#x6807;&#x662F;&#x786E;&#x4FDD;&#x6CA1;&#x6709;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x7EE7;&#x7EED;&#x3002;</span><span class="yiyi-st" id="yiyi-105">&#x6709;&#x4E09;&#x79CD;&#x901A;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</span></p><ol class="arabic"><li><p class="first"><span class="yiyi-st" id="yiyi-106">&#x4F7F;&#x7528;<a class="reference internal" href="core_pooling.html#sqlalchemy.pool.NullPool" title="sqlalchemy.pool.NullPool"><code class="xref py py-class docutils literal"><span class="pre">NullPool</span></code></a>&#x7981;&#x7528;&#x6C60;&#x3002;</span><span class="yiyi-st" id="yiyi-107">&#x8FD9;&#x662F;&#x6700;&#x7B80;&#x5355;&#x7684;&#x4E00;&#x6B21;&#x6027;&#x7CFB;&#x7EDF;&#xFF0C;&#x53EF;&#x9632;&#x6B62;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x591A;&#x6B21;&#x4F7F;&#x7528;&#x4EFB;&#x4F55;&#x8FDE;&#x63A5;&#x3002;</span></p></li><li><p class="first"><span class="yiyi-st" id="yiyi-108">&#x5728;&#x4EFB;&#x4F55;&#x7ED9;&#x5B9A;&#x7684;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x4E0A;&#x8C03;&#x7528;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine.dispose" title="sqlalchemy.engine.Engine.dispose"><code class="xref py py-meth docutils literal"><span class="pre">Engine.dispose()</span></code></a>&#xFF0C;&#x53EA;&#x8981;&#x5728;&#x65B0;&#x8FDB;&#x7A0B;&#x4E2D;&#x3002;</span><span class="yiyi-st" id="yiyi-109">&#x5728;Python&#x591A;&#x5904;&#x7406;&#x4E2D;&#xFF0C;&#x50CF;<code class="docutils literal"><span class="pre">multiprocessing.Pool</span></code>&#x8FD9;&#x6837;&#x7684;&#x6784;&#x9020;&#x5305;&#x542B;&#x4E86;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x7684;&#x5730;&#x65B9;&#x7684;&#x201C;&#x521D;&#x59CB;&#x5316;&#x5668;&#x201D;&#x94A9;&#x5B50;&#xFF1B;&#x5426;&#x5219;&#x5728;<code class="docutils literal"><span class="pre">os.fork()</span></code>&#x7684;&#x9876;&#x90E8;&#x6216;&#x8005;<code class="docutils literal"><span class="pre">Process</span></code>&#x5BF9;&#x8C61;&#x5F00;&#x59CB;&#x5B50;fork&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x5BF9;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine.dispose" title="sqlalchemy.engine.Engine.dispose"><code class="xref py py-meth docutils literal"><span class="pre">Engine.dispose()</span></code></a></span></p></li><li><p class="first"><span class="yiyi-st" id="yiyi-110">&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x5E94;&#x7528;&#x4E8E;&#x8FDE;&#x63A5;&#x6C60;&#xFF0C;&#x7528;&#x4E8E;&#x6D4B;&#x8BD5;&#x8DE8;&#x8FDB;&#x7A0B;&#x8FB9;&#x754C;&#x5171;&#x4EAB;&#x7684;&#x8FDE;&#x63A5;&#xFF0C;&#x5E76;&#x4F7F;&#x5176;&#x5931;&#x6548;&#x3002;</span><span class="yiyi-st" id="yiyi-111">&#x8FD9;&#x770B;&#x8D77;&#x6765;&#x50CF;&#x4E0B;&#x9762;&#x8FD9;&#x6837;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">exc</span>

<span class="k">def</span> <span class="nf">add_engine_pidguard</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add multiprocessing guards.</span>

<span class="sd">    Forces a connection to be reconnected if it is detected</span>
<span class="sd">    as having been shared to a sub-process.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@event.listens_for</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;connect&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">,</span> <span class="n">connection_record</span><span class="p">):</span>
        <span class="n">connection_record</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&apos;pid&apos;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

    <span class="nd">@event.listens_for</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;checkout&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">,</span> <span class="n">connection_record</span><span class="p">,</span> <span class="n">connection_proxy</span><span class="p">):</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">connection_record</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&apos;pid&apos;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pid</span><span class="p">:</span>
            <span class="c1"># substitute log.debug() or similar here as desired</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Parent process </span><span class="si">%(orig)s</span><span class="s2"> forked (</span><span class="si">%(newproc)s</span><span class="s2">) with an open &quot;</span>
                <span class="s2">&quot;database connection, &quot;</span>
                <span class="s2">&quot;which is being discarded and recreated.&quot;</span> <span class="o">%</span>
                <span class="p">{</span><span class="s2">&quot;newproc&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s2">&quot;orig&quot;</span><span class="p">:</span> <span class="n">connection_record</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&apos;pid&apos;</span><span class="p">]})</span>
            <span class="n">connection_record</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection_proxy</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">DisconnectionError</span><span class="p">(</span>
                <span class="s2">&quot;Connection record belongs to pid </span><span class="si">%s</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;attempting to check out in pid </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">connection_record</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&apos;pid&apos;</span><span class="p">],</span> <span class="n">pid</span><span class="p">)</span>
            <span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-112">&#x8FD9;&#x4E9B;&#x4E8B;&#x4EF6;&#x4E00;&#x65E6;&#x521B;&#x5EFA;&#x5C31;&#x4F1A;&#x5E94;&#x7528;&#x4E8E;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>

<span class="n">add_engine_pidguard</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span></pre></div></div></li></ol><p><span class="yiyi-st" id="yiyi-113">&#x4E0A;&#x8FF0;&#x7B56;&#x7565;&#x5C06;&#x9002;&#x5E94;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x5728;&#x8FDB;&#x7A0B;&#x4E4B;&#x95F4;&#x5171;&#x4EAB;&#x7684;&#x60C5;&#x51B5;&#x3002;</span><span class="yiyi-st" id="yiyi-114">However, for the case of a transaction-active <a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> or <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a> being shared, there&#x2019;s no automatic fix for this; an application needs to ensure a new child process only initiate new <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a> objects and transactions, as well as ORM <a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> objects. </span><span class="yiyi-st" id="yiyi-115">&#x5BF9;&#x4E8E;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x5BF9;&#x8C61;&#xFF0C;&#x4ECE;&#x6280;&#x672F;&#x4E0A;&#x8BB2;&#xFF0C;&#x53EA;&#x6709;&#x5728;&#x4F1A;&#x8BDD;&#x5F53;&#x524D;&#x662F;&#x4E8B;&#x52A1;&#x7ED1;&#x5B9A;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x624D;&#x9700;&#x8981;&#x8FD9;&#x6837;&#x505A;&#xFF0C;&#x4F46;&#x662F;&#x5355;&#x4E2A;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x7684;&#x8303;&#x56F4;&#x65E0;&#x8BBA;&#x5982;&#x4F55;&#x90FD;&#x662F;&#x8981;&#x4FDD;&#x7559;&#x5728;&#x5355;&#x4E2A;&#x8C03;&#x7528;&#x5806;&#x6808;&#xFF08;&#x4F8B;&#x5982;&#xFF0C;&#x4E0D;&#x662F;&#x5168;&#x5C40;&#x5BF9;&#x8C61;&#xFF0C;&#x4E0D;&#x5728;&#x8FDB;&#x7A0B;&#x6216;&#x7EBF;&#x7A0B;&#x4E4B;&#x95F4;&#x5171;&#x4EAB;&#xFF09;&#x3002;</span></p></div>