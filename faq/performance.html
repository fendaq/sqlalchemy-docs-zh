<h1><span class="yiyi-st" id="yiyi-41">&#x6027;&#x80FD;<a class="headerlink" href="#performance" title="Permalink to this headline">&#xB6; T0&gt;</a></span></h1><div class="contents faq local topic" id="contents"><ul class="simple"><li><span class="yiyi-st" id="yiyi-47"><a class="reference internal" href="#how-can-i-profile-a-sqlalchemy-powered-application" id="id1">&#x6211;&#x5982;&#x4F55;&#x5206;&#x6790;SQLAlchemy&#x9A71;&#x52A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF1F;</a></span><ul><li><span class="yiyi-st" id="yiyi-42"><a class="reference internal" href="#query-profiling" id="id2">&#x67E5;&#x8BE2;&#x5206;&#x6790;</a></span></li><li><span class="yiyi-st" id="yiyi-43"><a class="reference internal" href="#code-profiling" id="id3">&#x4EE3;&#x7801;&#x5206;&#x6790;</a></span></li><li><span class="yiyi-st" id="yiyi-44"><a class="reference internal" href="#execution-slowness" id="id4">&#x6267;&#x884C;&#x7F13;&#x6162;</a></span></li><li><span class="yiyi-st" id="yiyi-45"><a class="reference internal" href="#result-fetching-slowness-core" id="id5">&#x7ED3;&#x679C;&#x83B7;&#x53D6;&#x7F13;&#x6162; - &#x6838;&#x5FC3;</a></span></li><li><span class="yiyi-st" id="yiyi-46"><a class="reference internal" href="#result-fetching-slowness-orm" id="id6">&#x7ED3;&#x679C;&#x83B7;&#x53D6;&#x7F13;&#x6162; -  ORM</a></span></li></ul></li><li><span class="yiyi-st" id="yiyi-48"><a class="reference internal" href="#i-m-inserting-400-000-rows-with-the-orm-and-it-s-really-slow" id="id7">&#x6211;&#x4F7F;&#x7528;ORM&#x63D2;&#x5165;&#x4E86;400,000&#x884C;&#xFF0C;&#x5B83;&#x975E;&#x5E38;&#x6162;&#xFF01;</a></span></li></ul></div><div class="section" id="how-can-i-profile-a-sqlalchemy-powered-application"><h2><span class="yiyi-st" id="yiyi-49">&#x6211;&#x5982;&#x4F55;&#x5206;&#x6790;SQLAlchemy&#x9A71;&#x52A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF1F;<a class="headerlink" href="#how-can-i-profile-a-sqlalchemy-powered-application" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-50">&#x5BFB;&#x627E;&#x6027;&#x80FD;&#x95EE;&#x9898;&#x901A;&#x5E38;&#x6D89;&#x53CA;&#x4E24;&#x4E2A;&#x7B56;&#x7565;&#x3002;</span><span class="yiyi-st" id="yiyi-51">&#x4E00;&#x4E2A;&#x662F;&#x67E5;&#x8BE2;&#x5206;&#x6790;&#xFF0C;&#x53E6;&#x4E00;&#x4E2A;&#x662F;&#x4EE3;&#x7801;&#x5206;&#x6790;&#x3002;</span></p><div class="section" id="query-profiling"><h3><span class="yiyi-st" id="yiyi-52">&#x67E5;&#x8BE2;&#x5206;&#x6790;<a class="headerlink" href="#query-profiling" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-53">&#x6709;&#x65F6;&#xFF0C;&#x53EA;&#x9700;&#x7B80;&#x5355;&#x7684;SQL&#x65E5;&#x5FD7;&#x8BB0;&#x5F55;&#xFF08;&#x901A;&#x8FC7;python&#x7684;&#x65E5;&#x5FD7;&#x8BB0;&#x5F55;&#x6A21;&#x5757;&#x542F;&#x7528;&#xFF0C;&#x6216;&#x8005;&#x901A;&#x8FC7;<a class="reference internal" href="core_engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal"><span class="pre">create_engine()</span></code></a>&#x4E2D;&#x7684;<code class="docutils literal"><span class="pre">echo=True</span></code>&#x53C2;&#x6570;&#xFF09;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#x89E3;&#x4E8B;&#x60C5;&#x8981;&#x82B1;&#x591A;&#x957F;&#x65F6;&#x95F4;&#x3002;</span><span class="yiyi-st" id="yiyi-54">&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x5728;SQL&#x64CD;&#x4F5C;&#x4E4B;&#x540E;&#x8BB0;&#x5F55;&#x4E00;&#x4E9B;&#x4E1C;&#x897F;&#xFF0C;&#x4F60;&#x4F1A;&#x5728;&#x65E5;&#x5FD7;&#x4E2D;&#x770B;&#x5230;&#x7C7B;&#x4F3C;&#x8FD9;&#x6837;&#x7684;&#x4E1C;&#x897F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>17:37:48,325 INFO  [sqlalchemy.engine.base.Engine.0x...048c] SELECT ...
17:37:48,326 INFO  [sqlalchemy.engine.base.Engine.0x...048c] {&lt;params&gt;}
17:37:48,660 DEBUG [myapp.somemessage]</pre></div></div><p><span class="yiyi-st" id="yiyi-55">&#x5982;&#x679C;&#x60A8;&#x5728;&#x64CD;&#x4F5C;&#x4E4B;&#x540E;&#x7ACB;&#x5373;&#x8BB0;&#x5F55;&#x4E86;<code class="docutils literal"><span class="pre">myapp.somemessage</span></code>&#xFF0C;&#x5219;&#x77E5;&#x9053;&#x5B8C;&#x6210;SQL&#x90E8;&#x5206;&#x7684;&#x64CD;&#x4F5C;&#x9700;&#x8981;334ms&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-56">&#x8BB0;&#x5F55;SQL&#x8FD8;&#x4F1A;&#x8BF4;&#x660E;&#x662F;&#x5426;&#x6709;&#x6570;&#x5341;&#x4E2A;/&#x6570;&#x767E;&#x4E2A;&#x67E5;&#x8BE2;&#x6B63;&#x5728;&#x53D1;&#x5E03;&#xFF0C;&#x8FD9;&#x53EF;&#x80FD;&#x4F1A;&#x66F4;&#x597D;&#x5730;&#x7EC4;&#x7EC7;&#x6210;&#x66F4;&#x5C11;&#x7684;&#x67E5;&#x8BE2;&#x3002;</span><span class="yiyi-st" id="yiyi-57">When using the SQLAlchemy ORM, the &#x201C;eager loading&#x201D; feature is provided to partially (<a class="reference internal" href="orm_loading_relationships.html#sqlalchemy.orm.contains_eager" title="sqlalchemy.orm.contains_eager"><code class="xref py py-func docutils literal"><span class="pre">contains_eager()</span></code></a>) or fully (<a class="reference internal" href="orm_loading_relationships.html#sqlalchemy.orm.joinedload" title="sqlalchemy.orm.joinedload"><code class="xref py py-func docutils literal"><span class="pre">joinedload()</span></code></a>, <a class="reference internal" href="orm_loading_relationships.html#sqlalchemy.orm.subqueryload" title="sqlalchemy.orm.subqueryload"><code class="xref py py-func docutils literal"><span class="pre">subqueryload()</span></code></a>) automate this activity, but without the ORM &#x201C;eager loading&#x201D; typically means to use joins so that results across multiple tables can be loaded in one result set instead of multiplying numbers of queries as more depth is added (i.e. <code class="docutils literal"><span class="pre">r</span> <span class="pre">+</span> <span class="pre">r*r2</span> <span class="pre">+</span> <span class="pre">r*r2*r3</span></code> ...)</span></p><p><span class="yiyi-st" id="yiyi-58">&#x8981;&#x8FDB;&#x884C;&#x66F4;&#x957F;&#x671F;&#x7684;&#x67E5;&#x8BE2;&#x5206;&#x6790;&#x6216;&#x5B9E;&#x73B0;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7AEF;&#x201C;&#x6162;&#x901F;&#x67E5;&#x8BE2;&#x201D;&#x76D1;&#x89C6;&#x5668;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x914D;&#x65B9;&#x6765;&#x4F7F;&#x7528;&#x4E8B;&#x4EF6;&#x6765;&#x62E6;&#x622A;&#x6E38;&#x6807;&#x6267;&#x884C;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="kn">import</span> <span class="n">Engine</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;myapp.sqltime&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="nd">@event.listens_for</span><span class="p">(</span><span class="n">Engine</span><span class="p">,</span> <span class="s2">&quot;before_cursor_execute&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">before_cursor_execute</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span>
                        <span class="n">parameters</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">executemany</span><span class="p">):</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&apos;query_start_time&apos;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Start Query: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>

<span class="nd">@event.listens_for</span><span class="p">(</span><span class="n">Engine</span><span class="p">,</span> <span class="s2">&quot;after_cursor_execute&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">after_cursor_execute</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span>
                        <span class="n">parameters</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">executemany</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">conn</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&apos;query_start_time&apos;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Query Complete!&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Total Time: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-59">&#x4EE5;&#x4E0A;&#xFF0C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;<a class="reference internal" href="core_events.html#sqlalchemy.events.ConnectionEvents.before_cursor_execute" title="sqlalchemy.events.ConnectionEvents.before_cursor_execute"><code class="xref py py-meth docutils literal"><span class="pre">ConnectionEvents.before_cursor_execute()</span></code></a>&#x548C;<a class="reference internal" href="core_events.html#sqlalchemy.events.ConnectionEvents.after_cursor_execute" title="sqlalchemy.events.ConnectionEvents.after_cursor_execute"><code class="xref py py-meth docutils literal"><span class="pre">ConnectionEvents.after_cursor_execute()</span></code></a>&#x4E8B;&#x4EF6;&#x6765;&#x5EFA;&#x7ACB;&#x6267;&#x884C;&#x8BED;&#x53E5;&#x65F6;&#x7684;&#x62E6;&#x622A;&#x70B9;&#x3002;</span><span class="yiyi-st" id="yiyi-60">&#x6211;&#x4EEC;&#x4F7F;&#x7528;<code class="xref py py-class docutils literal"><span class="pre">_ConnectionRecord.info</span></code>&#x5B57;&#x5178;&#x5C06;&#x4E00;&#x4E2A;&#x8BA1;&#x65F6;&#x5668;&#x9644;&#x52A0;&#x5230;&#x8FDE;&#x63A5;&#x4E0A;&#xFF1B;&#x6211;&#x4EEC;&#x5728;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x5806;&#x6808;&#x6765;&#x5904;&#x7406;&#x6E38;&#x6807;&#x6267;&#x884C;&#x4E8B;&#x4EF6;&#x53EF;&#x80FD;&#x88AB;&#x5D4C;&#x5957;&#x7684;&#x5076;&#x7136;&#x60C5;&#x51B5;&#x3002;</span></p></div><div class="section" id="code-profiling"><h3><span class="yiyi-st" id="yiyi-61">&#x4EE3;&#x7801;&#x5206;&#x6790;<a class="headerlink" href="#code-profiling" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-62">&#x5982;&#x679C;&#x65E5;&#x5FD7;&#x8BB0;&#x5F55;&#x663E;&#x793A;&#x5355;&#x4E2A;&#x67E5;&#x8BE2;&#x82B1;&#x8D39;&#x7684;&#x65F6;&#x95F4;&#x592A;&#x957F;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x8BE6;&#x7EC6;&#x5206;&#x6790;&#x5904;&#x7406;&#x67E5;&#x8BE2;&#x7684;&#x6570;&#x636E;&#x5E93;&#x82B1;&#x4E86;&#x591A;&#x5C11;&#x65F6;&#x95F4;&#xFF0C;&#x901A;&#x8FC7;&#x7F51;&#x7EDC;&#x53D1;&#x9001;&#x7ED3;&#x679C;&#xFF0C;&#x7531;<a class="reference internal" href="glossary.html#term-dbapi"><span class="xref std std-term">DBAPI</span></a>&#x5904;&#x7406;&#xFF0C;&#x4EE5;&#x53CA;&#x6700;&#x540E;&#x88AB;SQLAlchemy&#x7684;&#x7ED3;&#x679C;&#x96C6;&#x548C;/&#x6216;ORM&#x5C42;&#x63A5;&#x6536;&#x3002;</span><span class="yiyi-st" id="yiyi-63">&#x6839;&#x636E;&#x5177;&#x4F53;&#x60C5;&#x51B5;&#xFF0C;&#x8FD9;&#x4E9B;&#x9636;&#x6BB5;&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x90FD;&#x53EF;&#x80FD;&#x4F1A;&#x51FA;&#x73B0;&#x5404;&#x81EA;&#x7684;&#x74F6;&#x9888;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-64">&#x4E3A;&#x6B64;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x4F7F;&#x7528;<a class="reference external" href="https://docs.python.org/2/library/profile.html">Python&#x5206;&#x6790;&#x6A21;&#x5757;</a>&#x3002;</span><span class="yiyi-st" id="yiyi-65">&#x4E0B;&#x9762;&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x914D;&#x65B9;&#xFF0C;&#x7528;&#x4E8E;&#x5206;&#x6790;&#x4E0A;&#x4E0B;&#x6587;&#x7BA1;&#x7406;&#x5668;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cProfile</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">pstats</span>
<span class="kn">import</span> <span class="nn">contextlib</span>

<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">profiled</span><span class="p">():</span>
    <span class="n">pr</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
    <span class="n">pr</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">pr</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s1">&apos;cumulative&apos;</span><span class="p">)</span>
    <span class="n">ps</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
    <span class="c1"># uncomment this to see who&apos;s calling what</span>
    <span class="c1"># ps.print_callers()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span></pre></div></div><p><span class="yiyi-st" id="yiyi-66">&#x8981;&#x5256;&#x6790;&#x4E00;&#x6BB5;&#x4EE3;&#x7801;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">profiled</span><span class="p">():</span>
    <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">FooClass</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">FooClass</span><span class="o">.</span><span class="n">somevalue</span><span class="o">==</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div></div><p><span class="yiyi-st" id="yiyi-67">&#x5206;&#x6790;&#x7684;&#x8F93;&#x51FA;&#x7ED3;&#x679C;&#x53EF;&#x7528;&#x4E8E;&#x4E86;&#x89E3;&#x82B1;&#x8D39;&#x65F6;&#x95F4;&#x7684;&#x60F3;&#x6CD5;&#x3002;</span><span class="yiyi-st" id="yiyi-68">&#x5256;&#x6790;&#x8F93;&#x51FA;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>13726 function calls (13042 primitive calls) in 0.014 seconds

Ordered by: cumulative time

ncalls  tottime  percall  cumtime  percall filename:lineno(function)
222/21    0.001    0.000    0.011    0.001 lib/sqlalchemy/orm_loading.py:26(instances)
220/20    0.002    0.000    0.010    0.001 lib/sqlalchemy/orm_loading.py:327(_instance)
220/20    0.000    0.000    0.010    0.000 lib/sqlalchemy/orm_loading.py:284(populate_state)
   20    0.000    0.000    0.010    0.000 lib/sqlalchemy/orm_strategies.py:987(load_collection_from_subq)
   20    0.000    0.000    0.009    0.000 lib/sqlalchemy/orm_strategies.py:935(get)
    1    0.000    0.000    0.009    0.009 lib/sqlalchemy/orm_strategies.py:940(_load)
   21    0.000    0.000    0.008    0.000 lib/sqlalchemy/orm_strategies.py:942(&lt;genexpr&gt;)
    2    0.000    0.000    0.004    0.002 lib/sqlalchemy/orm_query.py:2400(__iter__)
    2    0.000    0.000    0.002    0.001 lib/sqlalchemy/orm_query.py:2414(_execute_and_instances)
    2    0.000    0.000    0.002    0.001 lib/sqlalchemy/engine/base.py:659(execute)
    2    0.000    0.000    0.002    0.001 lib/sqlalchemy/sql/elements.py:321(_execute_on_connection)
    2    0.000    0.000    0.002    0.001 lib/sqlalchemy/engine/base.py:788(_execute_clauseelement)

...</pre></div></div><p><span class="yiyi-st" id="yiyi-69">&#x5728;&#x4E0A;&#x9762;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;<code class="docutils literal"><span class="pre">instances()</span></code> SQLAlchemy&#x51FD;&#x6570;&#x88AB;&#x8C03;&#x7528;&#x4E86;222&#x6B21;&#xFF08;&#x9012;&#x5F52;&#x7684;&#xFF0C;&#x4ECE;&#x5916;&#x90E8;&#x7684;21&#x6B21;&#xFF09;&#xFF0C;&#x603B;&#x5171;&#x8C03;&#x7528;&#x4E86;&#x603B;&#x5171;0.011&#x79D2;&#x3002;</span></p></div><div class="section" id="execution-slowness"><h3><span class="yiyi-st" id="yiyi-70">&#x6267;&#x884C;&#x7F13;&#x6162;<a class="headerlink" href="#execution-slowness" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-71">&#x8FD9;&#x4E9B;&#x7535;&#x8BDD;&#x7684;&#x5177;&#x4F53;&#x7EC6;&#x8282;&#x53EF;&#x4EE5;&#x544A;&#x8BC9;&#x6211;&#x4EEC;&#x65F6;&#x95F4;&#x82B1;&#x5728;&#x54EA;&#x91CC;&#x3002;</span><span class="yiyi-st" id="yiyi-72">&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x770B;&#x5230;&#x65F6;&#x95F4;&#x5728;<code class="docutils literal"><span class="pre">cursor.execute()</span></code>&#x4E4B;&#x5185;&#xFF0C;&#x4F8B;&#x5982;&#x9488;&#x5BF9;DBAPI&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>2    0.102    0.102    0.204    0.102 {method &apos;execute&apos; of &apos;sqlite3.Cursor&apos; objects}</pre></div></div><p><span class="yiyi-st" id="yiyi-73">&#x8FD9;&#x5C06;&#x8868;&#x660E;&#x6570;&#x636E;&#x5E93;&#x9700;&#x8981;&#x5F88;&#x957F;&#x65F6;&#x95F4;&#x624D;&#x80FD;&#x5F00;&#x59CB;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x60A8;&#x7684;&#x67E5;&#x8BE2;&#x5E94;&#x8BE5;&#x8FDB;&#x884C;&#x4F18;&#x5316;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6DFB;&#x52A0;&#x7D22;&#x5F15;&#x6216;&#x91CD;&#x65B0;&#x6784;&#x5EFA;&#x67E5;&#x8BE2;&#x548C;/&#x6216;&#x57FA;&#x7840;&#x6A21;&#x5F0F;&#x6765;&#x5B9E;&#x73B0;&#x3002;</span><span class="yiyi-st" id="yiyi-74">&#x5BF9;&#x4E8E;&#x8BE5;&#x4EFB;&#x52A1;&#xFF0C;&#x4F7F;&#x7528;&#x8BF8;&#x5982;EXPLAIN&#xFF0C;SHOW PLAN&#x7B49;&#x7684;&#x7CFB;&#x7EDF;&#x6765;&#x5206;&#x6790;&#x67E5;&#x8BE2;&#x8BA1;&#x5212;&#x662F;&#x6709;&#x4FDD;&#x8BC1;&#x7684;&#x3002;</span><span class="yiyi-st" id="yiyi-75">&#x5982;&#x7531;&#x6570;&#x636E;&#x5E93;&#x540E;&#x7AEF;&#x63D0;&#x4F9B;&#x7684;&#x90A3;&#x6837;&#x3002;</span></p></div><div class="section" id="result-fetching-slowness-core"><h3><span class="yiyi-st" id="yiyi-76">&#x7ED3;&#x679C;&#x83B7;&#x53D6;&#x7F13;&#x6162; - &#x6838;&#x5FC3;<a class="headerlink" href="#result-fetching-slowness-core" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-77">&#x53E6;&#x4E00;&#x65B9;&#x9762;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x770B;&#x5230;&#x6D89;&#x53CA;&#x5230;&#x83B7;&#x53D6;&#x884C;&#x7684;&#x6570;&#x5343;&#x6B21;&#x8C03;&#x7528;&#x6216;&#x5BF9;<code class="docutils literal"><span class="pre">fetchall()</span></code>&#x7684;&#x975E;&#x5E38;&#x957F;&#x7684;&#x8C03;&#x7528;&#xFF0C;&#x8FD9;&#x53EF;&#x80FD;&#x610F;&#x5473;&#x7740;&#x60A8;&#x7684;&#x67E5;&#x8BE2;&#x6B63;&#x5728;&#x8FD4;&#x56DE;&#x6BD4;&#x9884;&#x671F;&#x66F4;&#x591A;&#x7684;&#x884C;&#xFF0C;&#x6216;&#x8005;&#x63D0;&#x53D6;&#x884C;&#x672C;&#x8EAB;&#x5F88;&#x6162;&#x3002;</span><span class="yiyi-st" id="yiyi-78">The ORM itself typically uses <code class="docutils literal"><span class="pre">fetchall()</span></code> to fetch rows (or <code class="docutils literal"><span class="pre">fetchmany()</span></code> if the <a class="reference internal" href="orm_query.html#sqlalchemy.orm.query.Query.yield_per" title="sqlalchemy.orm.query.Query.yield_per"><code class="xref py py-meth docutils literal"><span class="pre">Query.yield_per()</span></code></a> option is used).</span></p><p><span class="yiyi-st" id="yiyi-79">&#x5728;DBAPI&#x7EA7;&#x522B;&#xFF0C;&#x901A;&#x8FC7;&#x5BF9;<code class="docutils literal"><span class="pre">fetchall()</span></code>&#x8FDB;&#x884C;&#x975E;&#x5E38;&#x7F13;&#x6162;&#x7684;&#x8C03;&#x7528;&#x53EF;&#x4EE5;&#x6307;&#x793A;&#x8FC7;&#x591A;&#x7684;&#x884C;&#x6570;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>2    0.300    0.600    0.300    0.600 {method &apos;fetchall&apos; of &apos;sqlite3.Cursor&apos; objects}</pre></div></div><p><span class="yiyi-st" id="yiyi-80">&#x5373;&#x4F7F;&#x6700;&#x7EC8;&#x7ED3;&#x679C;&#x4F3C;&#x4E4E;&#x6CA1;&#x6709;&#x591A;&#x884C;&#xFF0C;&#x610F;&#x5916;&#x7684;&#x5927;&#x91CF;&#x884C;&#x4E5F;&#x53EF;&#x80FD;&#x662F;&#x7B1B;&#x5361;&#x5C14;&#x79EF;&#x7684;&#x7ED3;&#x679C; - &#x5F53;&#x591A;&#x7EC4;&#x884C;&#x5408;&#x5E76;&#x5728;&#x4E00;&#x8D77;&#x800C;&#x6CA1;&#x6709;&#x9002;&#x5F53;&#x5730;&#x5C06;&#x8868;&#x8FDE;&#x63A5;&#x5728;&#x4E00;&#x8D77;&#x65F6;&#x3002;</span><span class="yiyi-st" id="yiyi-81">&#x5982;&#x679C;&#x5728;&#x590D;&#x6742;&#x7684;&#x67E5;&#x8BE2;&#x4E2D;&#x4F7F;&#x7528;&#x4E86;&#x9519;&#x8BEF;&#x7684;<a class="reference internal" href="core_metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal"><span class="pre">Column</span></code></a>&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x5F15;&#x5165;&#x5176;&#x4ED6;&#x610F;&#x5916;&#x7684;FROM&#x5B50;&#x53E5;&#xFF0C;&#x90A3;&#x4E48;&#x4F7F;&#x7528;SQLAlchemy Core&#x6216;ORM&#x67E5;&#x8BE2;&#x751F;&#x6210;&#x6B64;&#x884C;&#x4E3A;&#x901A;&#x5E38;&#x5F88;&#x5BB9;&#x6613;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-82">&#x53E6;&#x4E00;&#x65B9;&#x9762;&#xFF0C;&#x5728;DBAPI&#x7EA7;&#x522B;&#x5BF9;<code class="docutils literal"><span class="pre">fetchall()</span></code>&#x6267;&#x884C;&#x5FEB;&#x901F;&#x8C03;&#x7528;&#xFF0C;&#x4F46;&#x662F;&#x5F53;SQLAlchemy&#x7684;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.ResultProxy" title="sqlalchemy.engine.ResultProxy"><code class="xref py py-class docutils literal"><span class="pre">ResultProxy</span></code></a>&#x88AB;&#x8981;&#x6C42;&#x6267;&#x884C;<code class="docutils literal"><span class="pre">fetchall()</span></code></span></p><div class="highlight-python"><div class="highlight"><pre><span></span># the DBAPI cursor is fast...
2    0.020    0.040    0.020    0.040 {method &apos;fetchall&apos; of &apos;sqlite3.Cursor&apos; objects}

...

# but SQLAlchemy&apos;s result proxy is slow, this is type-level processing
2    0.100    0.200    0.100    0.200 lib/sqlalchemy/engine/result.py:778(fetchall)</pre></div></div><p><span class="yiyi-st" id="yiyi-83">&#x5728;&#x67D0;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x540E;&#x7AEF;&#x53EF;&#x80FD;&#x6B63;&#x5728;&#x8FDB;&#x884C;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x7C7B;&#x578B;&#x7EA7;&#x5904;&#x7406;&#x3002;</span><span class="yiyi-st" id="yiyi-84">&#x66F4;&#x5177;&#x4F53;&#x5730;&#x8BF4;&#xFF0C;&#x5728;&#x7C7B;&#x578B;API&#x4E2D;&#x67E5;&#x770B;&#x7F13;&#x6162;&#x7684;&#x8C03;&#x7528;&#x662F;&#x66F4;&#x597D;&#x7684;&#x6307;&#x6807; - &#x4E0B;&#x9762;&#x662F;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x7C7B;&#x4F3C;&#x8FD9;&#x6837;&#x7684;&#x7C7B;&#x578B;&#x65F6;&#x7684;&#x6837;&#x5B50;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">TypeDecorator</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">String</span>

    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="c1"># intentionally add slowness for illustration purposes</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mo">001</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></pre></div></div><p><span class="yiyi-st" id="yiyi-85">&#x8FD9;&#x79CD;&#x6545;&#x610F;&#x7F13;&#x6162;&#x64CD;&#x4F5C;&#x7684;&#x5206;&#x6790;&#x8F93;&#x51FA;&#x53EF;&#x4EE5;&#x770B;&#x4F5C;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>200    0.001    0.000    0.237    0.001 lib/sqlalchemy/sql/type_api.py:911(process)
200    0.001    0.000    0.236    0.001 test.py:28(process_result_value)
200    0.235    0.001    0.235    0.001 {time.sleep}</pre></div></div><p><span class="yiyi-st" id="yiyi-86">&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x6211;&#x4EEC;&#x5728;<code class="docutils literal"><span class="pre">type_api</span></code>&#x7CFB;&#x7EDF;&#x4E2D;&#x770B;&#x5230;&#x8BB8;&#x591A;&#x6602;&#x8D35;&#x7684;&#x8C03;&#x7528;&#xFF0C;&#x5B9E;&#x9645;&#x8017;&#x65F6;&#x7684;&#x4E8B;&#x60C5;&#x662F;<code class="docutils literal"><span class="pre">time.sleep()</span></code>&#x8C03;&#x7528;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-87">&#x8BF7;&#x52A1;&#x5FC5;&#x68C0;&#x67E5;<code class="xref doc docutils literal"><span class="pre">Dialect</span> <span class="pre">&#x6587;&#x6863;</span></code>&#xFF0C;&#x4EE5;&#x83B7;&#x53D6;&#x6709;&#x5173;&#x6B64;&#x7EA7;&#x522B;&#x5DF2;&#x77E5;&#x6027;&#x80FD;&#x8C03;&#x6574;&#x5EFA;&#x8BAE;&#x7684;&#x8BF4;&#x660E;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x5BF9;&#x4E8E;&#x50CF;Oracle&#x8FD9;&#x6837;&#x7684;&#x6570;&#x636E;&#x5E93;&#x3002;</span><span class="yiyi-st" id="yiyi-88">&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x4E0E;&#x786E;&#x4FDD;&#x6570;&#x5B57;&#x51C6;&#x786E;&#x6027;&#x6216;&#x5B57;&#x7B26;&#x4E32;&#x5904;&#x7406;&#x76F8;&#x5173;&#x7684;&#x7CFB;&#x7EDF;&#xFF0C;&#x8FD9;&#x4E9B;&#x7CFB;&#x7EDF;&#x5728;&#x6240;&#x6709;&#x60C5;&#x51B5;&#x4E0B;&#x53EF;&#x80FD;&#x90FD;&#x4E0D;&#x9700;&#x8981;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-89">&#x6392;&#x961F;&#x6027;&#x80FD;&#x53D7;&#x5230;&#x5F71;&#x54CD;&#x7684;&#x53EF;&#x80FD;&#x8FD8;&#x6709;&#x66F4;&#x591A;&#x7684;&#x4F4E;&#x7EA7;&#x522B;&#x70B9;&#xFF0C;&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x82B1;&#x8D39;&#x7684;&#x65F6;&#x95F4;&#x4F3C;&#x4E4E;&#x96C6;&#x4E2D;&#x5728;&#x50CF;<code class="docutils literal"><span class="pre">socket.receive()</span></code>&#x8FD9;&#x6837;&#x7684;&#x8C03;&#x7528;&#x4E0A;&#xFF0C;&#x8FD9;&#x53EF;&#x80FD;&#x8868;&#x660E;&#x9664;&#x4E86;&#x5B9E;&#x9645;&#x7684;&#x7F51;&#x7EDC;&#x8FDE;&#x63A5;&#xFF0C;&#x6240;&#x6709;&#x4E8B;&#x60C5;&#x90FD;&#x5F88;&#x5FEB;&#xFF0C;&#x5E76;&#x4E14;&#x6570;&#x636E;&#x79FB;&#x52A8;&#x82B1;&#x8D39;&#x7684;&#x65F6;&#x95F4;&#x592A;&#x591A;&#x7F51;&#x7EDC;&#x3002;</span></p></div><div class="section" id="result-fetching-slowness-orm"><h3><span class="yiyi-st" id="yiyi-90">&#x7ED3;&#x679C;&#x83B7;&#x53D6;&#x7F13;&#x6162; -  ORM <a class="headerlink" href="#result-fetching-slowness-orm" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-91">&#x4E3A;&#x4E86;&#x68C0;&#x6D4B;&#x884C;&#x7684;ORM&#x8BFB;&#x53D6;&#x7F13;&#x6162;&#xFF08;&#x8FD9;&#x662F;&#x6027;&#x80FD;&#x5173;&#x6CE8;&#x7684;&#x6700;&#x5E38;&#x89C1;&#x533A;&#x57DF;&#xFF09;&#xFF0C;&#x8BF8;&#x5982;<code class="docutils literal"><span class="pre">populate_state()</span></code>&#x548C;<code class="docutils literal"><span class="pre">_instance()</span></code>&#x7684;&#x8C03;&#x7528;&#x5C06;&#x8BF4;&#x660E;&#x5355;&#x4E2A;ORM&#x5BF9;&#x8C61;&#x7FA4;&#x4F53;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span># the ORM calls _instance for each ORM-loaded row it sees, and
# populate_state for each ORM-loaded row that results in the population
# of an object&apos;s attributes
220/20    0.001    0.000    0.010    0.000 lib/sqlalchemy/orm_loading.py:327(_instance)
220/20    0.000    0.000    0.009    0.000 lib/sqlalchemy/orm_loading.py:284(populate_state)</pre></div></div><p><span class="yiyi-st" id="yiyi-92">ORM&#x5C06;&#x884C;&#x8F6C;&#x6362;&#x4E3A;ORM&#x6620;&#x5C04;&#x5BF9;&#x8C61;&#x7684;&#x901F;&#x5EA6;&#x6162;&#x662F;&#x8BE5;&#x64CD;&#x4F5C;&#x590D;&#x6742;&#x6027;&#x4E0E;cPython&#x5F00;&#x9500;&#x76F8;&#x7ED3;&#x5408;&#x7684;&#x4EA7;&#x7269;&#x3002;</span><span class="yiyi-st" id="yiyi-93">&#x51CF;&#x8F7B;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x7684;&#x5171;&#x540C;&#x7B56;&#x7565;&#x5305;&#x62EC;&#xFF1A;</span></p><ul><li><p class="first"><span class="yiyi-st" id="yiyi-94">&#x83B7;&#x53D6;&#x5355;&#x4E2A;&#x5217;&#x800C;&#x4E0D;&#x662F;&#x5B8C;&#x6574;&#x5B9E;&#x4F53;&#xFF0C;&#x5373;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-95">&#x4EE3;&#x66FF;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span></pre></div></div></li><li><p class="first"><span class="yiyi-st" id="yiyi-96">&#x4F7F;&#x7528;<a class="reference internal" href="orm_query.html#sqlalchemy.orm.query.Bundle" title="sqlalchemy.orm.query.Bundle"><code class="xref py py-class docutils literal"><span class="pre">Bundle</span></code></a>&#x5BF9;&#x8C61;&#x6765;&#x7EC4;&#x7EC7;&#x57FA;&#x4E8E;&#x5217;&#x7684;&#x7ED3;&#x679C;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>u_b = Bundle(&apos;user&apos;, User.id, User.name)
a_b = Bundle(&apos;address&apos;, Address.id, Address.email)

for user, address in session.query(u_b, a_b).join(User.addresses):
    # ...</pre></div></div></li><li><p class="first"><span class="yiyi-st" id="yiyi-97">&#x4F7F;&#x7528;&#x7ED3;&#x679C;&#x7F13;&#x5B58; - &#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="orm_examples.html#examples-caching"><span>Dogpile Caching</span></a>&#x4EE5;&#x83B7;&#x5F97;&#x6DF1;&#x5165;&#x7684;&#x793A;&#x4F8B;&#x3002;</span></p></li><li><p class="first"><span class="yiyi-st" id="yiyi-98">&#x8003;&#x8651;&#x4E00;&#x4E0B;&#x50CF;Pypy&#x90A3;&#x6837;&#x66F4;&#x5FEB;&#x7684;&#x7FFB;&#x8BD1;&#x3002;</span></p></li></ul><p><span class="yiyi-st" id="yiyi-99">&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x8F93;&#x51FA;&#x53EF;&#x80FD;&#x6709;&#x70B9;&#x4EE4;&#x4EBA;&#x751F;&#x754F;&#xFF0C;&#x4F46;&#x7ECF;&#x8FC7;&#x4E00;&#x4E9B;&#x7EC3;&#x4E60;&#x540E;&#xFF0C;&#x5B83;&#x4EEC;&#x5F88;&#x5BB9;&#x6613;&#x9605;&#x8BFB;&#x3002;</span></p><div class="admonition seealso"><p class="first admonition-title"><span class="yiyi-st" id="yiyi-100">&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x770B;</span></p><p class="last"><span class="yiyi-st" id="yiyi-101"><a class="reference internal" href="orm_examples.html#examples-performance"><span>Performance</span></a> - a suite of performance demonstrations with bundled profiling capabilities.</span></p></div></div></div><div class="section" id="i-m-inserting-400-000-rows-with-the-orm-and-it-s-really-slow"><h2><span class="yiyi-st" id="yiyi-102">&#x6211;&#x4F7F;&#x7528;ORM&#x63D2;&#x5165;&#x4E86;400,000&#x884C;&#xFF0C;&#x5B83;&#x975E;&#x5E38;&#x6162;&#xFF01;<a class="headerlink" href="#i-m-inserting-400-000-rows-with-the-orm-and-it-s-really-slow" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-103">&#x5728;&#x540C;&#x6B65;&#x5BF9;&#x6570;&#x636E;&#x5E93;&#x7684;&#x66F4;&#x6539;&#x65F6;&#xFF0C;SQLAlchemy ORM&#x4F7F;&#x7528;<a class="reference internal" href="glossary.html#term-unit-of-work"><span class="xref std std-term">unit of work</span></a>&#x6A21;&#x5F0F;&#x3002;</span><span class="yiyi-st" id="yiyi-104">&#x8FD9;&#x79CD;&#x6A21;&#x5F0F;&#x8FDC;&#x8FDC;&#x8D85;&#x51FA;&#x4E86;&#x7B80;&#x5355;&#x7684;&#x201C;&#x63D2;&#x5165;&#x201D;&#x6570;&#x636E;&#x3002;</span><span class="yiyi-st" id="yiyi-105">&#x5B83;&#x5305;&#x62EC;&#x4F7F;&#x7528;&#x5C5E;&#x6027;&#x68C0;&#x6D4B;&#x7CFB;&#x7EDF;&#x63A5;&#x6536;&#x5728;&#x5BF9;&#x8C61;&#x4E0A;&#x5206;&#x914D;&#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x8BE5;&#x5C5E;&#x6027;&#x68C0;&#x6D4B;&#x7CFB;&#x7EDF;&#x5728;&#x5BF9;&#x8C61;&#x521B;&#x5EFA;&#x65F6;&#x8DDF;&#x8E2A;&#x5BF9;&#x8C61;&#x4E0A;&#x7684;&#x66F4;&#x6539;&#xFF0C;&#x5305;&#x62EC;&#x63D2;&#x5165;&#x7684;&#x6240;&#x6709;&#x884C;&#x90FD;&#x5728;&#x6807;&#x8BC6;&#x6620;&#x5C04;&#x4E2D;&#x8FDB;&#x884C;&#x8DDF;&#x8E2A;&#xFF0C;&#x8FD9;&#x5BF9;&#x4E8E;&#x6BCF;&#x884C;SQLAlchemy&#x90FD;&#x5FC5;&#x987B;&#x68C0;&#x7D22;&#x5176;&#x201C;&#x6700;&#x540E;&#x63D2;&#x5165;&#x7684;ID&#x201C;&#xFF08;&#x5982;&#x679C;&#x8FD8;&#x6CA1;&#x6709;&#x7ED9;&#x51FA;&#xFF09;&#xFF0C;&#x5E76;&#x4E14;&#x8FD8;&#x6D89;&#x53CA;&#x8981;&#x63D2;&#x5165;&#x7684;&#x884C;&#x5C06;&#x88AB;&#x626B;&#x63CF;&#x5E76;&#x6839;&#x636E;&#x9700;&#x8981;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x4EE5;&#x83B7;&#x5F97;&#x76F8;&#x5173;&#x6027;&#x3002;</span><span class="yiyi-st" id="yiyi-106">&#x5BF9;&#x8C61;&#x8FD8;&#x9700;&#x8981;&#x6709;&#x76F8;&#x5F53;&#x7A0B;&#x5EA6;&#x7684;&#x7C3F;&#x8BB0;&#x624D;&#x80FD;&#x4FDD;&#x6301;&#x6240;&#x6709;&#x8FD9;&#x4E9B;&#x8FD0;&#x884C;&#xFF0C;&#x5BF9;&#x4E8E;&#x5927;&#x91CF;&#x7684;&#x884C;&#x6765;&#x8BF4;&#xFF0C;&#x4E00;&#x6B21;&#x53EF;&#x4EE5;&#x5728;&#x5927;&#x578B;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E0A;&#x82B1;&#x8D39;&#x8FC7;&#x591A;&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x56E0;&#x6B64;&#x6700;&#x597D;&#x5C06;&#x5B83;&#x4EEC;&#x5206;&#x5757;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-107">&#x57FA;&#x672C;&#x4E0A;&#xFF0C;&#x5DE5;&#x4F5C;&#x5355;&#x5143;&#x5177;&#x6709;&#x5F88;&#x5927;&#x7684;&#x81EA;&#x52A8;&#x5316;&#x7A0B;&#x5EA6;&#xFF0C;&#x53EF;&#x4EE5;&#x81EA;&#x52A8;&#x6267;&#x884C;&#x5C06;&#x590D;&#x6742;&#x5BF9;&#x8C61;&#x56FE;&#x6301;&#x4E45;&#x5316;&#x5230;&#x6CA1;&#x6709;&#x660E;&#x786E;&#x6301;&#x4E45;&#x6027;&#x4EE3;&#x7801;&#x7684;&#x5173;&#x7CFB;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x4EFB;&#x52A1;&#xFF0C;&#x800C;&#x4E14;&#x8FD9;&#x79CD;&#x81EA;&#x52A8;&#x5316;&#x5177;&#x6709;&#x4EE3;&#x4EF7;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-108">ORM&#x57FA;&#x672C;&#x4E0A;&#x4E0D;&#x9002;&#x7528;&#x4E8E;&#x9AD8;&#x6027;&#x80FD;&#x6279;&#x91CF;&#x63D2;&#x5165; - &#x8FD9;&#x662F;SQLAlchemy&#x9664;&#x4E86;&#x5C06;ORM&#x4F5C;&#x4E3A;&#x7B2C;&#x4E00;&#x7EA7;&#x7EC4;&#x4EF6;&#x63D0;&#x4F9B;Core&#x4E4B;&#x5916;&#x7684;&#x5168;&#x90E8;&#x539F;&#x56E0;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-109">&#x5BF9;&#x4E8E;&#x5FEB;&#x901F;&#x6279;&#x91CF;&#x63D2;&#x5165;&#x7684;&#x7528;&#x4F8B;&#xFF0C;ORM&#x6784;&#x5EFA;&#x5728;&#x5176;&#x4E0A;&#x7684;SQL&#x751F;&#x6210;&#x548C;&#x6267;&#x884C;&#x7CFB;&#x7EDF;&#x662F;<code class="xref doc docutils literal"><span class="pre">Core</span></code>&#x7684;&#x4E00;&#x90E8;&#x5206;&#x3002;</span><span class="yiyi-st" id="yiyi-110">&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x6B64;&#x7CFB;&#x7EDF;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x4E0E;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x539F;&#x59CB;&#x6570;&#x636E;&#x5E93;API&#x76F8;&#x7ADE;&#x4E89;&#x7684;INSERT&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-111">&#x6216;&#x8005;&#xFF0C;SQLAlchemy ORM&#x63D0;&#x4F9B;&#x4E86;<a class="reference internal" href="orm_persistence_techniques.html#bulk-operations"><span>Bulk Operations</span></a>&#x65B9;&#x6CD5;&#x5957;&#x4EF6;&#xFF0C;&#x8FD9;&#x4E9B;&#x65B9;&#x6CD5;&#x63D0;&#x4F9B;&#x4E86;&#x5DE5;&#x4F5C;&#x5355;&#x5143;&#x8FC7;&#x7A0B;&#x7684;&#x5B50;&#x90E8;&#x5206;&#x7684;&#x6302;&#x94A9;&#xFF0C;&#x4EE5;&#x4FBF;&#x53D1;&#x5E03;&#x5177;&#x6709;&#x5C0F;&#x7A0B;&#x5EA6;&#x7684;&#x57FA;&#x4E8E;ORM&#x7684;&#x6838;&#x5FC3;&#x7EA7;INSERT&#x548C;UPDATE&#x7ED3;&#x6784;&#x81EA;&#x52A8;&#x5316;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-112">&#x4E0B;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x8BF4;&#x660E;&#x4E86;&#x63D2;&#x5165;&#x884C;&#x7684;&#x51E0;&#x79CD;&#x4E0D;&#x540C;&#x65B9;&#x6CD5;&#x7684;&#x57FA;&#x4E8E;&#x65F6;&#x95F4;&#x7684;&#x6D4B;&#x8BD5;&#xFF0C;&#x4ECE;&#x6700;&#x81EA;&#x52A8;&#x5316;&#x5230;&#x6700;&#x5C0F;&#x5316;&#x3002;</span><span class="yiyi-st" id="yiyi-113">&#x4F7F;&#x7528;cPython 2.7&#xFF0C;&#x8FD0;&#x884C;&#x65F6;&#x89C2;&#x5BDF;&#x5230;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>classics-MacBook-Pro:sqlalchemy classic$ python test.py
SQLAlchemy ORM: Total time for 100000 records 12.0471920967 secs
SQLAlchemy ORM pk given: Total time for 100000 records 7.06283402443 secs
SQLAlchemy ORM bulk_save_objects(): Total time for 100000 records 0.856323003769 secs
SQLAlchemy Core: Total time for 100000 records 0.485800027847 secs
sqlite3: Total time for 100000 records 0.487842082977 sec</pre></div></div><p><span class="yiyi-st" id="yiyi-114">&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<a class="reference external" href="http://pypy.org/">Pypy</a>&#x7684;&#x6700;&#x65B0;&#x7248;&#x672C;&#x5C06;&#x65F6;&#x95F4;&#x7F29;&#x77ED;&#x4E09;&#x5206;&#x4E4B;&#x4E00;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>classics-MacBook-Pro:sqlalchemy classic$ /usr/local/src/pypy-2.1-beta2-osx64/bin/pypy test.py
SQLAlchemy ORM: Total time for 100000 records 5.88369488716 secs
SQLAlchemy ORM pk given: Total time for 100000 records 3.52294301987 secs
SQLAlchemy Core: Total time for 100000 records 0.613556146622 secs
sqlite3: Total time for 100000 records 0.442467927933 sec</pre></div></div><p><span class="yiyi-st" id="yiyi-115">&#x811A;&#x672C;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span>  <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">scoped_session</span><span class="p">,</span> <span class="n">sessionmaker</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
<span class="n">DBSession</span> <span class="o">=</span> <span class="n">scoped_session</span><span class="p">(</span><span class="n">sessionmaker</span><span class="p">())</span>
<span class="n">engine</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">Customer</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;customer&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">init_sqlalchemy</span><span class="p">(</span><span class="n">dbname</span><span class="o">=</span><span class="s1">&apos;sqlite:///sqlalchemy.db&apos;</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">engine</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">DBSession</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="n">DBSession</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">autoflush</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">expire_on_commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_sqlalchemy_orm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="n">init_sqlalchemy</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="p">()</span>
        <span class="n">customer</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&apos;NAME &apos;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">DBSession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">DBSession</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">DBSession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span>
        <span class="s2">&quot;SQLAlchemy ORM: Total time for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot; records &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; secs&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_sqlalchemy_orm_pk_given</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="n">init_sqlalchemy</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;NAME &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">DBSession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">DBSession</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">DBSession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span>
        <span class="s2">&quot;SQLAlchemy ORM pk given: Total time for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot; records &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; secs&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_sqlalchemy_orm_bulk_insert</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="n">init_sqlalchemy</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">n</span>
    <span class="k">while</span> <span class="n">n1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">n1</span> <span class="o">-</span> <span class="mi">10000</span>
        <span class="n">DBSession</span><span class="o">.</span><span class="n">bulk_insert_mappings</span><span class="p">(</span>
            <span class="n">Customer</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;NAME &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">n1</span><span class="p">))</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="n">DBSession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span>
        <span class="s2">&quot;SQLAlchemy ORM bulk_save_objects(): Total time for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot; records &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; secs&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_sqlalchemy_core</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="n">init_sqlalchemy</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">Customer</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span>
        <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s1">&apos;NAME &apos;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="k">print</span><span class="p">(</span>
        <span class="s2">&quot;SQLAlchemy Core: Total time for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot; records &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; secs&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">init_sqlite3</span><span class="p">(</span><span class="n">dbname</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS customer&quot;</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;CREATE TABLE customer (id INTEGER NOT NULL, &quot;</span>
        <span class="s2">&quot;name VARCHAR(255), PRIMARY KEY(id))&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">conn</span>


<span class="k">def</span> <span class="nf">test_sqlite3</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="s1">&apos;sqlite3.db&apos;</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">init_sqlite3</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&apos;NAME &apos;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO customer (name) VALUES (?)&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span>
        <span class="s2">&quot;sqlite3: Total time for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot; records &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; sec&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&apos;__main__&apos;</span><span class="p">:</span>
    <span class="n">test_sqlalchemy_orm</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
    <span class="n">test_sqlalchemy_orm_pk_given</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
    <span class="n">test_sqlalchemy_orm_bulk_insert</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
    <span class="n">test_sqlalchemy_core</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
    <span class="n">test_sqlite3</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span></pre></div></div></div>