<h1><span class="yiyi-st" id="yiyi-49">&#x4F1A;&#x8BDD;/&#x67E5;&#x8BE2;<a class="headerlink" href="#sessions-queries" title="Permalink to this headline">&#xB6;</a></span></h1><div class="contents faq local topic" id="contents"><ul class="simple"><li><span class="yiyi-st" id="yiyi-50"><a class="reference internal" href="#i-m-re-loading-data-with-my-session-but-it-isn-t-seeing-changes-that-i-committed-elsewhere" id="id1">&#x6211;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x6211;&#x7684;&#x4F1A;&#x8BDD;&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x6570;&#x636E;&#xFF0C;&#x4F46;&#x6CA1;&#x6709;&#x770B;&#x5230;&#x6211;&#x5728;&#x522B;&#x5904;&#x63D0;&#x4EA4;&#x7684;&#x66F4;&#x6539;</a></span></li><li><span class="yiyi-st" id="yiyi-53"><a class="reference internal" href="#this-session-s-transaction-has-been-rolled-back-due-to-a-previous-exception-during-flush-or-similar" id="id2">&#x201C;&#x6B64;&#x4F1A;&#x8BDD;&#x7684;&#x4E8B;&#x52A1;&#x7531;&#x4E8E;&#x5237;&#x65B0;&#x671F;&#x95F4;&#x7684;&#x5148;&#x524D;&#x5F02;&#x5E38;&#x800C;&#x56DE;&#x6EDA;&#x3002;&#x201D;&#xFF08;&#x6216;&#x7C7B;&#x4F3C;&#x7684;&#xFF09;</a></span><ul><li><span class="yiyi-st" id="yiyi-51"><a class="reference internal" href="#but-why-does-flush-insist-on-issuing-a-rollback" id="id3">&#x4F46;&#x4E3A;&#x4EC0;&#x4E48;flush()&#x575A;&#x6301;&#x53D1;&#x5E03;ROLLBACK&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-52"><a class="reference internal" href="#but-why-isn-t-the-one-automatic-call-to-rollback-enough-why-must-i-rollback-again" id="id4">&#x4F46;&#x4E3A;&#x4EC0;&#x4E48;&#x81EA;&#x52A8;&#x8C03;&#x7528;ROLLBACK&#x4E0D;&#x591F;&#xFF1F;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x5FC5;&#x987B;&#x518D;&#x6B21;ROLLBACK&#xFF1F;</a></span></li></ul></li><li><span class="yiyi-st" id="yiyi-54"><a class="reference internal" href="#how-do-i-make-a-query-that-always-adds-a-certain-filter-to-every-query" id="id5">&#x6211;&#x5982;&#x4F55;&#x8FDB;&#x884C;&#x67E5;&#x8BE2;&#xFF0C;&#x4EE5;&#x4FBF;&#x6BCF;&#x6B21;&#x67E5;&#x8BE2;&#x90FD;&#x6DFB;&#x52A0;&#x7279;&#x5B9A;&#x7684;&#x8FC7;&#x6EE4;&#x5668;&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-55"><a class="reference internal" href="#i-ve-created-a-mapping-against-an-outer-join-and-while-the-query-returns-rows-no-objects-are-returned-why-not" id="id6">&#x6211;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x9488;&#x5BF9;&#x5916;&#x90E8;&#x8054;&#x63A5;&#x7684;&#x6620;&#x5C04;&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x67E5;&#x8BE2;&#x8FD4;&#x56DE;&#x884C;&#x65F6;&#xFF0C;&#x4E0D;&#x8FD4;&#x56DE;&#x5BF9;&#x8C61;&#x3002;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x5462;&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-56"><a class="reference internal" href="#i-m-using-joinedload-or-lazy-false-to-create-a-join-outer-join-and-sqlalchemy-is-not-constructing-the-correct-query-when-i-try-to-add-a-where-order-by-limit-etc-which-relies-upon-the-outer-join" id="id7">&#x6211;&#x4F7F;&#x7528;<code class="docutils literal"><span class="pre">joinedload()</span></code>&#x6216;<code class="docutils literal"><span class="pre">lazy=False</span></code>&#x521B;&#x5EFA;JOIN / OUTER JOIN&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x5C1D;&#x8BD5;&#x6DFB;&#x52A0;WHERE&#x65F6;SQLAlchemy&#x672A;&#x6784;&#x9020;&#x6B63;&#x786E;&#x7684;&#x67E5;&#x8BE2;&#xFF0C;ORDER BY&#xFF0C;LIMIT&#x7B49;&#xFF08;&#x4F9D;&#x8D56;&#x4E8E;&#xFF08;OUTER&#xFF09;JOIN&#xFF09;</a></span></li><li><span class="yiyi-st" id="yiyi-57"><a class="reference internal" href="#query-has-no-len-why-not" id="id8">&#x67E5;&#x8BE2;&#x6CA1;&#x6709;<code class="docutils literal"><span class="pre">__len__()</span></code>&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x80FD;&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-58"><a class="reference internal" href="#how-do-i-use-textual-sql-with-orm-queries" id="id9">&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x5E26;&#x6709;ORM&#x67E5;&#x8BE2;&#x7684;&#x6587;&#x672C;SQL&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-59"><a class="reference internal" href="#i-m-calling-session-delete-myobject-and-it-isn-t-removed-from-the-parent-collection" id="id10">&#x6211;&#x5728;&#x8C03;&#x7528;<code class="docutils literal"><span class="pre">Session.delete(myobject)</span></code>&#xFF0C;&#x5E76;&#x4E14;&#x5B83;&#x4E0D;&#x4F1A;&#x4ECE;&#x7236;&#x96C6;&#x5408;&#x4E2D;&#x79FB;&#x9664;&#xFF01;</a></span></li><li><span class="yiyi-st" id="yiyi-60"><a class="reference internal" href="#why-isn-t-my-init-called-when-i-load-objects" id="id11">&#x5F53;&#x6211;&#x52A0;&#x8F7D;&#x5BF9;&#x8C61;&#x65F6;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x8C03;&#x7528;<code class="docutils literal"><span class="pre">__init__()</span></code>&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-61"><a class="reference internal" href="#how-do-i-use-on-delete-cascade-with-sa-s-orm" id="id12">&#x5982;&#x4F55;&#x5728;SA&#x7684;ORM&#x4E2D;&#x4F7F;&#x7528;ON DELETE CASCADE&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-62"><a class="reference internal" href="#i-set-the-foo-id-attribute-on-my-instance-to-7-but-the-foo-attribute-is-still-none-shouldn-t-it-have-loaded-foo-with-id-7" id="id13">&#x6211;&#x5C06;&#x5B9E;&#x4F8B;&#x4E2D;&#x7684;&#x201C;foo_id&#x201D;&#x5C5E;&#x6027;&#x8BBE;&#x7F6E;&#x4E3A;&#x201C;7&#x201D;&#xFF0C;&#x4F46;&#x201C;foo&#x201D;&#x5C5E;&#x6027;&#x4ECD;&#x7136;&#x662F;<code class="docutils literal"><span class="pre">None</span></code>  - &#x4E0D;&#x5E94;&#x8BE5;&#x4F7F;&#x7528;id&#xFF03;7&#x52A0;&#x8F7D;Foo&#x5417;&#xFF1F; t0 &gt;</a></span></li><li><span class="yiyi-st" id="yiyi-63"><a class="reference internal" href="#how-do-i-walk-all-objects-that-are-related-to-a-given-object" id="id14">&#x6211;&#x5982;&#x4F55;&#x8D70;&#x8DEF;&#x4E0E;&#x7ED9;&#x5B9A;&#x5BF9;&#x8C61;&#x76F8;&#x5173;&#x7684;&#x6240;&#x6709;&#x5BF9;&#x8C61;&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-64"><a class="reference internal" href="#is-there-a-way-to-automagically-have-only-unique-keywords-or-other-kinds-of-objects-without-doing-a-query-for-the-keyword-and-getting-a-reference-to-the-row-containing-that-keyword" id="id15">&#x6709;&#x6CA1;&#x6709;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x5728;&#x4E0D;&#x67E5;&#x8BE2;&#x5173;&#x952E;&#x5B57;&#x5E76;&#x83B7;&#x53D6;&#x5305;&#x542B;&#x8BE5;&#x5173;&#x952E;&#x5B57;&#x7684;&#x884C;&#x7684;&#x5F15;&#x7528;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x4EC5;&#x81EA;&#x52A8;&#x83B7;&#x53D6;&#x552F;&#x4E00;&#x5173;&#x952E;&#x5B57;&#xFF08;&#x6216;&#x5176;&#x4ED6;&#x7C7B;&#x578B;&#x7684;&#x5BF9;&#x8C61;&#xFF09;&#xFF1F;</a></span></li></ul></div><div class="section" id="i-m-re-loading-data-with-my-session-but-it-isn-t-seeing-changes-that-i-committed-elsewhere"><h2><span class="yiyi-st" id="yiyi-65">&#x6211;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x4F1A;&#x8BDD;&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x6570;&#x636E;&#xFF0C;&#x4F46;&#x6CA1;&#x6709;&#x770B;&#x5230;&#x6211;&#x5728;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x63D0;&#x4EA4;&#x7684;&#x66F4;&#x6539;<a class="headerlink" href="#i-m-re-loading-data-with-my-session-but-it-isn-t-seeing-changes-that-i-committed-elsewhere" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-66">&#x5173;&#x4E8E;&#x8FD9;&#x79CD;&#x884C;&#x4E3A;&#x7684;&#x4E3B;&#x8981;&#x95EE;&#x9898;&#x662F;&#xFF0C;&#x5373;&#x4F7F;&#x4E8B;&#x52A1;&#x5904;&#x4E8E;<em>&#x53EF;&#x5E8F;&#x5217;&#x5316;</em>&#x9694;&#x79BB;&#x72B6;&#x6001;&#xFF0C;&#x5373;&#x4F7F;&#x4E8B;&#x52A1;&#x4E0D;&#x662F;&#xFF08;&#x901A;&#x5E38;&#x4E0D;&#x662F;&#xFF09;&#xFF0C;&#x8BE5;&#x4E8B;&#x52A1;&#x4E5F;&#x4F1A;&#x50CF;&#x4E8B;&#x52A1;&#x4E00;&#x6837;&#x8FDB;&#x884C;&#x3002;</span><span class="yiyi-st" id="yiyi-67">&#x5B9E;&#x9645;&#x4E0A;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x4F1A;&#x8BDD;&#x4E0D;&#x4F1A;&#x66F4;&#x6539;&#x5DF2;&#x5728;&#x4E8B;&#x52A1;&#x8303;&#x56F4;&#x5185;&#x8BFB;&#x53D6;&#x7684;&#x4EFB;&#x4F55;&#x6570;&#x636E;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-68">&#x5982;&#x679C;&#x672F;&#x8BED;&#x201C;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x201D;&#x4E0D;&#x719F;&#x6089;&#xFF0C;&#x90A3;&#x4E48;&#x60A8;&#x9996;&#x5148;&#x9700;&#x8981;&#x9605;&#x8BFB;&#x4EE5;&#x4E0B;&#x94FE;&#x63A5;&#xFF1A;</span></p><p><span class="yiyi-st" id="yiyi-69"><a class="reference external" href="https://en.wikipedia.org/wiki/Isolation_%28database_systems%29">&#x9694;&#x79BB;&#x7EA7;&#x522B;</a></span></p><p><span class="yiyi-st" id="yiyi-70">&#x7B80;&#x800C;&#x8A00;&#x4E4B;&#xFF0C;&#x53EF;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x901A;&#x5E38;&#x610F;&#x5473;&#x7740;&#xFF0C;&#x4E00;&#x65E6;&#x5728;&#x4E8B;&#x52A1;&#x4E2D;&#x9009;&#x62E9;&#x4E86;&#x4E00;&#x7CFB;&#x5217;&#x884C;&#xFF0C;&#x6BCF;&#x6B21;&#x91CD;&#x65B0;&#x53D1;&#x51FA;&#x8BE5;SELECT&#x65F6;&#x90FD;&#x4F1A;&#x5F97;&#x5230;<em>&#x76F8;&#x540C;&#x7684;&#x6570;&#x636E;</em>&#x3002;</span><span class="yiyi-st" id="yiyi-71">&#x5982;&#x679C;&#x60A8;&#x5904;&#x4E8E;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x8F83;&#x4F4E;&#x7684;&#x201C;&#x53EF;&#x91CD;&#x590D;&#x8BFB;&#x53D6;&#x201D;&#x7EA7;&#x522B;&#xFF0C;&#x5219;&#x4F1A;&#x770B;&#x5230;&#x65B0;&#x6DFB;&#x52A0;&#x7684;&#x884C;&#xFF08;&#x4E0D;&#x518D;&#x770B;&#x5230;&#x5DF2;&#x5220;&#x9664;&#x7684;&#x884C;&#xFF09;&#xFF0C;&#x4F46;&#x5BF9;&#x4E8E;&#x5DF2;&#x52A0;&#x8F7D;<em></em>&#x7684;&#x884C;&#xFF0C;&#x60A8;&#x5C06;&#x4E0D;&#x4F1A;&#x770B;&#x5230;&#x4EFB;&#x4F55;&#x53D8;&#x5316;&#x3002;</span><span class="yiyi-st" id="yiyi-72">&#x53EA;&#x6709;&#x5728;&#x8F83;&#x4F4E;&#x7684;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x65F6;&#xFF0C;&#x4F8B;&#x5982;&#x201C;&#x8BFB;&#x53D6;&#x63D0;&#x4EA4;&#x201D;&#xFF0C;&#x662F;&#x5426;&#x6709;&#x53EF;&#x80FD;&#x770B;&#x5230;&#x4E00;&#x884C;&#x6570;&#x636E;&#x6539;&#x53D8;&#x5176;&#x4EF7;&#x503C;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-73">&#x6709;&#x5173;&#x4F7F;&#x7528;SQLAlchemy ORM&#x65F6;&#x63A7;&#x5236;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="orm_session_transaction.html#session-transaction-isolation"><span>Setting Transaction Isolation Levels</span></a>&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-74">&#x4E3A;&#x4E86;&#x5927;&#x5927;&#x7B80;&#x5316;&#x4E8B;&#x60C5;&#xFF0C;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x672C;&#x8EAB;&#x6309;&#x7167;&#x5B8C;&#x5168;&#x72EC;&#x7ACB;&#x7684;&#x4E8B;&#x52A1;&#x5DE5;&#x4F5C;&#xFF0C;&#x5E76;&#x4E14;&#x4E0D;&#x4F1A;&#x8986;&#x76D6;&#x5DF2;&#x7ECF;&#x8BFB;&#x53D6;&#x7684;&#x4EFB;&#x4F55;&#x6620;&#x5C04;&#x5C5E;&#x6027;&#xFF0C;&#x9664;&#x975E;&#x60A8;&#x544A;&#x8BC9;&#x5B83;&#x3002;</span><span class="yiyi-st" id="yiyi-75">&#x5C1D;&#x8BD5;&#x91CD;&#x65B0;&#x8BFB;&#x53D6;&#x6B63;&#x5728;&#x8FDB;&#x884C;&#x7684;&#x4E8B;&#x52A1;&#x4E2D;&#x52A0;&#x8F7D;&#x7684;&#x6570;&#x636E;&#x7684;&#x7528;&#x4F8B;&#x662F;&#x4E00;&#x79CD;<em>&#x7F55;&#x89C1;</em>&#x7528;&#x4F8B;&#xFF0C;&#x5728;&#x5F88;&#x591A;&#x60C5;&#x51B5;&#x4E0B;&#x8FD9;&#x79CD;&#x7528;&#x4F8B;&#x4E0D;&#x8D77;&#x4F5C;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x88AB;&#x8BA4;&#x4E3A;&#x662F;&#x4F8B;&#x5916;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x89C4;&#x8303;&#xFF1B;&#x4E3A;&#x4E86;&#x5728;&#x8FD9;&#x4E2A;&#x5F02;&#x5E38;&#x4E2D;&#x5DE5;&#x4F5C;&#xFF0C;&#x63D0;&#x4F9B;&#x4E86;&#x51E0;&#x79CD;&#x65B9;&#x6CD5;&#x6765;&#x5141;&#x8BB8;&#x5728;&#x6B63;&#x5728;&#x8FDB;&#x884C;&#x7684;&#x4E8B;&#x52A1;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x7279;&#x5B9A;&#x7684;&#x6570;&#x636E;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-76">&#x5F53;&#x6211;&#x4EEC;&#x8C08;&#x8BBA;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x65F6;&#xFF0C;&#x8981;&#x7406;&#x89E3;&#x201C;&#x4EA4;&#x6613;&#x201D;&#x7684;&#x542B;&#x4E49;&#xFF0C;&#x60A8;&#x7684;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x4EC5;&#x7528;&#x4E8E;&#x4EA4;&#x6613;&#x3002;</span><span class="yiyi-st" id="yiyi-77">&#x8FD9;&#x662F;&#x5BF9;<a class="reference internal" href="orm_session_transaction.html#unitofwork-transaction"><span>Managing Transactions</span></a>&#x7684;&#x6982;&#x8FF0;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-78">&#x4E00;&#x65E6;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x4E86;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#xFF0C;&#x5E76;&#x4E14;&#x6211;&#x4EEC;&#x8BA4;&#x4E3A;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x8BBE;&#x7F6E;&#x7684;&#x8DB3;&#x591F;&#x4F4E;&#xFF0C;&#x8FD9;&#x6837;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x91CD;&#x65B0;&#x9009;&#x62E9;&#x4E00;&#x884C;&#xFF0C;&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x5728;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a></span></p><p><span class="yiyi-st" id="yiyi-79">&#x4ECE;&#x6700;&#x666E;&#x901A;&#x5230;&#x6700;&#x4E0D;&#x91CD;&#x8981;&#x7684;&#x4E09;&#x79CD;&#x65B9;&#x5F0F;&#xFF1A;</span></p><ol class="arabic simple"><li><span class="yiyi-st" id="yiyi-80">We simply end our transaction and start a new one on next access with our <a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> by calling <a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.commit" title="sqlalchemy.orm.session.Session.commit"><code class="xref py py-meth docutils literal"><span class="pre">Session.commit()</span></code></a> (note that if the <a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> is in the lesser-used &#x201C;autocommit&#x201D; mode, there would be a call to <a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.begin" title="sqlalchemy.orm.session.Session.begin"><code class="xref py py-meth docutils literal"><span class="pre">Session.begin()</span></code></a> as well). </span><span class="yiyi-st" id="yiyi-81">&#x7EDD;&#x5927;&#x591A;&#x6570;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x7528;&#x4F8B;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x95EE;&#x9898;&#xFF0C;&#x65E0;&#x6CD5;&#x5728;&#x5176;&#x4ED6;&#x4E8B;&#x52A1;&#x4E2D;&#x201C;&#x770B;&#x89C1;&#x201D;&#x6570;&#x636E;&#xFF0C;&#x56E0;&#x4E3A;&#x4ED6;&#x4EEC;&#x575A;&#x6301;&#x8FD9;&#x79CD;&#x6A21;&#x5F0F;&#xFF0C;&#x8FD9;&#x662F;<strong>&#x77ED;&#x671F;&#x4EA4;&#x6613;&#x7684;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;&#x7684;&#x6838;&#x5FC3;&lt; T0&gt;&#x3002;</strong></span><span class="yiyi-st" id="yiyi-82">&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="orm_session_basics.html#session-faq-whentocreate"><span>When do I construct a Session, when do I commit it, and when do I close it?</span></a></span><span class="yiyi-st" id="yiyi-83">&#x5BF9;&#x6B64;&#x6709;&#x4E00;&#x4E9B;&#x60F3;&#x6CD5;&#x3002;</span></li><li><span class="yiyi-st" id="yiyi-84">&#x6211;&#x4EEC;&#x544A;&#x8BC9;&#x6211;&#x4EEC;&#x7684;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x91CD;&#x65B0;&#x8BFB;&#x53D6;&#x5B83;&#x5DF2;&#x7ECF;&#x8BFB;&#x53D6;&#x7684;&#x884C;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x4F7F;&#x7528;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.expire_all" title="sqlalchemy.orm.session.Session.expire_all"><code class="xref py py-meth docutils literal"><span class="pre">Session.expire_all()</span></code></a>&#x6216;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.expire" title="sqlalchemy.orm.session.Session.expire"><code class="xref py py-meth docutils literal"><span class="pre">Session.expire()</span></code></a>&#xFF0C;&#x6216;&#x4F7F;&#x7528;<code class="xref py py-class docutils literal"><span class="pre">Session.refresh</span></code>&#x7ACB;&#x5373;&#x5728;&#x5BF9;&#x8C61;&#x4E0A;&#x3002;</span><span class="yiyi-st" id="yiyi-85">&#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="orm_session_state_management.html#session-expire"><span>Refreshing / Expiring</span></a>&#x3002;</span></li><li><span class="yiyi-st" id="yiyi-86">&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD0;&#x884C;&#x6574;&#x4E2A;&#x67E5;&#x8BE2;&#xFF0C;&#x540C;&#x65F6;&#x5C06;&#x5B83;&#x4EEC;&#x8BBE;&#x7F6E;&#x4E3A;&#x5728;&#x4F7F;&#x7528;<a class="reference internal" href="orm_query.html#sqlalchemy.orm.query.Query.populate_existing" title="sqlalchemy.orm.query.Query.populate_existing"><code class="xref py py-meth docutils literal"><span class="pre">Query.populate_existing()</span></code></a>&#x8BFB;&#x53D6;&#x884C;&#x65F6;&#x660E;&#x786E;&#x8986;&#x76D6;&#x5DF2;&#x52A0;&#x8F7D;&#x7684;&#x5BF9;&#x8C61;&#x3002;</span></li></ol><p><span class="yiyi-st" id="yiyi-87">But remember, <strong>the ORM cannot see changes in rows if our isolation level is repeatable read or higher, unless we start a new transaction</strong>.</span></p></div><div class="section" id="this-session-s-transaction-has-been-rolled-back-due-to-a-previous-exception-during-flush-or-similar"><h2><span class="yiyi-st" id="yiyi-88">&#x201C;&#x6B64;&#x4F1A;&#x8BDD;&#x7684;&#x4E8B;&#x52A1;&#x7531;&#x4E8E;&#x5237;&#x65B0;&#x671F;&#x95F4;&#x7684;&#x5148;&#x524D;&#x5F02;&#x5E38;&#x800C;&#x56DE;&#x6EDA;&#x3002;&#x201D;&#xFF08;&#x6216;&#x7C7B;&#x4F3C;&#x7684;&#xFF09;<a class="headerlink" href="#this-session-s-transaction-has-been-rolled-back-due-to-a-previous-exception-during-flush-or-similar" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-89">This is an error that occurs when a <a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.flush" title="sqlalchemy.orm.session.Session.flush"><code class="xref py py-meth docutils literal"><span class="pre">Session.flush()</span></code></a> raises an exception, rolls back the transaction, but further commands upon the <cite>Session</cite> are called without an explicit call to <a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.rollback" title="sqlalchemy.orm.session.Session.rollback"><code class="xref py py-meth docutils literal"><span class="pre">Session.rollback()</span></code></a> or <a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.close" title="sqlalchemy.orm.session.Session.close"><code class="xref py py-meth docutils literal"><span class="pre">Session.close()</span></code></a>.</span></p><p><span class="yiyi-st" id="yiyi-90">&#x5B83;&#x901A;&#x5E38;&#x5BF9;&#x5E94;&#x4E8E;&#x6355;&#x83B7;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.flush" title="sqlalchemy.orm.session.Session.flush"><code class="xref py py-meth docutils literal"><span class="pre">Session.flush()</span></code></a>&#x6216;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.commit" title="sqlalchemy.orm.session.Session.commit"><code class="xref py py-meth docutils literal"><span class="pre">Session.commit()</span></code></a>&#x4E2D;&#x7684;&#x5F02;&#x5E38;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x6B63;&#x786E;&#x5904;&#x7406;&#x5F02;&#x5E38;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</span><span class="yiyi-st" id="yiyi-91">&#x4F8B;&#x5982;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">(</span><span class="n">create_engine</span><span class="p">(</span><span class="s1">&apos;sqlite://&apos;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;foo&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()()</span>

<span class="c1"># constraint violation</span>
<span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">Foo</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">Foo</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># ignore error</span>
    <span class="k">pass</span>

<span class="c1"># continue using session without rolling back</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div></div><p><span class="yiyi-st" id="yiyi-92"><a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x7684;&#x7528;&#x6CD5;&#x5E94;&#x8BE5;&#x7B26;&#x5408;&#x7C7B;&#x4F3C;&#x4E8E;&#x4EE5;&#x4E0B;&#x7684;&#x7ED3;&#x6784;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>try:
    &lt;use session&gt;
    session.commit()
except:
   session.rollback()
   raise
finally:
   session.close()  # optional, depends on use case</pre></div></div><p><span class="yiyi-st" id="yiyi-93">&#x8BB8;&#x591A;&#x4E8B;&#x60C5;&#x53EF;&#x80FD;&#x5BFC;&#x81F4;&#x5C1D;&#x8BD5;/&#x9664;&#x4E86;&#x51B2;&#x5237;&#x9664;&#x5916;&#x5931;&#x8D25;&#x3002;</span><span class="yiyi-st" id="yiyi-94">&#x60A8;&#x5E94;&#x59CB;&#x7EC8;&#x5BF9;&#x4F1A;&#x8BDD;&#x64CD;&#x4F5C;&#x8FDB;&#x884C;&#x67D0;&#x79CD;&#x201C;&#x6784;&#x67B6;&#x201D;&#xFF0C;&#x4EE5;&#x4FBF;&#x8FDE;&#x63A5;&#x548C;&#x4E8B;&#x52A1;&#x8D44;&#x6E90;&#x5177;&#x6709;&#x786E;&#x5B9A;&#x7684;&#x8FB9;&#x754C;&#xFF0C;&#x5426;&#x5219;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5E76;&#x672A;&#x771F;&#x6B63;&#x63A7;&#x5236;&#x5176;&#x8D44;&#x6E90;&#x7684;&#x4F7F;&#x7528;&#x3002;</span><span class="yiyi-st" id="yiyi-95">&#x8FD9;&#x5E76;&#x4E0D;&#x662F;&#x8BF4;&#x4F60;&#x9700;&#x8981;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x653E;&#x7F6E;try / except&#x5757;&#xFF0C;&#x76F8;&#x53CD;&#xFF0C;&#x8FD9;&#x5C06;&#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x6015;&#x7684;&#x60F3;&#x6CD5;&#x3002;</span><span class="yiyi-st" id="yiyi-96">&#x60A8;&#x5E94;&#x8BE5;&#x6784;&#x5EFA;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x4EE5;&#x4FBF;&#x5728;&#x4F1A;&#x8BDD;&#x64CD;&#x4F5C;&#x5468;&#x56F4;&#x6709;&#x4E00;&#x4E2A;&#xFF08;&#x6216;&#x51E0;&#x4E2A;&#xFF09;&#x201C;&#x6846;&#x67B6;&#x201D;&#x70B9;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-97">&#x6709;&#x5173;&#x5982;&#x4F55;&#x7EC4;&#x7EC7;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#x7684;&#x8BE6;&#x7EC6;&#x8BA8;&#x8BBA;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="orm_session_basics.html#session-faq-whentocreate"><span>When do I construct a Session, when do I commit it, and when do I close it?</span></a>&#x3002;</span></p><div class="section" id="but-why-does-flush-insist-on-issuing-a-rollback"><h3><span class="yiyi-st" id="yiyi-98">&#x4F46;&#x4E3A;&#x4EC0;&#x4E48;flush()&#x575A;&#x6301;&#x53D1;&#x5E03;ROLLBACK&#xFF1F;<a class="headerlink" href="#but-why-does-flush-insist-on-issuing-a-rollback" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-99">&#x5982;&#x679C;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.flush" title="sqlalchemy.orm.session.Session.flush"><code class="xref py py-meth docutils literal"><span class="pre">Session.flush()</span></code></a>&#x53EF;&#x4EE5;&#x90E8;&#x5206;&#x5B8C;&#x6210;&#x7136;&#x540E;&#x4E0D;&#x56DE;&#x6EDA;&#x4F1A;&#x5F88;&#x597D;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x8D85;&#x51FA;&#x4E86;&#x5B83;&#x5F53;&#x524D;&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x7684;&#x5185;&#x90E8;&#x7C3F;&#x8BB0;&#x5FC5;&#x987B;&#x88AB;&#x4FEE;&#x6539;&#xFF0C;&#x4EE5;&#x4FBF;&#x5B83;&#x53EF;&#x4EE5;&#x5728;&#x4EFB;&#x4F55;&#x65F6;&#x5019;&#x88AB;&#x6682;&#x505C;&#x65F6;&#x95F4;&#xFF0C;&#x5E76;&#x4E0E;&#x5DF2;&#x5237;&#x65B0;&#x5230;&#x6570;&#x636E;&#x5E93;&#x7684;&#x5185;&#x5BB9;&#x5B8C;&#x5168;&#x4E00;&#x81F4;&#x3002;</span><span class="yiyi-st" id="yiyi-100">&#x867D;&#x7136;&#x8FD9;&#x5728;&#x7406;&#x8BBA;&#x4E0A;&#x662F;&#x53EF;&#x884C;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x7531;&#x4E8E;&#x8BB8;&#x591A;&#x6570;&#x636E;&#x5E93;&#x64CD;&#x4F5C;&#x5728;&#x4EFB;&#x4F55;&#x60C5;&#x51B5;&#x4E0B;&#x90FD;&#x9700;&#x8981;ROLLBACK&#xFF0C;&#x6240;&#x4EE5;&#x589E;&#x5F3A;&#x7684;&#x6709;&#x7528;&#x6027;&#x5927;&#x5927;&#x964D;&#x4F4E;&#x4E86;&#x3002;</span><span class="yiyi-st" id="yiyi-101">&#x7279;&#x522B;&#x662F;Postgres&#x6709;&#x4E00;&#x4E9B;&#x64CD;&#x4F5C;&#xFF0C;&#x4E00;&#x65E6;&#x5931;&#x8D25;&#xFF0C;&#x4EA4;&#x6613;&#x4E0D;&#x5141;&#x8BB8;&#x7EE7;&#x7EED;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>test=&gt; create table foo(id integer primary key);
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index &quot;foo_pkey&quot; for table &quot;foo&quot;
CREATE TABLE
test=&gt; begin;
BEGIN
test=&gt; insert into foo values(1);
INSERT 0 1
test=&gt; commit;
COMMIT
test=&gt; begin;
BEGIN
test=&gt; insert into foo values(1);
ERROR:  duplicate key value violates unique constraint &quot;foo_pkey&quot;
test=&gt; insert into foo values(2);
ERROR:  current transaction is aborted, commands ignored until end of transaction block</pre></div></div><p><span class="yiyi-st" id="yiyi-102">SQLAlchemy&#x63D0;&#x4F9B;&#x7684;&#x89E3;&#x51B3;&#x8FD9;&#x4E24;&#x4E2A;&#x95EE;&#x9898;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x901A;&#x8FC7;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.begin_nested" title="sqlalchemy.orm.session.Session.begin_nested"><code class="xref py py-meth docutils literal"><span class="pre">Session.begin_nested()</span></code></a>&#x652F;&#x6301;SAVEPOINT&#x3002;</span><span class="yiyi-st" id="yiyi-103">&#x901A;&#x8FC7;&#x4F7F;&#x7528;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.begin_nested" title="sqlalchemy.orm.session.Session.begin_nested"><code class="xref py py-meth docutils literal"><span class="pre">Session.begin_nested()</span></code></a>&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;&#x53EF;&#x80FD;&#x5728;&#x4E8B;&#x52A1;&#x5185;&#x5931;&#x8D25;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x4FDD;&#x6301;&#x5C01;&#x95ED;&#x4E8B;&#x52A1;&#x7684;&#x540C;&#x65F6;&#x201C;&#x56DE;&#x6EDA;&#x201D;&#x5230;&#x5931;&#x8D25;&#x524D;&#x7684;&#x70B9;&#x3002;</span></p></div><div class="section" id="but-why-isn-t-the-one-automatic-call-to-rollback-enough-why-must-i-rollback-again"><h3><span class="yiyi-st" id="yiyi-104">&#x4F46;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x662F;&#x81EA;&#x52A8;&#x8C03;&#x7528;ROLLBACK&#x8DB3;&#x591F;&#xFF1F;</span><span class="yiyi-st" id="yiyi-105">&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x5FC5;&#x987B;&#x518D;&#x6B21;ROLLBACK&#xFF1F;<a class="headerlink" href="#but-why-isn-t-the-one-automatic-call-to-rollback-enough-why-must-i-rollback-again" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-106">&#x8FD9;&#x4E5F;&#x662F;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x4E00;&#x81F4;&#x7684;&#x63A5;&#x53E3;&#x5E76;&#x62D2;&#x7EDD;&#x731C;&#x6D4B;&#x5B83;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x95EE;&#x9898;&#x3002;</span><span class="yiyi-st" id="yiyi-107">&#x4F8B;&#x5982;&#xFF0C;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x652F;&#x6301;&#x591A;&#x4E2A;&#x7EA7;&#x522B;&#x5185;&#x7684;&#x201C;&#x6210;&#x5E27;&#x201D;&#x3002;</span><span class="yiyi-st" id="yiyi-108">&#x6BD4;&#x5982;&#xFF0C;&#x5047;&#x8BBE;&#x4F60;&#x6709;&#x4E00;&#x4E2A;&#x88C5;&#x9970;&#x5668;<code class="docutils literal"><span class="pre">@with_session()</span></code>&#xFF0C;&#x5B83;&#x8FD9;&#x6837;&#x505A;&#x4E86;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">with_session</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">go</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
       <span class="n">session</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">subtransactions</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
       <span class="k">try</span><span class="p">:</span>
           <span class="n">ret</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
           <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
           <span class="k">return</span> <span class="n">ret</span>
       <span class="k">except</span><span class="p">:</span>
           <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
           <span class="k">raise</span>
   <span class="k">return</span> <span class="n">go</span></pre></div></div><p><span class="yiyi-st" id="yiyi-109">&#x5982;&#x679C;&#x4E0A;&#x9762;&#x7684;&#x88C5;&#x9970;&#x5668;&#x5DF2;&#x7ECF;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x5F00;&#x59CB;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#xFF0C;&#x7136;&#x540E;&#x63D0;&#x4EA4;&#x5B83;&#xFF0C;&#x5982;&#x679C;&#x5B83;&#x662F;&#x521B;&#x5EFA;&#x8005;&#x3002;</span><span class="yiyi-st" id="yiyi-110">&#x201C;subtransactions&#x201D;&#x6807;&#x5FD7;&#x8868;&#x793A;&#x5982;&#x679C;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.begin" title="sqlalchemy.orm.session.Session.begin"><code class="xref py py-meth docutils literal"><span class="pre">Session.begin()</span></code></a>&#x5DF2;&#x88AB;&#x5C01;&#x95ED;&#x51FD;&#x6570;&#x8C03;&#x7528;&#xFF0C;&#x9664;&#x4E86;&#x8BA1;&#x6570;&#x5668;&#x9012;&#x589E;&#x5916;&#xFF0C;&#x4EC0;&#x4E48;&#x90FD;&#x4E0D;&#x4F1A;&#x53D1;&#x751F; - &#x5F53;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.commit" title="sqlalchemy.orm.session.Session.commit"><code class="xref py py-meth docutils literal"><span class="pre">Session.commit()</span></code></a></span><span class="yiyi-st" id="yiyi-111">&#x5B83;&#x5141;&#x8BB8;&#x8FD9;&#x79CD;&#x4F7F;&#x7528;&#x6A21;&#x5F0F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>@with_session
def one():
   # do stuff
   two()


@with_session
def two():
   # etc.

one()

two()</pre></div></div><p><span class="yiyi-st" id="yiyi-112"><code class="docutils literal"><span class="pre">one()</span></code>&#x53EF;&#x4EE5;&#x8C03;&#x7528;<code class="docutils literal"><span class="pre">two()</span></code>&#xFF0C;&#x6216;<code class="docutils literal"><span class="pre">two()</span></code>&#x53EF;&#x4EE5;&#x81EA;&#x884C;&#x8C03;&#x7528;&#xFF0C;<code class="docutils literal"><span class="pre">@with_session</span></code></span><span class="yiyi-st" id="yiyi-113">&#x6B63;&#x5982;&#x4F60;&#x6240;&#x770B;&#x5230;&#x7684;&#xFF0C;&#x5982;&#x679C;<code class="docutils literal"><span class="pre">two()</span></code>&#x8C03;&#x7528;&#x5F15;&#x53D1;&#x5F02;&#x5E38;&#x7136;&#x540E;&#x53D1;&#x51FA;<code class="docutils literal"><span class="pre">rollback()</span></code>&#x7684;<code class="docutils literal"><span class="pre">flush()</span></code>&#xFF0C;&#x90A3;&#x4E48;<em> always</em>&#x662F;&#x88C5;&#x9970;&#x5668;&#x6267;&#x884C;&#x7684;&#x7B2C;&#x4E8C;&#x4E2A;<code class="docutils literal"><span class="pre">rollback()</span></code>&#xFF0C;&#x53EF;&#x80FD;&#x8FD8;&#x6709;&#x7B2C;&#x4E09;&#x4E2A;&#x5BF9;&#x5E94;&#x4E8E;&#x4E24;&#x4E2A;&#x88C5;&#x9970;&#x5668;&#x7EA7;&#x522B;&#x3002;</span><span class="yiyi-st" id="yiyi-114">&#x5982;&#x679C;<code class="docutils literal"><span class="pre">flush()</span></code>&#x5C06;<code class="docutils literal"><span class="pre">rollback()</span></code>&#x63A8;&#x5230;&#x6808;&#x9876;&#xFF0C;&#x7136;&#x540E;&#x6211;&#x4EEC;&#x8BF4;&#x6240;&#x6709;&#x5269;&#x4E0B;&#x7684;<code class="docutils literal"><span class="pre">rollback()</span></code></span><span class="yiyi-st" id="yiyi-115">&#x5199;&#x5F97;&#x4E0D;&#x597D;&#x7684;&#x5C01;&#x95ED;&#x65B9;&#x6CD5;&#x53EF;&#x80FD;&#x4F1A;&#x6291;&#x5236;&#x5F02;&#x5E38;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x6CA1;&#x6709;&#x9519;&#x8BEF;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x8C03;&#x7528;<code class="docutils literal"><span class="pre">commit()</span></code>&#xFF0C;&#x7136;&#x540E;&#x60A8;&#x6709;&#x4E00;&#x4E2A;&#x65E0;&#x63D0;&#x793A;&#x5931;&#x8D25;&#x6761;&#x4EF6;&#x3002;</span><span class="yiyi-st" id="yiyi-116">&#x4EBA;&#x4EEC;&#x5F97;&#x5230;&#x8FD9;&#x4E2A;&#x9519;&#x8BEF;&#x7684;&#x4E3B;&#x8981;&#x539F;&#x56E0;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x56E0;&#x4E3A;&#x4ED6;&#x4EEC;&#x6CA1;&#x6709;&#x7F16;&#x5199;&#x5E72;&#x51C0;&#x7684;&#x201C;&#x6846;&#x67B6;&#x201D;&#x4EE3;&#x7801;&#xFF0C;&#x800C;&#x4E14;&#x4ED6;&#x4EEC;&#x8FD8;&#x4F1A;&#x9047;&#x5230;&#x5176;&#x4ED6;&#x95EE;&#x9898;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-117">If you think the above use case is a little exotic, the same kind of thing comes into play if you want to SAVEPOINT- you might call <code class="docutils literal"><span class="pre">begin_nested()</span></code> several times, and the <code class="docutils literal"><span class="pre">commit()</span></code>/<code class="docutils literal"><span class="pre">rollback()</span></code> calls each resolve the most recent <code class="docutils literal"><span class="pre">begin_nested()</span></code>. </span><span class="yiyi-st" id="yiyi-118">The meaning of <code class="docutils literal"><span class="pre">rollback()</span></code> or <code class="docutils literal"><span class="pre">commit()</span></code> is dependent upon which enclosing block it is called, and you might have any sequence of <code class="docutils literal"><span class="pre">rollback()</span></code>/<code class="docutils literal"><span class="pre">commit()</span></code> in any order, and its the level of nesting that determines their behavior.</span></p><p><span class="yiyi-st" id="yiyi-119">&#x5728;&#x4E0A;&#x8FF0;&#x4E24;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5982;&#x679C;<code class="docutils literal"><span class="pre">flush()</span></code>&#x8FDD;&#x53CD;&#x4E86;&#x4E8B;&#x52A1;&#x5757;&#x7684;&#x5D4C;&#x5957;&#xFF0C;&#x5219;&#x6839;&#x636E;&#x60C5;&#x51B5;&#xFF0C;&#x884C;&#x4E3A;&#x5C06;&#x4ECE;&#x201C;&#x9B54;&#x672F;&#x201D;&#x5230;&#x65E0;&#x58F0;&#x5931;&#x8D25;&#x5230;&#x516C;&#x7136;&#x4E2D;&#x65AD;&#x4EE3;&#x7801;&#x6D41;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-120"><code class="docutils literal"><span class="pre">flush()</span></code> makes its own &#x201C;subtransaction&#x201D;, so that a transaction is started up regardless of the external transactional state, and when complete it calls <code class="docutils literal"><span class="pre">commit()</span></code>, or <code class="docutils literal"><span class="pre">rollback()</span></code> upon failure - but that <code class="docutils literal"><span class="pre">rollback()</span></code> corresponds to its own subtransaction - it doesn&#x2019;t want to guess how you&#x2019;d like to handle the external &#x201C;framing&#x201D; of the transaction, which could be nested many levels with any combination of subtransactions and real SAVEPOINTs. </span><span class="yiyi-st" id="yiyi-121">&#x5F00;&#x59CB;/&#x7ED3;&#x675F;&#x201C;&#x5E27;&#x201D;&#x7684;&#x5DE5;&#x4F5C;&#x4E0E;<code class="docutils literal"><span class="pre">flush()</span></code>&#x5916;&#x90E8;&#x7684;&#x4EE3;&#x7801;&#x4FDD;&#x6301;&#x4E00;&#x81F4;&#xFF0C;&#x5E76;&#x4E14;&#x6211;&#x4EEC;&#x51B3;&#x5B9A;&#x8FD9;&#x662F;&#x6700;&#x4E00;&#x81F4;&#x7684;&#x65B9;&#x6CD5;&#x3002;</span></p></div></div><div class="section" id="how-do-i-make-a-query-that-always-adds-a-certain-filter-to-every-query"><h2><span class="yiyi-st" id="yiyi-122">&#x6211;&#x5982;&#x4F55;&#x505A;&#x4E00;&#x4E2A;&#x603B;&#x662F;&#x4E3A;&#x6BCF;&#x4E2A;&#x67E5;&#x8BE2;&#x6DFB;&#x52A0;&#x7279;&#x5B9A;&#x8FC7;&#x6EE4;&#x5668;&#x7684;&#x67E5;&#x8BE2;&#xFF1F;<a class="headerlink" href="#how-do-i-make-a-query-that-always-adds-a-certain-filter-to-every-query" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-123">&#x8BF7;&#x53C2;&#x9605;<a class="reference external" href="http://www.sqlalchemy.org/trac/wiki/UsageRecipes/PreFilteredQuery">PreFilteredQuery</a>&#x4E2D;&#x7684;&#x914D;&#x65B9;&#x3002;</span></p></div><div class="section" id="i-ve-created-a-mapping-against-an-outer-join-and-while-the-query-returns-rows-no-objects-are-returned-why-not"><h2><span class="yiyi-st" id="yiyi-124">&#x6211;&#x5DF2;&#x7ECF;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x9488;&#x5BF9;&#x5916;&#x90E8;&#x8FDE;&#x63A5;&#x7684;&#x6620;&#x5C04;&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x67E5;&#x8BE2;&#x8FD4;&#x56DE;&#x884C;&#x65F6;&#xFF0C;&#x4E0D;&#x4F1A;&#x8FD4;&#x56DE;&#x4EFB;&#x4F55;&#x5BF9;&#x8C61;&#x3002;</span><span class="yiyi-st" id="yiyi-125">&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x5462;&#xFF1F;<a class="headerlink" href="#i-ve-created-a-mapping-against-an-outer-join-and-while-the-query-returns-rows-no-objects-are-returned-why-not" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-126">&#x7531;&#x5916;&#x90E8;&#x8054;&#x63A5;&#x8FD4;&#x56DE;&#x7684;&#x884C;&#x53EF;&#x80FD;&#x5305;&#x542B;NULL&#x4F5C;&#x4E3A;&#x4E3B;&#x952E;&#x7684;&#x4E00;&#x90E8;&#x5206;&#xFF0C;&#x56E0;&#x4E3A;&#x4E3B;&#x952E;&#x662F;&#x4E24;&#x4E2A;&#x8868;&#x7684;&#x7EC4;&#x5408;&#x3002;</span><span class="yiyi-st" id="yiyi-127"><a class="reference internal" href="orm_query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal"><span class="pre">Query</span></code></a>&#x5BF9;&#x8C61;&#x4F1A;&#x5FFD;&#x7565;&#x6CA1;&#x6709;&#x53EF;&#x63A5;&#x53D7;&#x4E3B;&#x952E;&#x7684;&#x4F20;&#x5165;&#x884C;&#x3002;</span><span class="yiyi-st" id="yiyi-128">Based on the setting of the <code class="docutils literal"><span class="pre">allow_partial_pks</span></code> flag on <a class="reference internal" href="orm_mapping_api.html#sqlalchemy.orm.mapper" title="sqlalchemy.orm.mapper"><code class="xref py py-func docutils literal"><span class="pre">mapper()</span></code></a>, a primary key is accepted if the value has at least one non-NULL value, or alternatively if the value has no NULL values. </span><span class="yiyi-st" id="yiyi-129">&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="orm_mapping_api.html#sqlalchemy.orm.mapper" title="sqlalchemy.orm.mapper"><code class="xref py py-func docutils literal"><span class="pre">mapper()</span></code></a>&#x4E2D;&#x7684;<code class="docutils literal"><span class="pre">allow_partial_pks</span></code>&#x3002;</span></p></div><div class="section" id="i-m-using-joinedload-or-lazy-false-to-create-a-join-outer-join-and-sqlalchemy-is-not-constructing-the-correct-query-when-i-try-to-add-a-where-order-by-limit-etc-which-relies-upon-the-outer-join"><h2><span class="yiyi-st" id="yiyi-130">I&#x2019;m using <code class="docutils literal"><span class="pre">joinedload()</span></code> or <code class="docutils literal"><span class="pre">lazy=False</span></code> to create a JOIN/OUTER JOIN and SQLAlchemy is not constructing the correct query when I try to add a WHERE, ORDER BY, LIMIT, etc. </span><span class="yiyi-st" id="yiyi-131">&#xFF08;&#x4F9D;&#x8D56;&#x4E8E;&#xFF08;OUTER&#xFF09;JOIN&#xFF09;<a class="headerlink" href="#i-m-using-joinedload-or-lazy-false-to-create-a-join-outer-join-and-sqlalchemy-is-not-constructing-the-correct-query-when-i-try-to-add-a-where-order-by-limit-etc-which-relies-upon-the-outer-join" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-132">&#x901A;&#x8FC7;&#x52A0;&#x5165;&#x7684;&#x9884;&#x5148;&#x52A0;&#x8F7D;&#x751F;&#x6210;&#x7684;&#x8FDE;&#x63A5;&#x4EC5;&#x7528;&#x4E8E;&#x5B8C;&#x5168;&#x52A0;&#x8F7D;&#x76F8;&#x5173;&#x96C6;&#x5408;&#xFF0C;&#x5E76;&#x4E14;&#x8BBE;&#x8BA1;&#x4E3A;&#x4E0D;&#x4F1A;&#x5F71;&#x54CD;&#x67E5;&#x8BE2;&#x7684;&#x4E3B;&#x8981;&#x7ED3;&#x679C;&#x3002;</span><span class="yiyi-st" id="yiyi-133">&#x7531;&#x4E8E;&#x5B83;&#x4EEC;&#x662F;&#x533F;&#x540D;&#x522B;&#x540D;&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x5F15;&#x7528;&#x5B83;&#x4EEC;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-134">&#x6709;&#x5173;&#x6B64;&#x884C;&#x4E3A;&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="orm_loading_relationships.html#zen-of-eager-loading"><span>The Zen of Eager Loading</span></a>&#x3002;</span></p></div><div class="section" id="query-has-no-len-why-not"><h2><span class="yiyi-st" id="yiyi-135">&#x67E5;&#x8BE2;&#x6CA1;&#x6709;<code class="docutils literal"><span class="pre">__len__()</span></code>&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x5462;&#xFF1F;<a class="headerlink" href="#query-has-no-len-why-not" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-136">&#x5E94;&#x7528;&#x4E8E;&#x5BF9;&#x8C61;&#x7684;Python <code class="docutils literal"><span class="pre">__len__()</span></code>&#x9B54;&#x672F;&#x65B9;&#x6CD5;&#x5141;&#x8BB8;&#x4F7F;&#x7528;<code class="docutils literal"><span class="pre">len()</span></code>&#x5185;&#x5EFA;&#x6765;&#x786E;&#x5B9A;&#x96C6;&#x5408;&#x7684;&#x957F;&#x5EA6;&#x3002;</span><span class="yiyi-st" id="yiyi-137">It&#x2019;s intuitive that a SQL query object would link <code class="docutils literal"><span class="pre">__len__()</span></code> to the <a class="reference internal" href="orm_query.html#sqlalchemy.orm.query.Query.count" title="sqlalchemy.orm.query.Query.count"><code class="xref py py-meth docutils literal"><span class="pre">Query.count()</span></code></a> method, which emits a <cite>SELECT COUNT</cite>. </span><span class="yiyi-st" id="yiyi-138">&#x8FD9;&#x662F;&#x4E0D;&#x53EF;&#x80FD;&#x7684;&#x539F;&#x56E0;&#x662F;&#x56E0;&#x4E3A;&#x8BC4;&#x4F30;&#x67E5;&#x8BE2;&#x4F5C;&#x4E3A;&#x5217;&#x8868;&#x4F1A;&#x5BFC;&#x81F4;&#x4E24;&#x4E2A;SQL&#x8C03;&#x7528;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Iterates</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;LEN!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">5</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;ITER!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

<span class="nb">list</span><span class="p">(</span><span class="n">Iterates</span><span class="p">())</span></pre></div></div><p><span class="yiyi-st" id="yiyi-139">&#x8F93;&#x51FA;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>ITER!
LEN!</pre></div></div></div><div class="section" id="how-do-i-use-textual-sql-with-orm-queries"><h2><span class="yiyi-st" id="yiyi-140">&#x5982;&#x4F55;&#x5728;ORM&#x67E5;&#x8BE2;&#x4E2D;&#x4F7F;&#x7528;&#x6587;&#x672C;SQL&#xFF1F;<a class="headerlink" href="#how-do-i-use-textual-sql-with-orm-queries" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-141">&#x770B;&#x5230;&#xFF1A;</span></p><ul class="simple"><li><span class="yiyi-st" id="yiyi-142"><a class="reference internal" href="orm_tutorial.html#orm-tutorial-literal-sql"><span>Using Textual SQL</span></a>  - &#x5177;&#x6709;<a class="reference internal" href="orm_query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal"><span class="pre">Query</span></code></a>&#x7684;&#x7279;&#x8BBE;&#x6587;&#x672C;&#x5757;</span></li><li><span class="yiyi-st" id="yiyi-143"><a class="reference internal" href="orm_persistence_techniques.html#session-sql-expressions"><span>Using SQL Expressions with Sessions</span></a>  - &#x76F4;&#x63A5;&#x5728;&#x6587;&#x672C;SQL&#x4E2D;&#x4F7F;&#x7528;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x3002;</span></li></ul></div><div class="section" id="i-m-calling-session-delete-myobject-and-it-isn-t-removed-from-the-parent-collection"><h2><span class="yiyi-st" id="yiyi-144">&#x6211;&#x6253;&#x7535;&#x8BDD;&#x7ED9;<code class="docutils literal"><span class="pre">Session.delete(myobject)</span></code>&#xFF0C;&#x5B83;&#x4E0D;&#x4F1A;&#x4ECE;&#x7236;&#x96C6;&#x5408;&#x4E2D;&#x79FB;&#x9664;&#xFF01;<a class="headerlink" href="#i-m-calling-session-delete-myobject-and-it-isn-t-removed-from-the-parent-collection" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-145">&#x6709;&#x5173;&#x6B64;&#x884C;&#x4E3A;&#x7684;&#x63CF;&#x8FF0;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="orm_session_basics.html#session-deleting-from-collections"><span>Deleting from Collections</span></a>&#x3002;</span></p></div><div class="section" id="why-isn-t-my-init-called-when-i-load-objects"><h2><span class="yiyi-st" id="yiyi-146">&#x4E3A;&#x4EC0;&#x4E48;&#x5F53;&#x6211;&#x52A0;&#x8F7D;&#x5BF9;&#x8C61;&#x65F6;&#x4E0D;&#x8C03;&#x7528;<code class="docutils literal"><span class="pre">__init__()</span></code>&#xFF1F;<a class="headerlink" href="#why-isn-t-my-init-called-when-i-load-objects" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-147">&#x6709;&#x5173;&#x6B64;&#x884C;&#x4E3A;&#x7684;&#x63CF;&#x8FF0;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="orm_constructors.html#mapping-constructors"><span>Constructors and Object Initialization</span></a>&#x3002;</span></p></div><div class="section" id="how-do-i-use-on-delete-cascade-with-sa-s-orm"><h2><span class="yiyi-st" id="yiyi-148">&#x5982;&#x4F55;&#x5728;SA&#x7684;ORM&#x4E2D;&#x4F7F;&#x7528;ON DELETE CASCADE&#xFF1F;<a class="headerlink" href="#how-do-i-use-on-delete-cascade-with-sa-s-orm" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-149">SQLAlchemy&#x5C06;&#x59CB;&#x7EC8;&#x4E3A;&#x5F53;&#x524D;&#x52A0;&#x8F7D;&#x5728;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x4E2D;&#x7684;&#x76F8;&#x5173;&#x884C;&#x53D1;&#x5E03;UPDATE&#x6216;DELETE&#x8BED;&#x53E5;&#x3002;</span><span class="yiyi-st" id="yiyi-150">&#x5BF9;&#x4E8E;&#x672A;&#x52A0;&#x8F7D;&#x7684;&#x884C;&#xFF0C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5B83;&#x4F1A;&#x53D1;&#x51FA;SELECT&#x8BED;&#x53E5;&#x6765;&#x52A0;&#x8F7D;&#x8FD9;&#x4E9B;&#x884C;&#x5E76;&#x5C06;&#x5176;&#x5220;&#x9664;/&#x5220;&#x9664;&#xFF1B;&#x6362;&#x53E5;&#x8BDD;&#x8BF4;&#xFF0C;&#x5B83;&#x5047;&#x5B9A;&#x6CA1;&#x6709;&#x914D;&#x7F6E;ON DELETE CASCADE&#x3002;</span><span class="yiyi-st" id="yiyi-151">&#x8981;&#x5C06;SQLAlchemy&#x914D;&#x7F6E;&#x4E3A;&#x4E0E;ON DELETE CASCADE&#x914D;&#x5408;&#x4F7F;&#x7528;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="orm_collections.html#passive-deletes"><span>Using Passive Deletes</span></a>&#x3002;</span></p></div><div class="section" id="i-set-the-foo-id-attribute-on-my-instance-to-7-but-the-foo-attribute-is-still-none-shouldn-t-it-have-loaded-foo-with-id-7"><h2><span class="yiyi-st" id="yiyi-152">&#x6211;&#x5C06;&#x6211;&#x7684;&#x5B9E;&#x4F8B;&#x7684;&#x201C;foo_id&#x201D;&#x5C5E;&#x6027;&#x8BBE;&#x7F6E;&#x4E3A;&#x201C;7&#x201D;&#xFF0C;&#x4F46;&#x201C;foo&#x201D;&#x5C5E;&#x6027;&#x4ECD;&#x7136;&#x662F;<code class="docutils literal"><span class="pre">None</span></code>  - &#x5B83;&#x4E0D;&#x5E94;&#x8BE5;&#x4F7F;&#x7528;id&#xFF03;7&#x52A0;&#x8F7D;Foo&#x5417;&#xFF1F;<a class="headerlink" href="#i-set-the-foo-id-attribute-on-my-instance-to-7-but-the-foo-attribute-is-still-none-shouldn-t-it-have-loaded-foo-with-id-7" title="Permalink to this headline"> T2&gt;</a></span></h2><p><span class="yiyi-st" id="yiyi-153">ORM&#x7684;&#x6784;&#x9020;&#x65B9;&#x5F0F;&#x4E0D;&#x662F;&#x652F;&#x6301;&#x4ECE;&#x5916;&#x952E;&#x5C5E;&#x6027;&#x66F4;&#x6539;&#x9A71;&#x52A8;&#x7684;&#x5373;&#x65F6;&#x5173;&#x7CFB;&#x7FA4;&#x4F53; - &#x800C;&#x662F;&#x8BBE;&#x8BA1;&#x4E3A;&#x4EE5;&#x76F8;&#x53CD;&#x65B9;&#x5F0F;&#x5DE5;&#x4F5C; - &#x5916;&#x952E;&#x5C5E;&#x6027;&#x7531;ORM&#x5728;&#x5E55;&#x540E;&#x5904;&#x7406;&#xFF0C;&#x6700;&#x7EC8;&#x7528;&#x6237;&#x81EA;&#x7136;&#x5EFA;&#x7ACB;&#x5BF9;&#x8C61;&#x5173;&#x7CFB;&#x3002;</span><span class="yiyi-st" id="yiyi-154">&#x56E0;&#x6B64;&#xFF0C;&#x8BBE;&#x7F6E;<code class="docutils literal"><span class="pre">o.foo</span></code>&#x7684;&#x63A8;&#x8350;&#x65B9;&#x6CD5;&#x5C31;&#x662F;&#x8FD9;&#x6837;&#x505A; - &#x8BBE;&#x7F6E;&#x5B83;&#xFF01;</span><span class="yiyi-st" id="yiyi-155">:</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">foo</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">o</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="n">foo</span>
<span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div></div><p><span class="yiyi-st" id="yiyi-156">&#x64CD;&#x7EB5;&#x5916;&#x952E;&#x5C5E;&#x6027;&#x5F53;&#x7136;&#x662F;&#x5B8C;&#x5168;&#x5408;&#x6CD5;&#x7684;&#x3002;</span><span class="yiyi-st" id="yiyi-157">&#x4F46;&#x662F;&#xFF0C;&#x5C06;&#x5916;&#x952E;&#x5C5E;&#x6027;&#x8BBE;&#x7F6E;&#x4E3A;&#x65B0;&#x503C;&#x76EE;&#x524D;&#x4E0D;&#x4F1A;&#x89E6;&#x53D1;&#x5B83;&#x6240;&#x6D89;&#x53CA;&#x7684;<a class="reference internal" href="orm_relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal"><span class="pre">relationship()</span></code></a>&#x7684;&#x201C;&#x8FC7;&#x671F;&#x201D;&#x4E8B;&#x4EF6;&#x3002;</span><span class="yiyi-st" id="yiyi-158">&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5BF9;&#x4E8E;&#x4EE5;&#x4E0B;&#x987A;&#x5E8F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">o</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">SomeClass</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">o</span><span class="o">.</span><span class="n">foo</span> <span class="ow">is</span> <span class="bp">None</span>  <span class="c1"># accessing an un-set attribute sets it to None</span>
<span class="n">o</span><span class="o">.</span><span class="n">foo_id</span> <span class="o">=</span> <span class="mi">7</span></pre></div></div><p><span class="yiyi-st" id="yiyi-159"><code class="docutils literal"><span class="pre">o.foo</span></code> is initialized to <code class="docutils literal"><span class="pre">None</span></code> when we first accessed it. </span><span class="yiyi-st" id="yiyi-160">&#x8BBE;&#x7F6E;<code class="docutils literal"><span class="pre">o.foo_id</span> <span class="pre">=</span> <span class="pre">7</span></code>&#x7684;&#x503C;&#x4E3A;&#x201C;7&#x201D; - &#x6240;&#x4EE5;<code class="docutils literal"><span class="pre">o.foo</span></code>&#x4ECD;&#x7136;&#x662F;<code class="docutils literal"><span class="pre">None</span></code>&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># attribute is already set to None, has not been</span>
<span class="c1"># reconciled with o.foo_id = 7 yet</span>
<span class="k">assert</span> <span class="n">o</span><span class="o">.</span><span class="n">foo</span> <span class="ow">is</span> <span class="bp">None</span></pre></div></div><p><span class="yiyi-st" id="yiyi-161">&#x5BF9;&#x4E8E;&#x57FA;&#x4E8E;&#x5916;&#x952E;&#x53D8;&#x5F02;&#x7684;<code class="docutils literal"><span class="pre">o.foo</span></code>&#x52A0;&#x8F7D;&#x901A;&#x5E38;&#x4F1A;&#x5728;commit&#x540E;&#x81EA;&#x7136;&#x5B9E;&#x73B0;&#xFF0C;&#x5B83;&#x4EEC;&#x90FD;&#x4F1A;&#x5237;&#x65B0;&#x65B0;&#x7684;&#x5916;&#x952E;&#x503C;&#x5E76;&#x8FC7;&#x671F;&#x6240;&#x6709;&#x72B6;&#x6001;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># expires all attributes</span>

<span class="n">foo_7</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">o</span><span class="o">.</span><span class="n">foo</span> <span class="ow">is</span> <span class="n">foo_7</span>  <span class="c1"># o.foo lazyloads on access</span></pre></div></div><p><span class="yiyi-st" id="yiyi-162">&#x66F4;&#x7B80;&#x5355;&#x7684;&#x64CD;&#x4F5C;&#x662F;&#x5355;&#x72EC;&#x4F7F;&#x7528;&#x5C5E;&#x6027; - &#x8FD9;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.expire" title="sqlalchemy.orm.session.Session.expire"><code class="xref py py-meth docutils literal"><span class="pre">Session.expire()</span></code></a>&#x5BF9;&#x4EFB;&#x4F55;<a class="reference internal" href="glossary.html#term-persistent"><span class="xref std std-term">persistent</span></a>&#x5BF9;&#x8C61;&#x6267;&#x884C;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">o</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">SomeClass</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">o</span><span class="o">.</span><span class="n">foo_id</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">Session</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="p">[</span><span class="s1">&apos;foo&apos;</span><span class="p">])</span>  <span class="c1"># object must be persistent for this</span>

<span class="n">foo_7</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">o</span><span class="o">.</span><span class="n">foo</span> <span class="ow">is</span> <span class="n">foo_7</span>  <span class="c1"># o.foo lazyloads on access</span></pre></div></div><p><span class="yiyi-st" id="yiyi-163">&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5982;&#x679C;&#x5BF9;&#x8C61;&#x4E0D;&#x662F;&#x6301;&#x4E45;&#x5BF9;&#x8C61;&#xFF0C;&#x800C;&#x662F;&#x51FA;&#x73B0;&#x5728;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x4E2D;&#xFF0C;&#x5219;&#x79F0;&#x4E3A;<a class="reference internal" href="glossary.html#term-pending"><span class="xref std std-term">pending</span></a>&#x3002;</span><span class="yiyi-st" id="yiyi-164">&#x8FD9;&#x610F;&#x5473;&#x7740;&#x8BE5;&#x5BF9;&#x8C61;&#x7684;&#x884C;&#x5C1A;&#x672A;&#x88AB;&#x63D2;&#x5165;&#x5230;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x3002;</span><span class="yiyi-st" id="yiyi-165">&#x5BF9;&#x4E8E;&#x8FD9;&#x6837;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x63D2;&#x5165;&#x884C;&#x4E4B;&#x524D;&#x8BBE;&#x7F6E;<code class="docutils literal"><span class="pre">foo_id</span></code>&#x6CA1;&#x6709;&#x610F;&#x4E49;&#x3002;&#x5426;&#x5219;&#x8FD8;&#x6CA1;&#x6709;&#x884C;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">new_obj</span> <span class="o">=</span> <span class="n">SomeClass</span><span class="p">()</span>
<span class="n">new_obj</span><span class="o">.</span><span class="n">foo_id</span> <span class="o">=</span> <span class="mi">7</span>

<span class="n">Session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span>

<span class="c1"># accessing an un-set attribute sets it to None</span>
<span class="k">assert</span> <span class="n">new_obj</span><span class="o">.</span><span class="n">foo</span> <span class="ow">is</span> <span class="bp">None</span>

<span class="n">Session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>  <span class="c1"># emits INSERT</span>

<span class="c1"># expire this because we already set .foo to None</span>
<span class="n">Session</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="p">[</span><span class="s1">&apos;foo&apos;</span><span class="p">])</span>

<span class="k">assert</span> <span class="n">new_obj</span><span class="o">.</span><span class="n">foo</span> <span class="ow">is</span> <span class="n">foo_7</span>  <span class="c1"># now it loads</span></pre></div></div><div class="topic"><p class="topic-title first"><span class="yiyi-st" id="yiyi-166">&#x975E;&#x6301;&#x4E45;&#x5BF9;&#x8C61;&#x7684;&#x5C5E;&#x6027;&#x52A0;&#x8F7D;</span></p><p><span class="yiyi-st" id="yiyi-167">&#x4E0A;&#x9762;&#x7684;&#x201C;&#x7B49;&#x5F85;&#x201D;&#x884C;&#x4E3A;&#x7684;&#x4E00;&#x4E2A;&#x53D8;&#x4F53;&#x662F;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x5728;<a class="reference internal" href="orm_relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal"><span class="pre">relationship()</span></code></a>&#x4E0A;&#x4F7F;&#x7528;flag <code class="docutils literal"><span class="pre">load_on_pending</span></code>&#x3002;</span><span class="yiyi-st" id="yiyi-168">&#x5F53;&#x8FD9;&#x4E2A;&#x6807;&#x5FD7;&#x88AB;&#x8BBE;&#x7F6E;&#x65F6;&#xFF0C;&#x61D2;&#x60F0;&#x7684;&#x52A0;&#x8F7D;&#x5668;&#x5C06;&#x5728;INSERT&#x8FDB;&#x884C;&#x4E4B;&#x524D;&#x4E3A;<code class="docutils literal"><span class="pre">new_obj.foo</span></code>&#x53D1;&#x51FA;&#xFF1B;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#x7684;&#x53E6;&#x4E00;&#x4E2A;&#x53D8;&#x4F53;&#x662F;&#x4F7F;&#x7528;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session.enable_relationship_loading" title="sqlalchemy.orm.session.Session.enable_relationship_loading"><code class="xref py py-meth docutils literal"><span class="pre">Session.enable_relationship_loading()</span></code></a>&#x65B9;&#x6CD5;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x5C06;&#x5BF9;&#x8C61;&#x201C;&#x9644;&#x52A0;&#x201D;&#x5230;<a class="reference internal" href="orm_session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#xFF0C;&#x4F7F;&#x5F97;&#x591A;&#x5BF9;&#x4E00;&#x5173;&#x7CFB;&#x6839;&#x636E;&#x5916;&#x952E;&#x5C5E;&#x6027;&#x52A0;&#x8F7D;&#xFF0C;&#x800C;&#x4E0D;&#x7BA1;&#x5BF9;&#x8C61;&#x5904;&#x4E8E;&#x4EFB;&#x4F55;&#x7279;&#x5B9A;&#x72B6;&#x6001;&#x3002;</span><span class="yiyi-st" id="yiyi-169">Both techniques are <strong>not recommended for general use</strong>; they were added to suit specific programming scenarios encountered by users which involve the repurposing of the ORM&#x2019;s usual object states.</span></p></div><p><span class="yiyi-st" id="yiyi-170">&#x914D;&#x65B9;<a class="reference external" href="http://www.sqlalchemy.org/trac/wiki/UsageRecipes/ExpireRelationshipOnFKChange">ExpireRelationshipOnFKChange</a>&#x5177;&#x6709;&#x4F7F;&#x7528;SQLAlchemy&#x4E8B;&#x4EF6;&#x7684;&#x793A;&#x4F8B;&#xFF0C;&#x4EE5;&#x4FBF;&#x5C06;&#x5916;&#x952E;&#x5C5E;&#x6027;&#x7684;&#x8BBE;&#x7F6E;&#x4E0E;&#x591A;&#x5BF9;&#x4E00;&#x5173;&#x7CFB;&#x8FDB;&#x884C;&#x534F;&#x8C03;&#x3002;</span></p></div><div class="section" id="how-do-i-walk-all-objects-that-are-related-to-a-given-object"><h2><span class="yiyi-st" id="yiyi-171">&#x6211;&#x5982;&#x4F55;&#x8D70;&#x904D;&#x4E0E;&#x7ED9;&#x5B9A;&#x5BF9;&#x8C61;&#x76F8;&#x5173;&#x7684;&#x6240;&#x6709;&#x5BF9;&#x8C61;&#xFF1F;<a class="headerlink" href="#how-do-i-walk-all-objects-that-are-related-to-a-given-object" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-172">&#x5177;&#x6709;&#x4E0E;&#x5176;&#x76F8;&#x5173;&#x7684;&#x5176;&#x4ED6;&#x5BF9;&#x8C61;&#x7684;&#x5BF9;&#x8C61;&#x5C06;&#x5BF9;&#x5E94;&#x4E8E;&#x6620;&#x5C04;&#x5668;&#x4E4B;&#x95F4;&#x8BBE;&#x7F6E;&#x7684;<a class="reference internal" href="orm_relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal"><span class="pre">relationship()</span></code></a>&#x7ED3;&#x6784;&#x3002;</span><span class="yiyi-st" id="yiyi-173">&#x8FD9;&#x4E2A;&#x4EE3;&#x7801;&#x7247;&#x6BB5;&#x4F1A;&#x8FED;&#x4EE3;&#x6240;&#x6709;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x4FEE;&#x6B63;&#x5468;&#x671F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">inspect</span>


<span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">deque</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="p">]</span>

    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">deque</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">deque</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">obj</span>
        <span class="n">insp</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="n">insp</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">relationships</span><span class="p">:</span>
            <span class="n">related</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">relationship</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">relationship</span><span class="o">.</span><span class="n">uselist</span><span class="p">:</span>
                <span class="n">deque</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">related</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">related</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">deque</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">related</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-174">&#x8BE5;&#x529F;&#x80FD;&#x53EF;&#x4EE5;&#x6F14;&#x793A;&#x5982;&#x4E0B;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;a&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;b&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&apos;a.id&apos;</span><span class="p">))</span>
    <span class="n">c_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&apos;c.id&apos;</span><span class="p">))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;bs&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;c&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="p">[</span><span class="n">B</span><span class="p">(),</span> <span class="n">B</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">C</span><span class="p">())])</span>


<span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">walk</span><span class="p">(</span><span class="n">a1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-175">&#x8F93;&#x51FA;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>&lt;__main__.A object at 0x10303b190&gt;
&lt;__main__.B object at 0x103025210&gt;
&lt;__main__.B object at 0x10303b0d0&gt;
&lt;__main__.C object at 0x103025490&gt;</pre></div></div></div><div class="section" id="is-there-a-way-to-automagically-have-only-unique-keywords-or-other-kinds-of-objects-without-doing-a-query-for-the-keyword-and-getting-a-reference-to-the-row-containing-that-keyword"><h2><span class="yiyi-st" id="yiyi-176">&#x6709;&#x6CA1;&#x6709;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x5728;&#x4E0D;&#x67E5;&#x8BE2;&#x5173;&#x952E;&#x5B57;&#x5E76;&#x83B7;&#x53D6;&#x5BF9;&#x5305;&#x542B;&#x8BE5;&#x5173;&#x952E;&#x5B57;&#x7684;&#x884C;&#x7684;&#x5F15;&#x7528;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x4EC5;&#x81EA;&#x52A8;&#x751F;&#x6210;&#x552F;&#x4E00;&#x5173;&#x952E;&#x5B57;&#xFF08;&#x6216;&#x5176;&#x4ED6;&#x7C7B;&#x578B;&#x7684;&#x5BF9;&#x8C61;&#xFF09;&#xFF1F;<a class="headerlink" href="#is-there-a-way-to-automagically-have-only-unique-keywords-or-other-kinds-of-objects-without-doing-a-query-for-the-keyword-and-getting-a-reference-to-the-row-containing-that-keyword" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-177">&#x5F53;&#x4EBA;&#x4EEC;&#x9605;&#x8BFB;&#x6587;&#x6863;&#x4E2D;&#x7684;&#x591A;&#x5BF9;&#x591A;&#x793A;&#x4F8B;&#x65F6;&#xFF0C;&#x4ED6;&#x4EEC;&#x4F1A;&#x9047;&#x5230;&#x8FD9;&#x6837;&#x7684;&#x4E8B;&#x5B9E;&#xFF1A;&#x5982;&#x679C;&#x60A8;&#x521B;&#x5EFA;&#x4E24;&#x6B21;&#x76F8;&#x540C;&#x7684;<code class="docutils literal"><span class="pre">Keyword</span></code>&#xFF0C;&#x5B83;&#x5C06;&#x88AB;&#x653E;&#x5165;&#x6570;&#x636E;&#x5E93;&#x4E24;&#x6B21;&#x3002;</span><span class="yiyi-st" id="yiyi-178">&#x8FD9;&#x6709;&#x70B9;&#x4E0D;&#x65B9;&#x4FBF;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-179">&#x8FD9;&#x4E2A;<a class="reference external" href="http://www.sqlalchemy.org/trac/wiki/UsageRecipes/UniqueObject">UniqueObject</a>&#x914D;&#x65B9;&#x662F;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x800C;&#x521B;&#x5EFA;&#x7684;&#x3002;</span></p></div>