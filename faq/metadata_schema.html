<h1><span class="yiyi-st" id="yiyi-39">MetaData / Schema <a class="headerlink" href="#metadata-schema" title="Permalink to this headline">&#xB6;</a></span></h1><div class="contents faq local topic" id="contents"><ul class="simple"><li><span class="yiyi-st" id="yiyi-40"><a class="reference internal" href="#my-program-is-hanging-when-i-say-table-drop-metadata-drop-all" id="id1">&#x5F53;&#x6211;&#x8BF4;<code class="docutils literal"><span class="pre">table.drop()</span></code> / <code class="docutils literal"><span class="pre">metadata.drop_all()</span></code></a>&#x65F6;&#xFF0C;</span></li><li><span class="yiyi-st" id="yiyi-41"><a class="reference internal" href="#does-sqlalchemy-support-alter-table-create-view-create-trigger-schema-upgrade-functionality" id="id2">SQLAlchemy&#x662F;&#x5426;&#x652F;&#x6301;ALTER TABLE&#xFF0C;CREATE VIEW&#xFF0C;CREATE TRIGGER&#xFF0C;&#x67B6;&#x6784;&#x5347;&#x7EA7;&#x529F;&#x80FD;&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-42"><a class="reference internal" href="#how-can-i-sort-table-objects-in-order-of-their-dependency" id="id3">&#x6211;&#x5982;&#x4F55;&#x6309;&#x7167;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;&#x7684;&#x987A;&#x5E8F;&#x5BF9;Table&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-43"><a class="reference internal" href="#how-can-i-get-the-create-table-drop-table-output-as-a-string" id="id4">&#x5982;&#x4F55;&#x5C06;CREATE TABLE / DROP TABLE&#x8F93;&#x51FA;&#x4F5C;&#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#xFF1F;</a></span></li><li><span class="yiyi-st" id="yiyi-44"><a class="reference internal" href="#how-can-i-subclass-table-column-to-provide-certain-behaviors-configurations" id="id5">&#x6211;&#x5982;&#x4F55;&#x5B50;&#x7C7B;&#x5316;&#x8868;/&#x5217;&#x6765;&#x63D0;&#x4F9B;&#x67D0;&#x4E9B;&#x884C;&#x4E3A;/&#x914D;&#x7F6E;&#xFF1F;</a></span></li></ul></div><div class="section" id="my-program-is-hanging-when-i-say-table-drop-metadata-drop-all"><h2><span class="yiyi-st" id="yiyi-45">&#x5F53;&#x6211;&#x8BF4;<code class="docutils literal"><span class="pre">table.drop()</span></code> / <code class="docutils literal"><span class="pre">metadata.drop_all()</span></code> <a class="headerlink" href="#my-program-is-hanging-when-i-say-table-drop-metadata-drop-all" title="Permalink to this headline">&#xB6;</a>&#x65F6;&#xFF0C;</span></h2><p><span class="yiyi-st" id="yiyi-46">&#x8FD9;&#x901A;&#x5E38;&#x5BF9;&#x5E94;&#x4E8E;&#x4E24;&#x4E2A;&#x6761;&#x4EF6;&#xFF1A;1.&#x4F7F;&#x7528;&#x5BF9;&#x8868;&#x9501;&#x786E;&#x5B9E;&#x4E25;&#x683C;&#x7684;PostgreSQL&#xFF0C;&#x4EE5;&#x53CA;2.&#x60A8;&#x7684;&#x8FDE;&#x63A5;&#x4ECD;&#x5904;&#x4E8E;&#x6253;&#x5F00;&#x72B6;&#x6001;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x8868;&#x4E2D;&#x7684;&#x9501;&#xFF0C;&#x5E76;&#x4E14;&#x4E0E;&#x7528;&#x4E8E;DROP&#x8BED;&#x53E5;&#x7684;&#x8FDE;&#x63A5;&#x4E0D;&#x540C;&#x3002;</span><span class="yiyi-st" id="yiyi-47">&#x4E0B;&#x9762;&#x662F;&#x6700;&#x5C0F;&#x7248;&#x672C;&#x7684;&#x6A21;&#x5F0F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">mytable</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>

<span class="n">mytable</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-48">&#x4EE5;&#x4E0A;&#xFF0C;&#x8FDE;&#x63A5;&#x6C60;&#x8FDE;&#x63A5;&#x4ECD;&#x88AB;&#x68C0;&#x51FA;&#xFF1B;&#x6B64;&#x5916;&#xFF0C;&#x4E0A;&#x9762;&#x7684;&#x7ED3;&#x679C;&#x5BF9;&#x8C61;&#x8FD8;&#x4FDD;&#x6301;&#x4E0E;&#x6B64;&#x8FDE;&#x63A5;&#x7684;&#x94FE;&#x63A5;&#x3002;</span><span class="yiyi-st" id="yiyi-49">&#x5982;&#x679C;&#x4F7F;&#x7528;&#x201C;&#x9690;&#x5F0F;&#x6267;&#x884C;&#x201D;&#xFF0C;&#x5219;&#x7ED3;&#x679C;&#x5C06;&#x4FDD;&#x6301;&#x6B64;&#x8FDE;&#x63A5;&#x5904;&#x4E8E;&#x6253;&#x5F00;&#x72B6;&#x6001;&#xFF0C;&#x76F4;&#x5230;&#x7ED3;&#x679C;&#x5BF9;&#x8C61;&#x5173;&#x95ED;&#x6216;&#x6240;&#x6709;&#x884C;&#x8017;&#x5C3D;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-50">&#x5BF9;<code class="docutils literal"><span class="pre">mytable.drop(engine)</span></code>&#x7684;&#x8C03;&#x7528;&#x4F1A;&#x5C1D;&#x8BD5;&#x5728;&#x4ECE;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x91C7;&#x8D2D;&#x7684;&#x7B2C;&#x4E8C;&#x4E2A;&#x8FDE;&#x63A5;&#x4E0A;&#x53D1;&#x51FA;DROP TABLE&#xFF0C;&#x8BE5;&#x8FDE;&#x63A5;&#x5C06;&#x88AB;&#x9501;&#x5B9A;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-51">&#x89E3;&#x51B3;&#x65B9;&#x6CD5;&#x662F;&#x5728;&#x53D1;&#x51FA;DROP TABLE&#x4E4B;&#x524D;&#x5173;&#x95ED;&#x6240;&#x6709;&#x8FDE;&#x63A5;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">mytable</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>

<span class="c1"># fully read result sets</span>
<span class="n">result</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

<span class="c1"># close connections</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># now locks are removed</span>
<span class="n">mytable</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span></pre></div></div></div><div class="section" id="does-sqlalchemy-support-alter-table-create-view-create-trigger-schema-upgrade-functionality"><h2><span class="yiyi-st" id="yiyi-52">SQLAlchemy&#x662F;&#x5426;&#x652F;&#x6301;ALTER TABLE&#xFF0C;CREATE VIEW&#xFF0C;CREATE TRIGGER&#xFF0C;&#x67B6;&#x6784;&#x5347;&#x7EA7;&#x529F;&#x80FD;&#xFF1F;<a class="headerlink" href="#does-sqlalchemy-support-alter-table-create-view-create-trigger-schema-upgrade-functionality" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-53">&#x4E00;&#x822C;ALTER&#x652F;&#x6301;&#x4E0D;&#x76F4;&#x63A5;&#x51FA;&#x73B0;&#x5728;SQLAlchemy&#x4E2D;&#x3002;</span><span class="yiyi-st" id="yiyi-54">&#x5BF9;&#x4E8E;&#x7279;&#x6B8A;&#x7684;DDL&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<a class="reference internal" href="core_ddl.html#sqlalchemy.schema.DDL" title="sqlalchemy.schema.DDL"><code class="xref py py-class docutils literal"><span class="pre">DDL</span></code></a>&#x548C;&#x76F8;&#x5173;&#x7684;&#x7ED3;&#x6784;&#x3002;</span><span class="yiyi-st" id="yiyi-55">&#x6709;&#x5173;&#x6B64;&#x4E3B;&#x9898;&#x7684;&#x8BA8;&#x8BBA;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<code class="xref doc docutils literal"><span class="pre">core_ddl</span></code>&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-56">&#x66F4;&#x5168;&#x9762;&#x7684;&#x9009;&#x62E9;&#x662F;&#x4F7F;&#x7528;&#x6A21;&#x5F0F;&#x8FC1;&#x79FB;&#x5DE5;&#x5177;&#xFF0C;&#x4F8B;&#x5982;Alembic&#x6216;SQLAlchemy-Migrate&#xFF1B;&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="core_metadata.html#schema-migrations"><span>Altering Schemas through Migrations</span></a>&#x4EE5;&#x4FBF;&#x8FDB;&#x884C;&#x8BA8;&#x8BBA;&#x3002;</span></p></div><div class="section" id="how-can-i-sort-table-objects-in-order-of-their-dependency"><h2><span class="yiyi-st" id="yiyi-57">&#x6211;&#x5982;&#x4F55;&#x6309;&#x7167;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;&#x7684;&#x987A;&#x5E8F;&#x5BF9;Table&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#xFF1F;<a class="headerlink" href="#how-can-i-sort-table-objects-in-order-of-their-dependency" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-58">&#x8FD9;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<a class="reference internal" href="core_metadata.html#sqlalchemy.schema.MetaData.sorted_tables" title="sqlalchemy.schema.MetaData.sorted_tables"><code class="xref py py-attr docutils literal"><span class="pre">MetaData.sorted_tables</span></code></a>&#x51FD;&#x6570;&#x4F7F;&#x7528;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>metadata = MetaData()
# ... add Table objects to metadata
ti = metadata.sorted_tables:
for t in ti:
    print(t)</pre></div></div></div><div class="section" id="how-can-i-get-the-create-table-drop-table-output-as-a-string"><h2><span class="yiyi-st" id="yiyi-59">&#x6211;&#x600E;&#x6837;&#x624D;&#x80FD;&#x5C06;CREATE TABLE / DROP TABLE&#x8F93;&#x51FA;&#x4F5C;&#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#xFF1F;<a class="headerlink" href="#how-can-i-get-the-create-table-drop-table-output-as-a-string" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-60">&#x73B0;&#x4EE3;SQLAlchemy&#x5177;&#x6709;&#x4EE3;&#x8868;DDL&#x64CD;&#x4F5C;&#x7684;&#x5B50;&#x53E5;&#x7ED3;&#x6784;&#x3002;</span><span class="yiyi-st" id="yiyi-61">&#x8FD9;&#x4E9B;&#x53EF;&#x4EE5;&#x50CF;&#x4EFB;&#x4F55;&#x5176;&#x4ED6;SQL&#x8868;&#x8FBE;&#x5F0F;&#x4E00;&#x6837;&#x5448;&#x73B0;&#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="kn">import</span> <span class="n">CreateTable</span>

<span class="k">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">mytable</span><span class="p">))</span></pre></div></div><p><span class="yiyi-st" id="yiyi-62">&#x8981;&#x83B7;&#x53D6;&#x7279;&#x5B9A;&#x4E8E;&#x67D0;&#x4E2A;&#x5F15;&#x64CE;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">mytable</span><span class="p">)</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">engine</span><span class="p">))</span></pre></div></div><p><span class="yiyi-st" id="yiyi-63">&#x8FD8;&#x6709;&#x4E00;&#x79CD;&#x7279;&#x6B8A;&#x7684;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x5F62;&#x5F0F;&#xFF0C;&#x53EF;&#x4EE5;&#x8BA9;&#x60A8;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x914D;&#x65B9;&#x8F6C;&#x50A8;&#x6574;&#x4E2A;&#x5143;&#x6570;&#x636E;&#x521B;&#x5EFA;&#x5E8F;&#x5217;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="o">*</span><span class="n">multiparams</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="p">))</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&apos;postgresql://&apos;</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&apos;mock&apos;</span><span class="p">,</span> <span class="n">executor</span><span class="o">=</span><span class="n">dump</span><span class="p">)</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-64"><a class="reference external" href="https://bitbucket.org/zzzeek/alembic">Alembic</a>&#x5DE5;&#x5177;&#x8FD8;&#x652F;&#x6301;&#x201C;&#x79BB;&#x7EBF;&#x201D;SQL&#x751F;&#x6210;&#x6A21;&#x5F0F;&#xFF0C;&#x53EF;&#x5C06;&#x6570;&#x636E;&#x5E93;&#x8FC1;&#x79FB;&#x5448;&#x73B0;&#x4E3A;SQL&#x811A;&#x672C;&#x3002;</span></p></div><div class="section" id="how-can-i-subclass-table-column-to-provide-certain-behaviors-configurations"><h2><span class="yiyi-st" id="yiyi-65">&#x6211;&#x600E;&#x4E48;&#x53EF;&#x4EE5;&#x7EE7;&#x627F;Table / Column&#x6765;&#x63D0;&#x4F9B;&#x67D0;&#x4E9B;&#x884C;&#x4E3A;/&#x914D;&#x7F6E;&#xFF1F;<a class="headerlink" href="#how-can-i-subclass-table-column-to-provide-certain-behaviors-configurations" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-66"><a class="reference internal" href="core_metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal"><span class="pre">Table</span></code></a>&#x548C;<a class="reference internal" href="core_metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal"><span class="pre">Column</span></code></a>&#x4E0D;&#x9002;&#x5408;&#x76F4;&#x63A5;&#x5B50;&#x7C7B;&#x5316;&#x3002;</span><span class="yiyi-st" id="yiyi-67">&#x4F46;&#x662F;&#xFF0C;&#x6709;&#x4E00;&#x4E9B;&#x7B80;&#x5355;&#x7684;&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x521B;&#x5EFA;&#x51FD;&#x6570;&#x83B7;&#x53D6;&#x6784;&#x5EFA;&#x884C;&#x4E3A;&#xFF0C;&#x4EE5;&#x53CA;&#x4E0E;&#x6A21;&#x5F0F;&#x5BF9;&#x8C61;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x8054;&#x6709;&#x5173;&#x7684;&#x884C;&#x4E3A;&#xFF0C;&#x4F8B;&#x5982;&#x7EA6;&#x675F;&#x7EA6;&#x5B9A;&#x6216;&#x4F7F;&#x7528;&#x9644;&#x4EF6;&#x4E8B;&#x4EF6;&#x7684;&#x547D;&#x540D;&#x7EA6;&#x5B9A;&#x3002;</span><span class="yiyi-st" id="yiyi-68">&#x5728;<a class="reference external" href="http://www.sqlalchemy.org/trac/wiki/UsageRecipes/NamingConventions">&#x547D;&#x540D;&#x7EA6;&#x5B9A;</a>&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8BB8;&#x591A;&#x8FD9;&#x4E9B;&#x6280;&#x672F;&#x7684;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#x3002;</span></p></div>