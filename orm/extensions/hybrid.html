<h1><span class="yiyi-st" id="yiyi-55">&#x6DF7;&#x5408;&#x5C5E;&#x6027;<a class="headerlink" href="#module-sqlalchemy.ext.hybrid" title="Permalink to this headline">&#xB6;</a></span></h1><p><span class="yiyi-st" id="yiyi-56">&#x5728;&#x5177;&#x6709;&#x201C;&#x6DF7;&#x5408;&#x201D;&#x884C;&#x4E3A;&#x7684;ORM&#x6620;&#x5C04;&#x7C7B;&#x4E0A;&#x5B9A;&#x4E49;&#x5C5E;&#x6027;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-57">&#x201C;&#x6DF7;&#x5408;&#x201D;&#x610F;&#x5473;&#x7740;&#x5C5E;&#x6027;&#x5728;&#x7C7B;&#x7EA7;&#x548C;&#x5B9E;&#x4F8B;&#x7EA7;&#x5B9A;&#x4E49;&#x4E86;&#x4E0D;&#x540C;&#x7684;&#x884C;&#x4E3A;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-58"><a class="reference internal" href="#module-sqlalchemy.ext.hybrid" title="sqlalchemy.ext.hybrid"><code class="xref py py-mod docutils literal"><span class="pre">hybrid</span></code></a>&#x6269;&#x5C55;&#x63D0;&#x4F9B;&#x4E86;&#x7279;&#x6B8A;&#x5F62;&#x5F0F;&#x7684;&#x65B9;&#x6CD5;&#x88C5;&#x9970;&#x5668;&#xFF0C;&#x5927;&#x7EA6;&#x6709;50&#x884C;&#x4EE3;&#x7801;&#xFF0C;&#x5E76;&#x4E14;&#x51E0;&#x4E4E;&#x4E0D;&#x4F9D;&#x8D56;&#x4E8E;SQLAlchemy&#x7684;&#x5176;&#x4F59;&#x90E8;&#x5206;&#x3002;</span><span class="yiyi-st" id="yiyi-59">&#x7406;&#x8BBA;&#x4E0A;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x4E0E;&#x4EFB;&#x4F55;&#x57FA;&#x4E8E;&#x63CF;&#x8FF0;&#x7B26;&#x7684;&#x8868;&#x8FBE;&#x7CFB;&#x7EDF;&#x4E00;&#x8D77;&#x5DE5;&#x4F5C;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-60">&#x8003;&#x8651;&#x6620;&#x5C04;<code class="docutils literal"><span class="pre">Interval</span></code>&#xFF0C;&#x8868;&#x793A;&#x6574;&#x6570;<code class="docutils literal"><span class="pre">start</span></code>&#x548C;<code class="docutils literal"><span class="pre">end</span></code>&#x503C;&#x3002;</span><span class="yiyi-st" id="yiyi-61">&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x6620;&#x5C04;&#x7C7B;&#x4E0A;&#x5B9A;&#x4E49;&#x66F4;&#x9AD8;&#x7EA7;&#x522B;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x4E9B;&#x7C7B;&#x53EF;&#x4EE5;&#x5728;&#x7C7B;&#x7EA7;&#x522B;&#x751F;&#x6210;SQL&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5728;&#x5B9E;&#x4F8B;&#x7EA7;&#x522B;&#x4E0A;&#x8FDB;&#x884C;Python&#x8868;&#x8FBE;&#x5F0F;&#x8BC4;&#x4F30;&#x3002;</span><span class="yiyi-st" id="yiyi-62">&#x4E0B;&#x9762;&#xFF0C;&#x7528;<a class="reference internal" href="#sqlalchemy.ext.hybrid.hybrid_method" title="sqlalchemy.ext.hybrid.hybrid_method"><code class="xref py py-class docutils literal"><span class="pre">hybrid_method</span></code></a>&#x6216;<a class="reference internal" href="#sqlalchemy.ext.hybrid.hybrid_property" title="sqlalchemy.ext.hybrid.hybrid_property"><code class="xref py py-class docutils literal"><span class="pre">hybrid_property</span></code></a>&#x88C5;&#x9970;&#x7684;&#x6BCF;&#x4E2A;&#x51FD;&#x6570;&#x90FD;&#x53EF;&#x4EE5;&#x63A5;&#x6536;<code class="docutils literal"><span class="pre">self</span></code>&#x4F5C;&#x4E3A;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x6216;&#x8005;&#x4F5C;&#x4E3A;&#x7C7B;&#x672C;&#x8EAB;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">aliased</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span><span class="p">,</span> <span class="n">hybrid_method</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Interval</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;interval&apos;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

    <span class="nd">@hybrid_method</span>
    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">point</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">point</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>

    <span class="nd">@hybrid_method</span>
    <span class="k">def</span> <span class="nf">intersects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">end</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-63">&#x4EE5;&#x4E0A;&#xFF0C;<code class="docutils literal"><span class="pre">length</span></code>&#x5C5E;&#x6027;&#x8FD4;&#x56DE;<code class="docutils literal"><span class="pre">end</span></code>&#x548C;<code class="docutils literal"><span class="pre">start</span></code>&#x5C5E;&#x6027;&#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x5F02;&#x3002;</span><span class="yiyi-st" id="yiyi-64">&#x4F7F;&#x7528;<code class="docutils literal"><span class="pre">Interval</span></code>&#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x4F7F;&#x7528;&#x6B63;&#x5E38;&#x7684;Python&#x63CF;&#x8FF0;&#x7B26;&#x673A;&#x5236;&#xFF0C;&#x5728;Python&#x4E2D;&#x8FDB;&#x884C;&#x76F8;&#x51CF;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">i1</span> <span class="o">=</span> <span class="n">Interval</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i1</span><span class="o">.</span><span class="n">length</span>
<span class="go">5</span></pre></div></div><p><span class="yiyi-st" id="yiyi-65">&#x5F53;&#x5904;&#x7406;<code class="docutils literal"><span class="pre">Interval</span></code>&#x7C7B;&#x672C;&#x8EAB;&#x65F6;&#xFF0C;<a class="reference internal" href="#sqlalchemy.ext.hybrid.hybrid_property" title="sqlalchemy.ext.hybrid.hybrid_property"><code class="xref py py-class docutils literal"><span class="pre">hybrid_property</span></code></a>&#x63CF;&#x8FF0;&#x7B26;&#x5C06;&#x7ED9;&#x5B9A;<code class="docutils literal"><span class="pre">Interval</span></code>&#x7C7B;&#x7684;&#x51FD;&#x6570;&#x4F53;&#x8BC4;&#x4F30;&#x4E3A;&#x53C2;&#x6570;&#xFF0C;&#x5F53;&#x4F7F;&#x7528;SQLAlchemy&#x8868;&#x8FBE;&#x5F0F;&#x673A;&#x5236;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x65B0;&#x7684;SQL&#x8868;&#x8FBE;&#x5F0F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">Interval</span><span class="o">.</span><span class="n">length</span>
<span class="go">interval.&quot;end&quot; - interval.start</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Interval</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Interval</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
<span class="go">SELECT interval.id AS interval_id, interval.start AS interval_start,</span>
<span class="go">interval.&quot;end&quot; AS interval_end</span>
<span class="go">FROM interval</span>
<span class="go">WHERE interval.&quot;end&quot; - interval.start &gt; :param_1</span></pre></div></div><p><span class="yiyi-st" id="yiyi-66">ORM methods such as <a class="reference internal" href="query.html#sqlalchemy.orm.query.Query.filter_by" title="sqlalchemy.orm.query.Query.filter_by"><code class="xref py py-meth docutils literal"><span class="pre">filter_by()</span></code></a> generally use <code class="docutils literal"><span class="pre">getattr()</span></code> to locate attributes, so can also be used with hybrid attributes:</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Interval</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="go">SELECT interval.id AS interval_id, interval.start AS interval_start,</span>
<span class="go">interval.&quot;end&quot; AS interval_end</span>
<span class="go">FROM interval</span>
<span class="go">WHERE interval.&quot;end&quot; - interval.start = :param_1</span></pre></div></div><p><span class="yiyi-st" id="yiyi-67"><code class="docutils literal"><span class="pre">Interval</span></code>&#x7C7B;&#x793A;&#x4F8B;&#x8FD8;&#x6F14;&#x793A;&#x4E86;<code class="docutils literal"><span class="pre">contains()</span></code>&#x548C;<code class="docutils literal"><span class="pre">intersects()</span></code>&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#xFF0C;&#x7528;<a class="reference internal" href="#sqlalchemy.ext.hybrid.hybrid_method" title="sqlalchemy.ext.hybrid.hybrid_method"><code class="xref py py-class docutils literal"><span class="pre">hybrid_method</span></code></a>&#x4FEE;&#x9970;&#x3002;</span><span class="yiyi-st" id="yiyi-68">&#x8BE5;&#x88C5;&#x9970;&#x5668;&#x5C06;&#x76F8;&#x540C;&#x7684;&#x60F3;&#x6CD5;&#x5E94;&#x7528;&#x4E8E;<a class="reference internal" href="#sqlalchemy.ext.hybrid.hybrid_property" title="sqlalchemy.ext.hybrid.hybrid_property"><code class="xref py py-class docutils literal"><span class="pre">hybrid_property</span></code></a>&#x5E94;&#x7528;&#x4E8E;&#x5C5E;&#x6027;&#x7684;&#x65B9;&#x6CD5;&#x3002;</span><span class="yiyi-st" id="yiyi-69">&#x8FD9;&#x4E9B;&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x5E03;&#x5C14;&#x503C;&#xFF0C;&#x5E76;&#x5229;&#x7528;Python <code class="docutils literal"><span class="pre">|</span></code>&#x548C;<code class="docutils literal"><span class="pre">&amp;</span></code>&#x4F4D;&#x8FD0;&#x7B97;&#x7B26;&#x6765;&#x4EA7;&#x751F;&#x7B49;&#x6548;&#x7684;&#x5B9E;&#x4F8B;&#x7EA7;&#x548C;SQL&#x8868;&#x8FBE;&#x5F0F;&#x7EA7;&#x5E03;&#x5C14;&#x884C;&#x4E3A;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">i1</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i1</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i1</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">Interval</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i1</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">Interval</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">29</span><span class="p">))</span>
<span class="go">False</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Interval</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Interval</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
<span class="go">SELECT interval.id AS interval_id, interval.start AS interval_start,</span>
<span class="go">interval.&quot;end&quot; AS interval_end</span>
<span class="go">FROM interval</span>
<span class="go">WHERE interval.start &lt;= :start_1 AND interval.&quot;end&quot; &gt; :end_1</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">ia</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Interval</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Interval</span><span class="p">,</span> <span class="n">ia</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Interval</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">ia</span><span class="p">))</span>
<span class="go">SELECT interval.id AS interval_id, interval.start AS interval_start,</span>
<span class="go">interval.&quot;end&quot; AS interval_end, interval_1.id AS interval_1_id,</span>
<span class="go">interval_1.start AS interval_1_start, interval_1.&quot;end&quot; AS interval_1_end</span>
<span class="go">FROM interval, interval AS interval_1</span>
<span class="go">WHERE interval.start &lt;= interval_1.start</span>
<span class="go">    AND interval.&quot;end&quot; &gt; interval_1.start</span>
<span class="go">    OR interval.start &lt;= interval_1.&quot;end&quot;</span>
<span class="go">    AND interval.&quot;end&quot; &gt; interval_1.&quot;end&quot;</span></pre></div></div><div class="section" id="defining-expression-behavior-distinct-from-attribute-behavior"><h2><span class="yiyi-st" id="yiyi-70">&#x5B9A;&#x4E49;&#x4E0E;&#x5C5E;&#x6027;&#x884C;&#x4E3A;&#x4E0D;&#x540C;&#x7684;&#x8868;&#x8FBE;&#x884C;&#x4E3A;<a class="headerlink" href="#defining-expression-behavior-distinct-from-attribute-behavior" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-71">&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x4E0A;&#x9762;&#x7684;<code class="docutils literal"><span class="pre">&amp;</span></code>&#x548C;<code class="docutils literal"><span class="pre">|</span></code>&#x4F4D;&#x8FD0;&#x7B97;&#x7B26;&#x662F;&#x5E78;&#x8FD0;&#x7684;&#xFF0C;&#x8003;&#x8651;&#x5230;&#x6211;&#x4EEC;&#x7684;&#x51FD;&#x6570;&#x5BF9;&#x4E24;&#x4E2A;&#x5E03;&#x5C14;&#x503C;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#x4EE5;&#x8FD4;&#x56DE;&#x65B0;&#x51FD;&#x6570;&#x3002;</span><span class="yiyi-st" id="yiyi-72">&#x5728;&#x8BB8;&#x591A;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;Python&#x5185;&#x51FD;&#x6570;&#x548C;SQLAlchemy SQL&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x6784;&#x9020;&#x6709;&#x8DB3;&#x591F;&#x7684;&#x533A;&#x522B;&#xFF0C;&#x5E94;&#x8BE5;&#x5B9A;&#x4E49;&#x4E24;&#x4E2A;&#x5355;&#x72EC;&#x7684;Python&#x8868;&#x8FBE;&#x5F0F;&#x3002;</span><span class="yiyi-st" id="yiyi-73"><a class="reference internal" href="#module-sqlalchemy.ext.hybrid" title="sqlalchemy.ext.hybrid"><code class="xref py py-mod docutils literal"><span class="pre">hybrid</span></code></a>&#x88C5;&#x9970;&#x5668;&#x4E3A;&#x6B64;&#x5B9A;&#x4E49;&#x4E86;<a class="reference internal" href="#sqlalchemy.ext.hybrid.hybrid_property.expression" title="sqlalchemy.ext.hybrid.hybrid_property.expression"><code class="xref py py-meth docutils literal"><span class="pre">hybrid_property.expression()</span></code></a>&#x4FEE;&#x9970;&#x7B26;&#x3002;</span><span class="yiyi-st" id="yiyi-74">&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x5B9A;&#x4E49;&#x95F4;&#x9694;&#x7684;&#x534A;&#x5F84;&#xFF0C;&#x8FD9;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x7EDD;&#x5BF9;&#x503C;&#x51FD;&#x6570;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>

<span class="k">class</span> <span class="nc">Interval</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="nd">@radius.expression</span>
    <span class="k">def</span> <span class="nf">radius</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span></pre></div></div><p><span class="yiyi-st" id="yiyi-75">Python&#x51FD;&#x6570;<code class="docutils literal"><span class="pre">abs()</span></code>&#x7528;&#x4E8E;&#x5B9E;&#x4F8B;&#x7EA7;&#x64CD;&#x4F5C;&#xFF0C;SQL&#x51FD;&#x6570;<code class="docutils literal"><span class="pre">ABS()</span></code>&#x901A;&#x8FC7;<a class="reference internal" href="core_sqlelement.html#sqlalchemy.sql.expression.func" title="sqlalchemy.sql.expression.func"><code class="xref py py-data docutils literal"><span class="pre">func</span></code></a>&#x5BF9;&#x8C61;&#x7528;&#x4E8E;&#x7C7B;&#x7EA7;&#x8868;&#x8FBE;&#x5F0F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">i1</span><span class="o">.</span><span class="n">radius</span>
<span class="go">2</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Interval</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Interval</span><span class="o">.</span><span class="n">radius</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
<span class="go">SELECT interval.id AS interval_id, interval.start AS interval_start,</span>
<span class="go">    interval.&quot;end&quot; AS interval_end</span>
<span class="go">FROM interval</span>
<span class="go">WHERE abs(interval.&quot;end&quot; - interval.start) / :abs_1 &gt; :param_1</span></pre></div></div></div><div class="section" id="defining-setters"><h2><span class="yiyi-st" id="yiyi-76">&#x5B9A;&#x4E49;Setters <a class="headerlink" href="#defining-setters" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-77">&#x6DF7;&#x5408;&#x5C5E;&#x6027;&#x4E5F;&#x53EF;&#x4EE5;&#x5B9A;&#x4E49;setter&#x65B9;&#x6CD5;&#x3002;</span><span class="yiyi-st" id="yiyi-78">&#x5982;&#x679C;&#x6211;&#x4EEC;&#x60F3;&#x5728;&#x4E0A;&#x9762;&#x8BBE;&#x7F6E;<code class="docutils literal"><span class="pre">length</span></code>&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x4FEE;&#x6539;&#x7AEF;&#x70B9;&#x503C;&#x65F6;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Interval</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

    <span class="nd">@length.setter</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">value</span></pre></div></div><p><span class="yiyi-st" id="yiyi-79">&#x73B0;&#x5728;&#x5728;set&#x4E2D;&#x8C03;&#x7528;<code class="docutils literal"><span class="pre">&#x957F;&#x5EA6;&#xFF08;self&#xFF0C;</span> <span class="pre">value&#xFF09;</span></code>&#x65B9;&#x6CD5;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">i1</span> <span class="o">=</span> <span class="n">Interval</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i1</span><span class="o">.</span><span class="n">length</span>
<span class="go">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i1</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">12</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i1</span><span class="o">.</span><span class="n">end</span>
<span class="go">17</span></pre></div></div></div><div class="section" id="working-with-relationships"><h2><span class="yiyi-st" id="yiyi-80">&#x5904;&#x7406;&#x5173;&#x7CFB;<a class="headerlink" href="#working-with-relationships" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-81">&#x521B;&#x5EFA;&#x4E0E;&#x76F8;&#x5173;&#x5BF9;&#x8C61;&#xFF08;&#x800C;&#x4E0D;&#x662F;&#x57FA;&#x4E8E;&#x5217;&#x7684;&#x6570;&#x636E;&#xFF09;&#x76F8;&#x7ED3;&#x5408;&#x7684;&#x6DF7;&#x5408;&#x4F53;&#x65F6;&#xFF0C;&#x6CA1;&#x6709;&#x672C;&#x8D28;&#x533A;&#x522B;&#x3002;</span><span class="yiyi-st" id="yiyi-82">&#x5BF9;&#x4E0D;&#x540C;&#x8868;&#x60C5;&#x7684;&#x9700;&#x6C42;&#x5F80;&#x5F80;&#x66F4;&#x5927;&#x3002;</span><span class="yiyi-st" id="yiyi-83">&#x6211;&#x4EEC;&#x5C06;&#x8981;&#x8BF4;&#x660E;&#x7684;&#x4E24;&#x4E2A;&#x53D8;&#x4F53;&#x662F;&#x201C;&#x8FDE;&#x63A5;&#x4F9D;&#x8D56;&#x201D;&#x6DF7;&#x5408;&#x4F53;&#x548C;&#x201C;&#x76F8;&#x5173;&#x5B50;&#x67E5;&#x8BE2;&#x201D;&#x6DF7;&#x5408;&#x4F53;&#x3002;</span></p><div class="section" id="join-dependent-relationship-hybrid"><h3><span class="yiyi-st" id="yiyi-84">&#x52A0;&#x5165; - &#x4ECE;&#x5C5E;&#x5173;&#x7CFB;&#x6DF7;&#x5408;<a class="headerlink" href="#join-dependent-relationship-hybrid" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-85">&#x8003;&#x8651;&#x4EE5;&#x4E0B;&#x5C06;<code class="docutils literal"><span class="pre">User</span></code>&#x4E0E;<code class="docutils literal"><span class="pre">SavingsAccount</span></code>&#x5173;&#x8054;&#x7684;&#x58F0;&#x660E;&#x6027;&#x6620;&#x5C04;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">SavingsAccount</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;account&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&apos;user.id&apos;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">balance</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Numeric</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;user&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">accounts</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;SavingsAccount&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;owner&quot;</span><span class="p">)</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">accounts</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">balance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@balance.setter</span>
    <span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accounts</span><span class="p">:</span>
            <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">account</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@balance.expression</span>
    <span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SavingsAccount</span><span class="o">.</span><span class="n">balance</span></pre></div></div><p><span class="yiyi-st" id="yiyi-86">&#x4E0A;&#x8FF0;&#x6DF7;&#x5408;&#x5C5E;&#x6027;<code class="docutils literal"><span class="pre">balance</span></code>&#x4E0E;&#x6B64;&#x7528;&#x6237;&#x7684;&#x5E10;&#x6237;&#x5217;&#x8868;&#x4E2D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;<code class="docutils literal"><span class="pre">SavingsAccount</span></code>&#x6761;&#x76EE;&#x914D;&#x5408;&#x4F7F;&#x7528;&#x3002;</span><span class="yiyi-st" id="yiyi-87">Python&#x4E2D;&#x7684;getter / setter&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x5C06;<code class="docutils literal"><span class="pre">accounts</span></code>&#x89C6;&#x4E3A;<code class="docutils literal"><span class="pre">self</span></code>&#x4E0A;&#x53EF;&#x7528;&#x7684;Python&#x5217;&#x8868;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-88">&#x4F46;&#x662F;&#xFF0C;&#x5728;&#x8868;&#x8FBE;&#x7EA7;&#x522B;&#x4E0A;&#xFF0C;&#x9884;&#x8BA1;<code class="docutils literal"><span class="pre">User</span></code>&#x7C7B;&#x5C06;&#x5728;&#x9002;&#x5F53;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x4F7F;&#x7528;&#xFF0C;&#x4EE5;&#x4FBF;&#x5B58;&#x5728;&#x5BF9;<code class="docutils literal"><span class="pre">SavingsAccount</span></code>&#x7684;&#x9002;&#x5F53;&#x8FDE;&#x63A5;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">balance</span><span class="p">)</span><span class="o">.</span>\
<span class="gp">... </span>    <span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">accounts</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span>
<span class="go">SELECT &quot;user&quot;.id AS user_id, &quot;user&quot;.name AS user_name,</span>
<span class="go">account.balance AS account_balance</span>
<span class="go">FROM &quot;user&quot; JOIN account ON &quot;user&quot;.id = account.user_id</span>
<span class="go">WHERE account.balance &gt; :balance_1</span></pre></div></div><p><span class="yiyi-st" id="yiyi-89">&#x4F46;&#x662F;&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x867D;&#x7136;&#x5B9E;&#x4F8B;&#x7EA7;&#x8BBF;&#x95EE;&#x5668;&#x9700;&#x8981;&#x62C5;&#x5FC3;&#x662F;&#x5426;&#x5B58;&#x5728;<code class="docutils literal"><span class="pre">self.accounts</span></code>&#xFF0C;&#x4F46;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x5728;SQL&#x8868;&#x8FBE;&#x5F0F;&#x7EA7;&#x522B;&#x8868;&#x8FBE;&#x4E0D;&#x540C;&#xFF0C;&#x6211;&#x4EEC;&#x57FA;&#x672C;&#x4E0A;&#x4F1A;&#x4F7F;&#x7528;&#x5916;&#x8FDE;&#x63A5;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">or_</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="p">(</span><span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">balance</span><span class="p">)</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">accounts</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>        <span class="nb">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">balance</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)))</span>
<span class="go">SELECT &quot;user&quot;.id AS user_id, &quot;user&quot;.name AS user_name,</span>
<span class="go">account.balance AS account_balance</span>
<span class="go">FROM &quot;user&quot; LEFT OUTER JOIN account ON &quot;user&quot;.id = account.user_id</span>
<span class="go">WHERE account.balance &lt;  :balance_1 OR account.balance IS NULL</span></pre></div></div></div><div class="section" id="correlated-subquery-relationship-hybrid"><h3><span class="yiyi-st" id="yiyi-90">&#x76F8;&#x5173;&#x5B50;&#x67E5;&#x8BE2;&#x5173;&#x7CFB;&#x6DF7;&#x5408;<a class="headerlink" href="#correlated-subquery-relationship-hybrid" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-91">&#x5F53;&#x7136;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x653E;&#x5F03;&#x4F9D;&#x8D56;&#x5C01;&#x95ED;&#x67E5;&#x8BE2;&#x7684;&#x8FDE;&#x63A5;&#x7528;&#x6CD5;&#xFF0C;&#x800C;&#x652F;&#x6301;&#x76F8;&#x5173;&#x7684;&#x5B50;&#x67E5;&#x8BE2;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x88AB;&#x79FB;&#x690D;&#x5230;&#x5355;&#x4E2A;&#x5217;&#x8868;&#x8FBE;&#x5F0F;&#x4E2D;&#x3002;</span><span class="yiyi-st" id="yiyi-92">&#x76F8;&#x5173;&#x7684;&#x5B50;&#x67E5;&#x8BE2;&#x66F4;&#x5177;&#x53EF;&#x79FB;&#x690D;&#x6027;&#xFF0C;&#x4F46;&#x901A;&#x5E38;&#x5728;SQL&#x7EA7;&#x522B;&#x6267;&#x884C;&#x5F97;&#x66F4;&#x5DEE;&#x3002;</span><span class="yiyi-st" id="yiyi-93">&#x4F7F;&#x7528;&#x5728;<a class="reference internal" href="mapped_sql_expr.html#mapper-column-property-sql-expressions"><span>Using column_property</span></a>&#x4E2D;&#x8BF4;&#x660E;&#x7684;&#x76F8;&#x540C;&#x6280;&#x672F;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8C03;&#x6574;&#x6211;&#x4EEC;&#x7684;<code class="docutils literal"><span class="pre">SavingsAccount</span></code>&#x793A;&#x4F8B;&#x4EE5;&#x6C47;&#x603B;<em>&#x6240;&#x6709;</em>&#x4E2A;&#x5E10;&#x6237;&#x7684;&#x4F59;&#x989D;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;&#x76F8;&#x5173;&#x5B50;&#x67E5;&#x8BE2;&#x5217;&#x8868;&#x8FBE;&#x5F0F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">func</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">SavingsAccount</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;account&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&apos;user.id&apos;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">balance</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Numeric</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;user&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">accounts</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;SavingsAccount&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;owner&quot;</span><span class="p">)</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">acc</span><span class="o">.</span><span class="n">balance</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accounts</span><span class="p">)</span>

    <span class="nd">@balance.expression</span>
    <span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">select</span><span class="p">([</span><span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">SavingsAccount</span><span class="o">.</span><span class="n">balance</span><span class="p">)])</span><span class="o">.</span>\
                <span class="n">where</span><span class="p">(</span><span class="n">SavingsAccount</span><span class="o">.</span><span class="n">user_id</span><span class="o">==</span><span class="n">cls</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span>\
                <span class="n">label</span><span class="p">(</span><span class="s1">&apos;total_balance&apos;</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-94">&#x4E0A;&#x9762;&#x7684;&#x914D;&#x65B9;&#x4F1A;&#x7ED9;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x76F8;&#x5173;&#x7684;SELECT&#x7684;<code class="docutils literal"><span class="pre">balance</span></code>&#x5217;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">)</span>
<span class="go">SELECT &quot;user&quot;.id AS user_id, &quot;user&quot;.name AS user_name</span>
<span class="go">FROM &quot;user&quot;</span>
<span class="go">WHERE (SELECT sum(account.balance) AS sum_1</span>
<span class="go">FROM account</span>
<span class="go">WHERE account.user_id = &quot;user&quot;.id) &gt; :param_1</span></pre></div></div></div></div><div class="section" id="building-custom-comparators"><h2><span class="yiyi-st" id="yiyi-95">&#x6784;&#x5EFA;&#x81EA;&#x5B9A;&#x4E49;&#x6BD4;&#x8F83;&#x5668;<a class="headerlink" href="#building-custom-comparators" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-96">&#x6DF7;&#x5408;&#x8D22;&#x4EA7;&#x8FD8;&#x5305;&#x62EC;&#x5141;&#x8BB8;&#x5EFA;&#x9020;&#x5B9A;&#x5236;&#x6BD4;&#x8F83;&#x5668;&#x7684;&#x5E2E;&#x624B;&#x3002;</span><span class="yiyi-st" id="yiyi-97">&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x5668;&#x5BF9;&#x8C61;&#x5141;&#x8BB8;&#x60A8;&#x81EA;&#x5B9A;&#x4E49;&#x6BCF;&#x4E2A;SQLAlchemy&#x8868;&#x8FBE;&#x5F0F;&#x8FD0;&#x7B97;&#x7B26;&#x7684;&#x884C;&#x4E3A;&#x3002;</span><span class="yiyi-st" id="yiyi-98">&#x5F53;&#x521B;&#x5EFA;&#x5728;SQL&#x7AEF;&#x5177;&#x6709;&#x4E00;&#x4E9B;&#x9AD8;&#x5EA6;&#x7279;&#x5F02;&#x6027;&#x884C;&#x4E3A;&#x7684;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x65F6;&#xFF0C;&#x5B83;&#x4EEC;&#x975E;&#x5E38;&#x6709;&#x7528;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-99">&#x4E0B;&#x9762;&#x7684;&#x793A;&#x4F8B;&#x7C7B;&#x5141;&#x8BB8;&#x5BF9;&#x540D;&#x4E3A;<code class="docutils literal"><span class="pre">word_insensitive</span></code>&#x7684;&#x5C5E;&#x6027;&#x8FDB;&#x884C;&#x4E0D;&#x533A;&#x5206;&#x5927;&#x5C0F;&#x5199;&#x7684;&#x6BD4;&#x8F83;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">Comparator</span><span class="p">,</span> <span class="n">hybrid_property</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">CaseInsensitiveComparator</span><span class="p">(</span><span class="n">Comparator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">())</span> <span class="o">==</span> <span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SearchWord</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;searchword&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">word</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">word_insensitive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="nd">@word_insensitive.comparator</span>
    <span class="k">def</span> <span class="nf">word_insensitive</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CaseInsensitiveComparator</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">word</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-100">&#x4EE5;&#x4E0A;&#xFF0C;&#x9488;&#x5BF9;<code class="docutils literal"><span class="pre">word_insensitive</span></code>&#x7684;SQL&#x8868;&#x8FBE;&#x5F0F;&#x4F1A;&#x5C06;<code class="docutils literal"><span class="pre">LOWER()</span></code> SQL&#x51FD;&#x6570;&#x5E94;&#x7528;&#x4E8E;&#x53CC;&#x65B9;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">SearchWord</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">word_insensitive</span><span class="o">=</span><span class="s2">&quot;Trucks&quot;</span><span class="p">)</span>
<span class="go">SELECT searchword.id AS searchword_id, searchword.word AS searchword_word</span>
<span class="go">FROM searchword</span>
<span class="go">WHERE lower(searchword.word) = lower(:lower_1)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-101">&#x4E0A;&#x9762;&#x7684;<code class="docutils literal"><span class="pre">CaseInsensitiveComparator</span></code>&#x5B9E;&#x73B0;&#x4E86;<a class="reference internal" href="core_sqlelement.html#sqlalchemy.sql.operators.ColumnOperators" title="sqlalchemy.sql.operators.ColumnOperators"><code class="xref py py-class docutils literal"><span class="pre">ColumnOperators</span></code></a>&#x63A5;&#x53E3;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x3002;</span><span class="yiyi-st" id="yiyi-102">&#x53EF;&#x4EE5;&#x5BF9;&#x6240;&#x6709;&#x6BD4;&#x8F83;&#x64CD;&#x4F5C;&#xFF08;&#x5373;&#xFF0C;<code class="docutils literal"><span class="pre">eq</span></code>&#xFF0C;<code class="docutils literal"><span class="pre">lt</span></code>&#xFF0C;<code class="docutils literal"><span class="pre">gt</span></code>&#x7B49;&#xFF09;&#x5E94;&#x7528;&#x201C;&#x5F3A;&#x5236;&#x201D;</span><span class="yiyi-st" id="yiyi-103">&#x4F7F;&#x7528;<a class="reference internal" href="core_sqlelement.html#sqlalchemy.sql.operators.Operators.operate" title="sqlalchemy.sql.operators.Operators.operate"><code class="xref py py-meth docutils literal"><span class="pre">Operators.operate()</span></code></a>&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CaseInsensitiveComparator</span><span class="p">(</span><span class="n">Comparator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()),</span> <span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">other</span><span class="p">))</span></pre></div></div></div><div class="section" id="hybrid-value-objects"><h2><span class="yiyi-st" id="yiyi-104">&#x6DF7;&#x5408;&#x4EF7;&#x503C;&#x5BF9;&#x8C61;<a class="headerlink" href="#hybrid-value-objects" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-105">&#x5728;&#x524D;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x8981;&#x5C06;<code class="docutils literal"><span class="pre">SearchWord</span></code>&#x5B9E;&#x4F8B;&#x7684;<code class="docutils literal"><span class="pre">word_insensitive</span></code>&#x5C5E;&#x6027;&#x4E0E;&#x7EAF;Python&#x5B57;&#x7B26;&#x4E32;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;&#xFF0C;&#x90A3;&#x4E48;&#x7EAF;Python&#x5B57;&#x7B26;&#x4E32;&#x4E0D;&#x4F1A;&#x88AB;&#x5F3A;&#x5236;&#x4E3A;&#x5C0F;&#x5199;&#x5B57;&#x6BCD; - &#x6211;&#x4EEC;&#x6784;&#x5EFA;&#x7684;<code class="docutils literal"><span class="pre">CaseInsensitiveComparator</span></code>&#xFF0C;&#x7531;<code class="docutils literal"><span class="pre">@word_insensitive.comparator</span></code>&#x8FD4;&#x56DE;&#xFF0C;&#x4EC5;&#x9002;&#x7528;&#x4E8E;SQL&#x65B9;&#x9762;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-106">&#x81EA;&#x5B9A;&#x4E49;&#x6BD4;&#x8F83;&#x5668;&#x7684;&#x66F4;&#x5168;&#x9762;&#x7684;&#x5F62;&#x5F0F;&#x662F;&#x6784;&#x9020;<em>&#x6DF7;&#x5408;&#x503C;&#x5BF9;&#x8C61;</em>&#x3002;</span><span class="yiyi-st" id="yiyi-107">&#x8BE5;&#x6280;&#x672F;&#x5C06;&#x76EE;&#x6807;&#x503C;&#x6216;&#x8868;&#x8FBE;&#x5F0F;&#x5E94;&#x7528;&#x4E8E;&#x503C;&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x6240;&#x6709;&#x60C5;&#x51B5;&#x4E0B;&#x7531;&#x8BBF;&#x95EE;&#x5668;&#x8FD4;&#x56DE;&#x503C;&#x5BF9;&#x8C61;&#x3002;</span><span class="yiyi-st" id="yiyi-108">&#x503C;&#x5BF9;&#x8C61;&#x5141;&#x8BB8;&#x63A7;&#x5236;&#x503C;&#x7684;&#x6240;&#x6709;&#x64CD;&#x4F5C;&#x4EE5;&#x53CA;&#x5982;&#x4F55;&#x5904;&#x7406;&#x6BD4;&#x8F83;&#x503C;&#xFF0C;&#x65E0;&#x8BBA;&#x662F;&#x5728;SQL&#x8868;&#x8FBE;&#x5F0F;&#x8FD8;&#x662F;Python&#x503C;&#x65B9;&#x9762;&#x3002;</span><span class="yiyi-st" id="yiyi-109">&#x7528;&#x65B0;&#x7684;<code class="docutils literal"><span class="pre">CaseInsensitiveWord</span></code>&#x7C7B;&#x66FF;&#x6362;&#x4EE5;&#x524D;&#x7684;<code class="docutils literal"><span class="pre">CaseInsensitiveComparator</span></code>&#x7C7B;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CaseInsensitiveWord</span><span class="p">(</span><span class="n">Comparator</span><span class="p">):</span>
    <span class="s2">&quot;Hybrid value representing a lower case representation of a word.&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">CaseInsensitiveWord</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">word</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">CaseInsensitiveWord</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">CaseInsensitiveWord</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">word</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__clause_element__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">word</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">word</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s1">&apos;word&apos;</span>
    <span class="s2">&quot;Label to apply to Query tuple results&quot;</span></pre></div></div><p><span class="yiyi-st" id="yiyi-110">Above, the <code class="docutils literal"><span class="pre">CaseInsensitiveWord</span></code> object represents <code class="docutils literal"><span class="pre">self.word</span></code>, which may be a SQL function, or may be a Python native. </span><span class="yiyi-st" id="yiyi-111">&#x901A;&#x8FC7;&#x91CD;&#x5199;<code class="docutils literal"><span class="pre">operate()</span></code>&#x548C;<code class="docutils literal"><span class="pre">__clause_element__()</span></code>&#x4EE5;&#x6839;&#x636E;<code class="docutils literal"><span class="pre">self.word</span></code>&#x5DE5;&#x4F5C;&#xFF0C;&#x6240;&#x6709;&#x6BD4;&#x8F83;&#x64CD;&#x4F5C;&#x90FD;&#x5C06;&#x9488;&#x5BF9;&#x201C;&#x8F6C;&#x6362;&#x540E;&#x201D; <code class="docutils literal"><span class="pre">word</span></code>&#xFF0C;&#x65E0;&#x8BBA;&#x662F;SQL&#x7AEF;&#x8FD8;&#x662F;Python&#x7AEF;&#x3002;</span><span class="yiyi-st" id="yiyi-112">&#x6211;&#x4EEC;&#x7684;<code class="docutils literal"><span class="pre">SearchWord</span></code>&#x7C7B;&#x73B0;&#x5728;&#x53EF;&#x4EE5;&#x65E0;&#x6761;&#x4EF6;&#x5730;&#x4ECE;&#x5355;&#x4E2A;&#x6DF7;&#x5408;&#x8C03;&#x7528;&#x4E2D;&#x63D0;&#x4F9B;<code class="docutils literal"><span class="pre">CaseInsensitiveWord</span></code>&#x5BF9;&#x8C61;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SearchWord</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;searchword&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">word</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">word_insensitive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CaseInsensitiveWord</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">word</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-113"><code class="docutils literal"><span class="pre">word_insensitive</span></code>&#x5C5E;&#x6027;&#x73B0;&#x5728;&#x666E;&#x904D;&#x5177;&#x6709;&#x4E0D;&#x533A;&#x5206;&#x5927;&#x5C0F;&#x5199;&#x7684;&#x6BD4;&#x8F83;&#x884C;&#x4E3A;&#xFF0C;&#x5305;&#x62EC;SQL&#x8868;&#x8FBE;&#x5F0F;&#x4E0E;Python&#x8868;&#x8FBE;&#x5F0F;&#xFF08;&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;Python&#x503C;&#x5728;&#x6B64;&#x5904;&#x8F6C;&#x6362;&#x4E3A;&#x5C0F;&#x5199;&#xFF09;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">SearchWord</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">word_insensitive</span><span class="o">=</span><span class="s2">&quot;Trucks&quot;</span><span class="p">)</span>
<span class="go">SELECT searchword.id AS searchword_id, searchword.word AS searchword_word</span>
<span class="go">FROM searchword</span>
<span class="go">WHERE lower(searchword.word) = :lower_1</span></pre></div></div><p><span class="yiyi-st" id="yiyi-114">SQL&#x8868;&#x8FBE;&#x5F0F;&#x4E0E;SQL&#x8868;&#x8FBE;&#x5F0F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sw1</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">SearchWord</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sw2</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">SearchWord</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
<span class="gp">... </span>                   <span class="n">sw1</span><span class="o">.</span><span class="n">word_insensitive</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">sw2</span><span class="o">.</span><span class="n">word_insensitive</span><span class="p">)</span><span class="o">.</span>\
<span class="gp">... </span>                       <span class="nb">filter</span><span class="p">(</span>
<span class="gp">... </span>                           <span class="n">sw1</span><span class="o">.</span><span class="n">word_insensitive</span> <span class="o">&gt;</span> <span class="n">sw2</span><span class="o">.</span><span class="n">word_insensitive</span>
<span class="gp">... </span>                       <span class="p">)</span>
<span class="go">SELECT lower(searchword_1.word) AS lower_1,</span>
<span class="go">lower(searchword_2.word) AS lower_2</span>
<span class="go">FROM searchword AS searchword_1, searchword AS searchword_2</span>
<span class="go">WHERE lower(searchword_1.word) &gt; lower(searchword_2.word)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-115">&#x4EC5;Python&#x8868;&#x8FBE;&#x5F0F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ws1</span> <span class="o">=</span> <span class="n">SearchWord</span><span class="p">(</span><span class="n">word</span><span class="o">=</span><span class="s2">&quot;SomeWord&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ws1</span><span class="o">.</span><span class="n">word_insensitive</span> <span class="o">==</span> <span class="s2">&quot;sOmEwOrD&quot;</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ws1</span><span class="o">.</span><span class="n">word_insensitive</span> <span class="o">==</span> <span class="s2">&quot;XOmEwOrX&quot;</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">ws1</span><span class="o">.</span><span class="n">word_insensitive</span>
<span class="go">someword</span></pre></div></div><p><span class="yiyi-st" id="yiyi-116">&#x5BF9;&#x4E8E;&#x4EFB;&#x4F55;&#x53EF;&#x80FD;&#x5177;&#x6709;&#x591A;&#x79CD;&#x8868;&#x793A;&#x5F62;&#x5F0F;&#xFF08;&#x4F8B;&#x5982;&#x65F6;&#x95F4;&#x6233;&#xFF0C;&#x65F6;&#x95F4;&#x5DEE;&#xFF0C;&#x6D4B;&#x91CF;&#x5355;&#x4F4D;&#xFF0C;&#x8D27;&#x5E01;&#x548C;&#x52A0;&#x5BC6;&#x5BC6;&#x7801;&#xFF09;&#x7684;&#x503C;&#xFF0C;&#x201C;&#x6DF7;&#x5408;&#x503C;&#x201D;&#x6A21;&#x5F0F;&#x90FD;&#x975E;&#x5E38;&#x6709;&#x7528;&#x3002;</span></p><div class="admonition seealso"><p class="first admonition-title"><span class="yiyi-st" id="yiyi-117">&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x770B;</span></p><p><span class="yiyi-st" id="yiyi-118"><a class="reference external" href="http://techspot.zzzeek.org/2011/10/21/hybrids-and-value-agnostic-types/">&#x6742;&#x79CD;&#x548C;&#x4EF7;&#x503C;&#x4E0D;&#x53EF;&#x77E5;&#x7C7B;&#x578B;</a>  - &#x5728;techspot.zzzeek.org&#x535A;&#x5BA2;&#x4E0A;</span></p><p class="last"><span class="yiyi-st" id="yiyi-119"><a class="reference external" href="http://techspot.zzzeek.org/2011/10/29/value-agnostic-types-part-ii/">&#x4EF7;&#x503C;&#x4E0D;&#x53EF;&#x77E5;&#x8BBA;&#x7C7B;&#x578B;&#xFF0C;&#x7B2C;&#x4E8C;&#x90E8;&#x5206;</a>  - &#x5728;techspot.zzzeek.org&#x535A;&#x5BA2;&#x4E0A;</span></p></div></div><div class="section" id="building-transformers"><h2><span class="yiyi-st" id="yiyi-120">&#x5EFA;&#x7ACB;&#x53D8;&#x5F62;&#x91D1;&#x521A;<a class="headerlink" href="#building-transformers" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-121">&#x4E00;&#x4E2A;<em>&#x8F6C;&#x6362;&#x5668;</em>&#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x63A5;&#x6536;<a class="reference internal" href="query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal"><span class="pre">Query</span></code></a>&#x5BF9;&#x8C61;&#x5E76;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x65B0;&#x5BF9;&#x8C61;&#x7684;&#x5BF9;&#x8C61;&#x3002;</span><span class="yiyi-st" id="yiyi-122"><a class="reference internal" href="query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal"><span class="pre">Query</span></code></a>&#x5BF9;&#x8C61;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;<a class="reference internal" href="query.html#sqlalchemy.orm.query.Query.with_transformation" title="sqlalchemy.orm.query.Query.with_transformation"><code class="xref py py-meth docutils literal"><span class="pre">with_transformation()</span></code></a>&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x7531;&#x7ED9;&#x5B9A;&#x51FD;&#x6570;&#x8F6C;&#x6362;&#x7684;&#x65B0;&#x7684;<a class="reference internal" href="query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal"><span class="pre">Query</span></code></a>&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-123">&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06;&#x5B83;&#x548C;<a class="reference internal" href="#sqlalchemy.ext.hybrid.Comparator" title="sqlalchemy.ext.hybrid.Comparator"><code class="xref py py-class docutils literal"><span class="pre">Comparator</span></code></a>&#x7C7B;&#x7ED3;&#x5408;&#x8D77;&#x6765;&#xFF0C;&#x751F;&#x6210;&#x4E00;&#x79CD;&#x7C7B;&#x578B;&#x7684;&#x914D;&#x65B9;&#xFF0C;&#x65E2;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x67E5;&#x8BE2;&#x7684;FROM&#x5B50;&#x53E5;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x8FC7;&#x6EE4;&#x6761;&#x4EF6;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-124">&#x8003;&#x8651;&#x4E00;&#x4E2A;&#x6620;&#x5C04;&#x7684;&#x7C7B;<code class="docutils literal"><span class="pre">Node</span></code>&#xFF0C;&#x5B83;&#x5C06;&#x4F7F;&#x7528;&#x90BB;&#x63A5;&#x8868;&#x8FDB;&#x884C;&#x6C47;&#x7F16;&#x6210;&#x4E00;&#x4E2A;&#x5206;&#x5C42;&#x6811;&#x5F62;&#x6A21;&#x5F0F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;node&apos;</span>
    <span class="nb">id</span> <span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&apos;node.id&apos;</span><span class="p">))</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Node&quot;</span><span class="p">,</span> <span class="n">remote_side</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-125">Suppose we wanted to add an accessor <code class="docutils literal"><span class="pre">grandparent</span></code>. </span><span class="yiyi-st" id="yiyi-126">&#x8FD9;&#x5C06;&#x8FD4;&#x56DE;<code class="docutils literal"><span class="pre">Node.parent</span></code>&#x7684;<code class="docutils literal"><span class="pre">parent</span></code>&#x3002;</span><span class="yiyi-st" id="yiyi-127">&#x5F53;&#x6211;&#x4EEC;&#x6709;&#x4E00;&#x4E2A;<code class="docutils literal"><span class="pre">Node</span></code>&#x7684;&#x5B9E;&#x4F8B;&#x65F6;&#xFF0C;&#x8FD9;&#x5F88;&#x7B80;&#x5355;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span>

<span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">grandparent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span></pre></div></div><p><span class="yiyi-st" id="yiyi-128">&#x5BF9;&#x4E8E;&#x8868;&#x8FBE;&#xFF0C;&#x4E8B;&#x60C5;&#x5E76;&#x4E0D;&#x6E05;&#x695A;&#x3002;</span><span class="yiyi-st" id="yiyi-129">We&#x2019;d need to construct a <a class="reference internal" href="query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal"><span class="pre">Query</span></code></a> where we <a class="reference internal" href="query.html#sqlalchemy.orm.query.Query.join" title="sqlalchemy.orm.query.Query.join"><code class="xref py py-meth docutils literal"><span class="pre">join()</span></code></a> twice along <code class="docutils literal"><span class="pre">Node.parent</span></code> to get to the <code class="docutils literal"><span class="pre">grandparent</span></code>. </span><span class="yiyi-st" id="yiyi-130">&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x8F6C;&#x6362;&#x53EF;&#x8C03;&#x7528;&#x5BF9;&#x8C61;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x4E0E;<a class="reference internal" href="#sqlalchemy.ext.hybrid.Comparator" title="sqlalchemy.ext.hybrid.Comparator"><code class="xref py py-class docutils literal"><span class="pre">Comparator</span></code></a>&#x7C7B;&#x7ED3;&#x5408;&#x4F7F;&#x7528;&#x6765;&#x63A5;&#x6536;&#x4EFB;&#x4F55;<a class="reference internal" href="query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal"><span class="pre">Query</span></code></a>&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x4E0E;<code class="docutils literal"><span class="pre">Node.parent</span></code>&#x5C5E;&#x6027;&#xFF0C;&#x5E76;&#x6839;&#x636E;&#x7ED9;&#x5B9A;&#x7684;&#x6807;&#x51C6;&#x8FDB;&#x884C;&#x8FC7;&#x6EE4;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">Comparator</span>

<span class="k">class</span> <span class="nc">GrandparentTransformer</span><span class="p">(</span><span class="n">Comparator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
            <span class="n">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span>
            <span class="n">parent_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">q</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_alias</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span>\
                        <span class="nb">filter</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="n">parent_alias</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">transform</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;node&apos;</span>
    <span class="nb">id</span> <span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&apos;node.id&apos;</span><span class="p">))</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Node&quot;</span><span class="p">,</span> <span class="n">remote_side</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">grandparent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>

    <span class="nd">@grandparent.comparator</span>
    <span class="k">def</span> <span class="nf">grandparent</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GrandparentTransformer</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-131"><code class="docutils literal"><span class="pre">GrandparentTransformer</span></code>&#x8986;&#x76D6;<a class="reference internal" href="#sqlalchemy.ext.hybrid.Comparator" title="sqlalchemy.ext.hybrid.Comparator"><code class="xref py py-class docutils literal"><span class="pre">Comparator</span></code></a>&#x5C42;&#x6B21;&#x7ED3;&#x6784;&#x7684;&#x6838;&#x5FC3;<a class="reference internal" href="core_sqlelement.html#sqlalchemy.sql.operators.Operators.operate" title="sqlalchemy.sql.operators.Operators.operate"><code class="xref py py-meth docutils literal"><span class="pre">Operators.operate()</span></code></a>&#x65B9;&#x6CD5;&#x4EE5;&#x8FD4;&#x56DE;&#x67E5;&#x8BE2;&#x8F6C;&#x6362;&#x53EF;&#x8C03;&#x7528;&#xFF0C;&#x7136;&#x540E;&#x8FD0;&#x884C;&#x5728;&#x7279;&#x5B9A;&#x60C5;&#x51B5;&#x4E0B;&#x7ED9;&#x5B9A;&#x7684;&#x6BD4;&#x8F83;&#x64CD;&#x4F5C;&#x3002;</span><span class="yiyi-st" id="yiyi-132">Such as, in the example above, the <code class="docutils literal"><span class="pre">operate</span></code> method is called, given the <code class="xref py py-attr docutils literal"><span class="pre">Operators.eq</span></code> callable as well as the right side of the comparison <code class="docutils literal"><span class="pre">Node(id=5)</span></code>. </span><span class="yiyi-st" id="yiyi-133">&#x7136;&#x540E;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x51FD;&#x6570;<code class="docutils literal"><span class="pre">transform</span></code>&#xFF0C;&#x5B83;&#x5C06;&#x9996;&#x5148;&#x8F6C;&#x6362;<a class="reference internal" href="query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal"><span class="pre">Query</span></code></a>&#x4EE5;&#x52A0;&#x5165;&#x5230;<code class="docutils literal"><span class="pre">Node.parent</span></code>&#xFF0C;&#x7136;&#x540E;&#x6BD4;&#x8F83;<code class="docutils literal"><span class="pre">parent_alias</span></code> &gt;&#x5728;&#x5DE6;&#x4FA7;&#x548C;&#x53F3;&#x4FA7;&#x4F7F;&#x7528;<code class="xref py py-attr docutils literal"><span class="pre">Operators.eq</span></code>&#xFF0C;&#x4F20;&#x5165;<code class="xref py py-class docutils literal"><span class="pre">Query.filter</span></code>&#xFF1A;</span></p><div class="highlight-pycon+sql"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<a class="sql_link" href="#">sql</a><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span>\
<span class="gp">... </span>       <span class="n">with_transformation</span><span class="p">(</span><span class="n">Node</span><span class="o">.</span><span class="n">grandparent</span><span class="o">==</span><span class="n">Node</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span>\
<span class="gp">... </span>       <span class="nb">all</span><span class="p">()</span>
<div class="popup_sql">SELECT node.id AS node_id, node.parent_id AS node_parent_id
FROM node JOIN node AS node_1 ON node_1.id = node.parent_id
WHERE :param_1 = node_1.parent_id
</div></pre></div></div><p><span class="yiyi-st" id="yiyi-134">&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4ECE;&#x201C;&#x8FC7;&#x6EE4;&#x5668;&#x201D;&#x6B65;&#x9AA4;&#x4E2D;&#x5206;&#x79BB;&#x201C;&#x8FDE;&#x63A5;&#x201D;&#x6B65;&#x9AA4;&#x6765;&#x4FEE;&#x6539;&#x6A21;&#x5F0F;&#xFF0C;&#x4F7F;&#x5176;&#x66F4;&#x52A0;&#x5197;&#x957F;&#x4F46;&#x7075;&#x6D3B;&#x3002;</span><span class="yiyi-st" id="yiyi-135">The tricky part here is ensuring that successive instances of <code class="docutils literal"><span class="pre">GrandparentTransformer</span></code> use the same <a class="reference internal" href="query.html#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal"><span class="pre">AliasedClass</span></code></a> object against <code class="docutils literal"><span class="pre">Node</span></code>. </span><span class="yiyi-st" id="yiyi-136">&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x8BB0;&#x5FC6;&#x65B9;&#x6CD5;&#xFF0C;&#x5C06;&#x4E00;&#x4E2A;<code class="docutils literal"><span class="pre">GrandparentTransformer</span></code>&#x4E0E;&#x6BCF;&#x4E2A;&#x7C7B;&#x5173;&#x8054;&#x8D77;&#x6765;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>

    <span class="c1"># ...</span>

    <span class="nd">@grandparent.comparator</span>
    <span class="k">def</span> <span class="nf">grandparent</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="c1"># memoize a GrandparentTransformer</span>
        <span class="c1"># per class</span>
        <span class="k">if</span> <span class="s1">&apos;_gp&apos;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_gp</span> <span class="o">=</span> <span class="n">GrandparentTransformer</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_gp</span>

<span class="k">class</span> <span class="nc">GrandparentTransformer</span><span class="p">(</span><span class="n">Comparator</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">go</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">q</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_alias</span><span class="p">,</span> <span class="n">Node</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">go</span>

    <span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_alias</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></pre></div></div><div class="highlight-pycon+sql"><div class="highlight"><pre><span></span><a class="sql_link" href="#">sql</a><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span>\
<span class="gp">... </span>           <span class="n">with_transformation</span><span class="p">(</span><span class="n">Node</span><span class="o">.</span><span class="n">grandparent</span><span class="o">.</span><span class="n">join</span><span class="p">)</span><span class="o">.</span>\
<span class="gp">... </span>           <span class="nb">filter</span><span class="p">(</span><span class="n">Node</span><span class="o">.</span><span class="n">grandparent</span><span class="o">==</span><span class="n">Node</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
<div class="popup_sql">SELECT node.id AS node_id, node.parent_id AS node_parent_id
FROM node JOIN node AS node_1 ON node_1.id = node.parent_id
WHERE :param_1 = node_1.parent_id
</div></pre></div></div><p><span class="yiyi-st" id="yiyi-137">&#x201C;&#x53D8;&#x538B;&#x5668;&#x201D;&#x6A21;&#x5F0F;&#x662F;&#x4E00;&#x79CD;&#x5F00;&#x59CB;&#x4F7F;&#x7528;&#x4E00;&#x4E9B;&#x529F;&#x80FD;&#x6027;&#x7F16;&#x7A0B;&#x8303;&#x4F8B;&#x7684;&#x5B9E;&#x9A8C;&#x6A21;&#x5F0F;&#x3002;</span><span class="yiyi-st" id="yiyi-138">&#x867D;&#x7136;&#x5B83;&#x53EA;&#x63A8;&#x8350;&#x7ED9;&#x9AD8;&#x7EA7;&#x548C;/&#x6216;&#x8010;&#x5FC3;&#x7684;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#xFF0C;&#x4F46;&#x5B83;&#x53EF;&#x80FD;&#x6709;&#x5F88;&#x591A;&#x4EE4;&#x4EBA;&#x60CA;&#x5947;&#x7684;&#x4E8B;&#x60C5;&#x53EF;&#x7528;&#x3002;</span></p></div><div class="section" id="api-reference"><h2><span class="yiyi-st" id="yiyi-139">API&#x53C2;&#x8003;<a class="headerlink" href="#api-reference" title="Permalink to this headline">&#xB6;</a></span></h2><dl class="class"><dt id="sqlalchemy.ext.hybrid.hybrid_method"><span class="yiyi-st" id="yiyi-140"> <em class="property">class </em><code class="descclassname">sqlalchemy.ext.hybrid.</code><code class="descname">hybrid_method</code><span class="sig-paren">(</span><em>func</em>, <em>expr=None</em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.ext.hybrid.hybrid_method" title="Permalink to this definition">&#xB6;</a></span></dt><dd><p><span class="yiyi-st" id="yiyi-141">&#x57FA;&#x7840;&#xFF1A;<a class="reference internal" href="internals.html#sqlalchemy.orm.base.InspectionAttrInfo" title="sqlalchemy.orm.base.InspectionAttrInfo"><code class="xref py py-class docutils literal"><span class="pre">sqlalchemy.orm.base.InspectionAttrInfo</span></code></a></span></p><p><span class="yiyi-st" id="yiyi-142">&#x4E00;&#x4E2A;&#x88C5;&#x9970;&#x5668;&#xFF0C;&#x5141;&#x8BB8;&#x5B9A;&#x4E49;&#x5177;&#x6709;&#x5B9E;&#x4F8B;&#x7EA7;&#x548C;&#x7C7B;&#x7EA7;&#x884C;&#x4E3A;&#x7684;Python&#x5BF9;&#x8C61;&#x65B9;&#x6CD5;&#x3002;</span></p><dl class="method"><dt id="sqlalchemy.ext.hybrid.hybrid_method.__init__"><span class="yiyi-st" id="yiyi-143"><code class="descname">__ init __</code> <span class="sig-paren">&#xFF08;</span> <em>func</em>&#xFF0C;<em>expr = None</em> <span class="sig-paren">&#xFF09;</span> <a class="headerlink" href="#sqlalchemy.ext.hybrid.hybrid_method.__init__" title="Permalink to this definition"> t5 &gt;</a></span></dt><dd><p><span class="yiyi-st" id="yiyi-144">&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;<a class="reference internal" href="#sqlalchemy.ext.hybrid.hybrid_method" title="sqlalchemy.ext.hybrid.hybrid_method"><code class="xref py py-class docutils literal"><span class="pre">hybrid_method</span></code></a>&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-145">&#x7528;&#x6CD5;&#x901A;&#x5E38;&#x662F;&#x901A;&#x8FC7;&#x88C5;&#x9970;&#x5668;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_method</span>

<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@hybrid_method</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

    <span class="nd">@value.expression</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">some_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></pre></div></div></dd></dl><dl class="method"><dt id="sqlalchemy.ext.hybrid.hybrid_method.expression"><span class="yiyi-st" id="yiyi-146"><code class="descname">&#x8868;&#x8FBE; T0&gt; <span class="sig-paren">&#xFF08; T1&gt; <em> EXPR  T2&gt; <span class="sig-paren">&#xFF09; T3&gt; <a class="headerlink" href="#sqlalchemy.ext.hybrid.hybrid_method.expression" title="Permalink to this definition">&#xB6; T4&gt;</a></span></em></span></code></span></dt><dd><p><span class="yiyi-st" id="yiyi-147">&#x63D0;&#x4F9B;&#x5B9A;&#x4E49;SQL&#x8868;&#x8FBE;&#x5F0F;&#x751F;&#x6210;&#x65B9;&#x6CD5;&#x7684;&#x4FEE;&#x6539;&#x88C5;&#x9970;&#x5668;&#x3002;</span></p></dd></dl></dd></dl><dl class="class"><dt id="sqlalchemy.ext.hybrid.hybrid_property"><span class="yiyi-st" id="yiyi-148"><em class="property">&#x7C7B; T0&gt; <code class="descclassname"> sqlalchemy.ext.hybrid&#x3002; T1&gt; <code class="descname"> hybrid_property  T2&gt; <span class="sig-paren">&#xFF08; T3&gt; <em> fget  T4&gt;&#xFF0C;<em> FSET = None</em>&#xFF0C;<em>fdel = None</em>&#xFF0C;<em>expr = None</em> <span class="sig-paren">&#xFF09;</span> <a class="headerlink" href="#sqlalchemy.ext.hybrid.hybrid_property" title="Permalink to this definition">&#xB6;</a></em></span></code></code></em></span></dt><dd><p><span class="yiyi-st" id="yiyi-149">&#x57FA;&#x7840;&#xFF1A;<a class="reference internal" href="internals.html#sqlalchemy.orm.base.InspectionAttrInfo" title="sqlalchemy.orm.base.InspectionAttrInfo"><code class="xref py py-class docutils literal"><span class="pre">sqlalchemy.orm.base.InspectionAttrInfo</span></code></a></span></p><p><span class="yiyi-st" id="yiyi-150">&#x4E00;&#x4E2A;&#x88C5;&#x9970;&#x5668;&#xFF0C;&#x5141;&#x8BB8;&#x5B9A;&#x4E49;&#x5177;&#x6709;&#x5B9E;&#x4F8B;&#x7EA7;&#x522B;&#x548C;&#x7C7B;&#x7EA7;&#x522B;&#x884C;&#x4E3A;&#x7684;Python&#x63CF;&#x8FF0;&#x7B26;&#x3002;</span></p><dl class="method"><dt id="sqlalchemy.ext.hybrid.hybrid_property.__init__"><span class="yiyi-st" id="yiyi-151"> <code class="descname">__init__</code><span class="sig-paren">(</span><em>fget</em>, <em>fset=None</em>, <em>fdel=None</em>, <em>expr=None</em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.ext.hybrid.hybrid_property.__init__" title="Permalink to this definition">&#xB6;</a></span></dt><dd><p><span class="yiyi-st" id="yiyi-152">&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;<a class="reference internal" href="#sqlalchemy.ext.hybrid.hybrid_property" title="sqlalchemy.ext.hybrid.hybrid_property"><code class="xref py py-class docutils literal"><span class="pre">hybrid_property</span></code></a>&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-153">&#x7528;&#x6CD5;&#x901A;&#x5E38;&#x662F;&#x901A;&#x8FC7;&#x88C5;&#x9970;&#x5668;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span>

<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="nd">@value.setter</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span></pre></div></div></dd></dl><dl class="method"><dt id="sqlalchemy.ext.hybrid.hybrid_property.comparator"><span class="yiyi-st" id="yiyi-154"><code class="descname">&#x6BD4;&#x8F83; T0&gt; <span class="sig-paren">&#xFF08; T1&gt; <em>&#x6BD4;&#x8F83; T2&gt; <span class="sig-paren">&#xFF09; T3&gt; <a class="headerlink" href="#sqlalchemy.ext.hybrid.hybrid_property.comparator" title="Permalink to this definition">&#xB6; T4&gt;</a></span></em></span></code></span></dt><dd><p><span class="yiyi-st" id="yiyi-155">&#x63D0;&#x4F9B;&#x5B9A;&#x4E49;&#x81EA;&#x5B9A;&#x4E49;&#x6BD4;&#x8F83;&#x5668;&#x751F;&#x6210;&#x65B9;&#x6CD5;&#x7684;&#x4FEE;&#x6539;&#x88C5;&#x9970;&#x5668;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-156">&#x88C5;&#x9970;&#x65B9;&#x6CD5;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x5E94;&#x8BE5;&#x662F;<a class="reference internal" href="#sqlalchemy.ext.hybrid.Comparator" title="sqlalchemy.ext.hybrid.Comparator"><code class="xref py py-class docutils literal"><span class="pre">Comparator</span></code></a>&#x7684;&#x4E00;&#x4E2A;&#x5B9E;&#x4F8B;&#x3002;</span></p></dd></dl><dl class="method"><dt id="sqlalchemy.ext.hybrid.hybrid_property.deleter"><span class="yiyi-st" id="yiyi-157"><code class="descname">&#x5220;&#x9664;&#x5668; T0&gt; <span class="sig-paren">&#xFF08; T1&gt; <em> FDEL  T2&gt; <span class="sig-paren">&#xFF09; T3&gt; <a class="headerlink" href="#sqlalchemy.ext.hybrid.hybrid_property.deleter" title="Permalink to this definition">&#xB6; T4&gt;</a></span></em></span></code></span></dt><dd><p><span class="yiyi-st" id="yiyi-158">&#x63D0;&#x4F9B;&#x5B9A;&#x4E49;&#x503C;&#x5220;&#x9664;&#x65B9;&#x6CD5;&#x7684;&#x4FEE;&#x6539;&#x88C5;&#x9970;&#x5668;&#x3002;</span></p></dd></dl><dl class="method"><dt id="sqlalchemy.ext.hybrid.hybrid_property.expression"><span class="yiyi-st" id="yiyi-159"><code class="descname">&#x8868;&#x8FBE; T0&gt; <span class="sig-paren">&#xFF08; T1&gt; <em> EXPR  T2&gt; <span class="sig-paren">&#xFF09; T3&gt; <a class="headerlink" href="#sqlalchemy.ext.hybrid.hybrid_property.expression" title="Permalink to this definition">&#xB6; T4&gt;</a></span></em></span></code></span></dt><dd><p><span class="yiyi-st" id="yiyi-160">&#x63D0;&#x4F9B;&#x5B9A;&#x4E49;SQL&#x8868;&#x8FBE;&#x5F0F;&#x751F;&#x6210;&#x65B9;&#x6CD5;&#x7684;&#x4FEE;&#x6539;&#x88C5;&#x9970;&#x5668;&#x3002;</span></p></dd></dl><dl class="method"><dt id="sqlalchemy.ext.hybrid.hybrid_property.setter"><span class="yiyi-st" id="yiyi-161"><code class="descname">&#x8BBE;&#x5B9A;&#x5668; T0&gt; <span class="sig-paren">&#xFF08; T1&gt; <em> FSET  T2&gt; <span class="sig-paren">&#xFF09; T3&gt; <a class="headerlink" href="#sqlalchemy.ext.hybrid.hybrid_property.setter" title="Permalink to this definition">&#xB6; T4&gt;</a></span></em></span></code></span></dt><dd><p><span class="yiyi-st" id="yiyi-162">&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x5B9A;&#x4E49;&#x503C;&#x8BBE;&#x7F6E;&#x5668;&#x65B9;&#x6CD5;&#x7684;&#x4FEE;&#x6539;&#x88C5;&#x9970;&#x5668;&#x3002;</span></p></dd></dl></dd></dl><dl class="class"><dt id="sqlalchemy.ext.hybrid.Comparator"><span class="yiyi-st" id="yiyi-163"> <em class="property">class </em><code class="descclassname">sqlalchemy.ext.hybrid.</code><code class="descname">Comparator</code><span class="sig-paren">(</span><em>expression</em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.ext.hybrid.Comparator" title="Permalink to this definition">&#xB6;</a></span></dt><dd><p><span class="yiyi-st" id="yiyi-164">&#x57FA;&#x7840;&#xFF1A;<a class="reference internal" href="internals.html#sqlalchemy.orm.interfaces.PropComparator" title="sqlalchemy.orm.interfaces.PropComparator"><code class="xref py py-class docutils literal"><span class="pre">sqlalchemy.orm.interfaces.PropComparator</span></code></a></span></p><p><span class="yiyi-st" id="yiyi-165">&#x4E00;&#x4E2A;&#x8F85;&#x52A9;&#x7C7B;&#xFF0C;&#x5141;&#x8BB8;&#x8F7B;&#x677E;&#x6784;&#x5EFA;&#x7528;&#x4E8E;&#x6DF7;&#x5408;&#x4F7F;&#x7528;&#x7684;&#x81EA;&#x5B9A;&#x4E49;<a class="reference internal" href="internals.html#sqlalchemy.orm.interfaces.PropComparator" title="sqlalchemy.orm.interfaces.PropComparator"><code class="xref py py-class docutils literal"><span class="pre">PropComparator</span></code></a>&#x7C7B;&#x3002;</span></p></dd></dl><dl class="data"><dt id="sqlalchemy.ext.hybrid.HYBRID_METHOD"><span class="yiyi-st" id="yiyi-166"><code class="descclassname">sqlalchemy.ext.hybrid&#x3002;</code> <code class="descname">HYBRID_METHOD</code> <em class="property">=&#x7B26;&#x53F7;&#xFF08;&apos;HYBRID_METHOD&apos;&#xFF09;</em> <a class="headerlink" href="#sqlalchemy.ext.hybrid.HYBRID_METHOD" title="Permalink to this definition">&#xB6;</a></span></dt><dd></dd></dl><dl class="data"><dt id="sqlalchemy.ext.hybrid.HYBRID_PROPERTY"><span class="yiyi-st" id="yiyi-167"><code class="descclassname">sqlalchemy.ext.hybrid&#x3002;</code> <code class="descname">HYBRID_PROPERTY</code> <em class="property">=&#x7B26;&#x53F7;&#xFF08;&apos;HYBRID_PROPERTY&apos;&#xFF09;</em> <a class="headerlink" href="#sqlalchemy.ext.hybrid.HYBRID_PROPERTY" title="Permalink to this definition">&#xB6;</a></span></dt><dd></dd></dl></div>