<h1><span class="yiyi-st" id="yiyi-46">&#x7279;&#x6B8A;&#x5173;&#x7CFB;&#x6301;&#x4E45;&#x6027;&#x6A21;&#x5F0F;<a class="headerlink" href="#special-relationship-persistence-patterns" title="Permalink to this headline">&#xB6;</a></span></h1><div class="section" id="rows-that-point-to-themselves-mutually-dependent-rows"><h2><span class="yiyi-st" id="yiyi-47">&#x6307;&#x5411;&#x81EA;&#x5DF1;&#x7684;&#x884C;/&#x76F8;&#x4E92;&#x4F9D;&#x8D56;&#x7684;&#x884C;<a class="headerlink" href="#rows-that-point-to-themselves-mutually-dependent-rows" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-48">&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x7279;&#x6B8A;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x5176;&#x4E2D;relationship()&#x5FC5;&#x987B;&#x6267;&#x884C;INSERT&#x548C;&#x7B2C;&#x4E8C;&#x4E2A;UPDATE&#x624D;&#x80FD;&#x6B63;&#x786E;&#x586B;&#x5145;&#x884C;&#xFF08;&#x53CD;&#x4E4B;&#x4EA6;&#x7136;UPDATE&#x548C;DELETE&#x624D;&#x80FD;&#x5220;&#x9664;&#x800C;&#x4E0D;&#x8FDD;&#x53CD;&#x5916;&#x952E;&#x7EA6;&#x675F;&#xFF09;&#x3002;</span><span class="yiyi-st" id="yiyi-49">&#x8FD9;&#x4E24;&#x4E2A;&#x7528;&#x4F8B;&#x662F;&#xFF1A;</span></p><ul class="simple"><li><span class="yiyi-st" id="yiyi-50">&#x4E00;&#x4E2A;&#x8868;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x81EA;&#x5DF1;&#x7684;&#x5916;&#x952E;&#xFF0C;&#x4E00;&#x884C;&#x5C06;&#x6709;&#x4E00;&#x4E2A;&#x5916;&#x952E;&#x503C;&#x6307;&#x5411;&#x81EA;&#x5DF1;&#x7684;&#x4E3B;&#x952E;&#x3002;</span></li><li><span class="yiyi-st" id="yiyi-51">&#x6BCF;&#x4E2A;&#x8868;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x8868;&#x7684;&#x5916;&#x952E;&#xFF0C;&#x6BCF;&#x4E2A;&#x8868;&#x4E2D;&#x7684;&#x4E00;&#x884C;&#x5F15;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x8868;&#x3002;</span></li></ul><p><span class="yiyi-st" id="yiyi-52">&#x4F8B;&#x5982;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>          user
---------------------------------
user_id    name   related_user_id
   1       &apos;ed&apos;          1</pre></div></div><p><span class="yiyi-st" id="yiyi-53">&#x8981;&#x4E48;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span>             widget                                                  entry
-------------------------------------------             ---------------------------------
widget_id     name        favorite_entry_id             entry_id      name      widget_id
   1       &apos;somewidget&apos;          5                         5       &apos;someentry&apos;     1</pre></div></div><p><span class="yiyi-st" id="yiyi-54">&#x5728;&#x7B2C;&#x4E00;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4E00;&#x6392;&#x6307;&#x5411;&#x81EA;&#x5DF1;&#x3002;</span><span class="yiyi-st" id="yiyi-55">&#x4ECE;&#x6280;&#x672F;&#x4E0A;&#x8BB2;&#xFF0C;&#x4F7F;&#x7528;PostgreSQL&#x6216;Oracle&#x7B49;&#x5E8F;&#x5217;&#x7684;&#x6570;&#x636E;&#x5E93;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5148;&#x524D;&#x751F;&#x6210;&#x7684;&#x503C;&#x540C;&#x65F6;&#x63D2;&#x5165;&#x884C;&#xFF0C;&#x4F46;&#x4F9D;&#x8D56;&#x4E8E;&#x81EA;&#x52A8;&#x589E;&#x91CF;&#x5F0F;&#x4E3B;&#x952E;&#x6807;&#x8BC6;&#x7B26;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E0D;&#x80FD;&#x3002;</span><span class="yiyi-st" id="yiyi-56"><a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal"><span class="pre">relationship()</span></code></a>&#x603B;&#x662F;&#x5728;&#x5237;&#x65B0;&#x8FC7;&#x7A0B;&#x4E2D;&#x5047;&#x5B9A;&#x884C;&#x6570;&#x7684;&#x201C;&#x7236;/&#x5B50;&#x201D;&#x6A21;&#x578B;&#xFF0C;&#x6240;&#x4EE5;&#x9664;&#x975E;&#x76F4;&#x63A5;&#x586B;&#x5145;&#x4E3B;&#x952E;/&#x5916;&#x952E;&#x5217;&#xFF0C;&#x5426;&#x5219;<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal"><span class="pre">relationship()</span></code></a>&#x9700;&#x8981;&#x4F7F;&#x7528;&#x4E24;&#x4E2A;&#x8BED;&#x53E5;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-57">&#x5728;&#x7B2C;&#x4E8C;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5FC5;&#x987B;&#x5728;&#x5F15;&#x7528;&#x201C;&#x6761;&#x76EE;&#x201D;&#x884C;&#x4E4B;&#x524D;&#x63D2;&#x5165;&#x201C;&#x5C0F;&#x90E8;&#x4EF6;&#x201D;&#x884C;&#xFF0C;&#x4F46;&#x76F4;&#x5230;&#x751F;&#x6210;&#x201C;&#x6761;&#x76EE;&#x201D;&#x884C;&#x540E;&#x624D;&#x80FD;&#x8BBE;&#x7F6E;&#x8BE5;&#x201C;&#x5C0F;&#x90E8;&#x4EF6;&#x201D;&#x884C;&#x7684;&#x201C;favorite_entry_id&#x201D;&#x5217;&#x3002;</span><span class="yiyi-st" id="yiyi-58">&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4EC5;&#x4F7F;&#x7528;&#x4E24;&#x4E2A;INSERT&#x8BED;&#x53E5;&#x63D2;&#x5165;&#x201C;&#x5C0F;&#x90E8;&#x4EF6;&#x201D;&#x548C;&#x201C;&#x5165;&#x53E3;&#x201D;&#x884C;&#x901A;&#x5E38;&#x662F;&#x4E0D;&#x53EF;&#x80FD;&#x7684;&#xFF1B;&#x5FC5;&#x987B;&#x6267;&#x884C;UPDATE&#x4EE5;&#x4FDD;&#x6301;&#x5B9E;&#x73B0;&#x5916;&#x952E;&#x7EA6;&#x675F;&#x3002;</span><span class="yiyi-st" id="yiyi-59">&#x4F8B;&#x5916;&#x60C5;&#x51B5;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x5916;&#x952E;&#x914D;&#x7F6E;&#x4E3A;&#x201C;&#x5EF6;&#x8FDF;&#x5230;&#x63D0;&#x4EA4;&#x201D;&#xFF08;&#x67D0;&#x4E9B;&#x6570;&#x636E;&#x5E93;&#x652F;&#x6301;&#x7684;&#x529F;&#x80FD;&#xFF09;&#xFF0C;&#x5E76;&#x4E14;&#x624B;&#x52A8;&#x586B;&#x5145;&#x4E86;&#x6807;&#x8BC6;&#x7B26;&#xFF08;&#x672C;&#x8D28;&#x4E0A;&#x7ED5;&#x8FC7;<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal"><span class="pre">relationship()</span></code></a>&#xFF09;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-60">&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x4F7F;&#x7528;&#x8865;&#x5145;UPDATE&#x8BED;&#x53E5;&#xFF0C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal"><span class="pre">relationship()</span></code></a>&#x7684;<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.post_update" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal"><span class="pre">post_update</span></code></a>&#x9009;&#x9879;&#x3002;</span><span class="yiyi-st" id="yiyi-61">&#x8FD9;&#x6307;&#x5B9A;&#x4E24;&#x884C;&#x4E4B;&#x95F4;&#x7684;&#x94FE;&#x63A5;&#x5E94;&#x8BE5;&#x5728;&#x4E24;&#x884C;&#x5DF2;&#x88AB;INSERTED&#x540E;&#x4F7F;&#x7528;UPDATE&#x8BED;&#x53E5;&#x521B;&#x5EFA;&#xFF1B;&#x5B83;&#x8FD8;&#x4F1A;&#x5BFC;&#x81F4;&#x5728;&#x53D1;&#x51FA;DELETE&#x4E4B;&#x524D;&#x901A;&#x8FC7;UPDATE&#x5C06;&#x884C;&#x5F7C;&#x6B64;&#x89E3;&#x9664;&#x5173;&#x8054;&#x3002;</span><span class="yiyi-st" id="yiyi-62">The flag should be placed on just <em>one</em> of the relationships, preferably the many-to-one side. </span><span class="yiyi-st" id="yiyi-63">&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x4E3E;&#x4F8B;&#x8BF4;&#x660E;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x4F8B;&#x5B50;&#xFF0C;&#x5305;&#x62EC;&#x4E24;&#x4E2A;<a class="reference internal" href="core_constraints.html#sqlalchemy.schema.ForeignKey" title="sqlalchemy.schema.ForeignKey"><code class="xref py py-class docutils literal"><span class="pre">ForeignKey</span></code></a>&#x7ED3;&#x6784;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Entry</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;entry&apos;</span>
    <span class="n">entry_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">widget_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&apos;widget.widget_id&apos;</span><span class="p">))</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Widget</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;widget&apos;</span>

    <span class="n">widget_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">favorite_entry_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span>
                            <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&apos;entry.entry_id&apos;</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;fk_favorite_entry&quot;</span><span class="p">))</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="n">entries</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Entry</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span>
                                    <span class="n">widget_id</span><span class="o">==</span><span class="n">Entry</span><span class="o">.</span><span class="n">widget_id</span><span class="p">)</span>
    <span class="n">favorite_entry</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Entry</span><span class="p">,</span>
                                <span class="n">primaryjoin</span><span class="o">=</span>
                                    <span class="n">favorite_entry_id</span><span class="o">==</span><span class="n">Entry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">,</span>
                                <span class="n">post_update</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-64">&#x5F53;&#x4E00;&#x4E2A;&#x9488;&#x5BF9;&#x4E0A;&#x8FF0;&#x914D;&#x7F6E;&#x7684;&#x7ED3;&#x6784;&#x88AB;&#x5237;&#x65B0;&#x65F6;&#xFF0C;&#x201C;widget&#x201D;&#x884C;&#x5C06;&#x88AB;INSERT&#x51CF;&#x53BB;&#x201C;favorite_entry_id&#x201D;&#x503C;&#xFF0C;&#x7136;&#x540E;&#x6240;&#x6709;&#x7684;&#x201C;entry&#x201D;&#x884C;&#x5C06;&#x88AB;INSERTed&#x5F15;&#x7528;&#x7236;&#x201C;widget&#x201D;&#x884C;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x586B;&#x5145;UPDATE&#x8BED;&#x53E5;&#x201C;&#x5C0F;&#x90E8;&#x4EF6;&#x201D;&#x8868;&#x7684;&#x201C;favorite_entry_id&#x201D;&#x5217;&#xFF08;&#x6682;&#x65F6;&#x4E3A;&#x4E00;&#x884C;&#xFF09;&#xFF1A;</span></p><div class="highlight-pycon+sql"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">w1</span> <span class="o">=</span> <span class="n">Widget</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&apos;somewidget&apos;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">e1</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&apos;someentry&apos;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">w1</span><span class="o">.</span><span class="n">favorite_entry</span> <span class="o">=</span> <span class="n">e1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">w1</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">e1</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">w1</span><span class="p">,</span> <span class="n">e1</span><span class="p">])</span>
<a class="sql_link" href="#">sql</a><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<div class="popup_sql">BEGIN (implicit)
INSERT INTO widget (favorite_entry_id, name) VALUES (?, ?)
(None, &apos;somewidget&apos;)
INSERT INTO entry (widget_id, name) VALUES (?, ?)
(1, &apos;someentry&apos;)
UPDATE widget SET favorite_entry_id=? WHERE widget.widget_id = ?
(1, 1)
COMMIT</div></pre></div></div><p><span class="yiyi-st" id="yiyi-65">&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x7684;&#x989D;&#x5916;&#x914D;&#x7F6E;&#x662F;&#x5728;<code class="docutils literal"><span class="pre">Widget</span></code>&#x4E0A;&#x63D0;&#x4F9B;&#x66F4;&#x5168;&#x9762;&#x7684;&#x5916;&#x952E;&#x7EA6;&#x675F;&#xFF0C;&#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;<code class="docutils literal"><span class="pre">favorite_entry_id</span></code>&#x5F15;&#x7528;<code class="docutils literal"><span class="pre">Entry</span></code>&#x4E5F;&#x6307;&#x8FD9;&#x4E2A;<code class="docutils literal"><span class="pre">Widget</span></code>&#x3002;</span><span class="yiyi-st" id="yiyi-66">&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x590D;&#x5408;&#x5916;&#x952E;&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> \
        <span class="n">Column</span><span class="p">,</span> <span class="n">UniqueConstraint</span><span class="p">,</span> <span class="n">ForeignKeyConstraint</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Entry</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;entry&apos;</span>
    <span class="n">entry_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">widget_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&apos;widget.widget_id&apos;</span><span class="p">))</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">,</span> <span class="s2">&quot;widget_id&quot;</span><span class="p">),</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">Widget</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;widget&apos;</span>

    <span class="n">widget_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="s1">&apos;ignore_fk&apos;</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">favorite_entry_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ForeignKeyConstraint</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;widget_id&quot;</span><span class="p">,</span> <span class="s2">&quot;favorite_entry_id&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;entry.widget_id&quot;</span><span class="p">,</span> <span class="s2">&quot;entry.entry_id&quot;</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;fk_favorite_entry&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">entries</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Entry</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span>
                                    <span class="n">widget_id</span><span class="o">==</span><span class="n">Entry</span><span class="o">.</span><span class="n">widget_id</span><span class="p">,</span>
                                    <span class="n">foreign_keys</span><span class="o">=</span><span class="n">Entry</span><span class="o">.</span><span class="n">widget_id</span><span class="p">)</span>
    <span class="n">favorite_entry</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Entry</span><span class="p">,</span>
                                <span class="n">primaryjoin</span><span class="o">=</span>
                                    <span class="n">favorite_entry_id</span><span class="o">==</span><span class="n">Entry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">,</span>
                                <span class="n">foreign_keys</span><span class="o">=</span><span class="n">favorite_entry_id</span><span class="p">,</span>
                                <span class="n">post_update</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-67">&#x4E0A;&#x9762;&#x7684;&#x6620;&#x5C04;&#x5177;&#x6709;&#x6865;&#x63A5;<code class="docutils literal"><span class="pre">widget_id</span></code>&#x548C;<code class="docutils literal"><span class="pre">favorite_entry_id</span></code>&#x5217;&#x7684;&#x7EC4;&#x5408;<a class="reference internal" href="core_constraints.html#sqlalchemy.schema.ForeignKeyConstraint" title="sqlalchemy.schema.ForeignKeyConstraint"><code class="xref py py-class docutils literal"><span class="pre">ForeignKeyConstraint</span></code></a>&#x3002;</span><span class="yiyi-st" id="yiyi-68">To ensure that <code class="docutils literal"><span class="pre">Widget.widget_id</span></code> remains an &#x201C;autoincrementing&#x201D; column we specify <a class="reference internal" href="core_metadata.html#sqlalchemy.schema.Column.params.autoincrement" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal"><span class="pre">autoincrement</span></code></a> to the value <code class="docutils literal"><span class="pre">&quot;ignore_fk&quot;</span></code> on <a class="reference internal" href="core_metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal"><span class="pre">Column</span></code></a>, and additionally on each <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal"><span class="pre">relationship()</span></code></a> we must limit those columns considered as part of the foreign key for the purposes of joining and cross-population.</span></p></div><div class="section" id="mutable-primary-keys-update-cascades"><h2><span class="yiyi-st" id="yiyi-69">&#x53EF;&#x53D8;&#x4E3B;&#x952E;/&#x66F4;&#x65B0;&#x7EA7;&#x8054;<a class="headerlink" href="#mutable-primary-keys-update-cascades" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-70">&#x5F53;&#x5B9E;&#x4F53;&#x7684;&#x4E3B;&#x952E;&#x53D1;&#x751F;&#x53D8;&#x5316;&#x65F6;&#xFF0C;&#x5F15;&#x7528;&#x4E3B;&#x952E;&#x7684;&#x76F8;&#x5173;&#x9879;&#x76EE;&#x4E5F;&#x5FC5;&#x987B;&#x66F4;&#x65B0;&#x3002;</span><span class="yiyi-st" id="yiyi-71">&#x5BF9;&#x4E8E;&#x5F3A;&#x5236;&#x5F15;&#x7528;&#x5B8C;&#x6574;&#x6027;&#x7684;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x6700;&#x597D;&#x7684;&#x7B56;&#x7565;&#x662F;&#x4F7F;&#x7528;&#x6570;&#x636E;&#x5E93;&#x7684;ON UPDATE CASCADE&#x529F;&#x80FD;&#xFF0C;&#x4EE5;&#x4FBF;&#x5C06;&#x4E3B;&#x952E;&#x66F4;&#x6539;&#x4F20;&#x64AD;&#x5230;&#x5F15;&#x7528;&#x7684;&#x5916;&#x952E; - &#x8FD9;&#x4E9B;&#x503C;&#x5728;&#x4EFB;&#x4F55;&#x65F6;&#x5019;&#x90FD;&#x4E0D;&#x4F1A;&#x540C;&#x6B65;&#xFF0C;&#x9664;&#x975E;&#x7EA6;&#x675F;&#x88AB;&#x6807;&#x8BB0;&#x4E3A;&#x201C;&#x53EF;&#x5EF6;&#x8FDF;&#x201D;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x5728;&#x4E8B;&#x52A1;&#x5B8C;&#x6210;&#x4E4B;&#x524D;&#x4E0D;&#x4F1A;&#x5F3A;&#x5236;&#x6267;&#x884C;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-72">It is <strong>highly recommended</strong> that an application which seeks to employ natural primary keys with mutable values to use the <code class="docutils literal"><span class="pre">ON</span> <span class="pre">UPDATE</span> <span class="pre">CASCADE</span></code> capabilities of the database. </span><span class="yiyi-st" id="yiyi-73">&#x8BF4;&#x660E;&#x8FD9;&#x4E00;&#x70B9;&#x7684;&#x793A;&#x4F8B;&#x6620;&#x5C04;&#x662F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;user&apos;</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&apos;mysql_engine&apos;</span><span class="p">:</span> <span class="s1">&apos;InnoDB&apos;</span><span class="p">}</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>

    <span class="n">addresses</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;address&apos;</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&apos;mysql_engine&apos;</span><span class="p">:</span> <span class="s1">&apos;InnoDB&apos;</span><span class="p">}</span>

    <span class="n">email</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
                <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&apos;user.username&apos;</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="s2">&quot;cascade&quot;</span><span class="p">)</span>
            <span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-74">Above, we illustrate <code class="docutils literal"><span class="pre">onupdate=&quot;cascade&quot;</span></code> on the <a class="reference internal" href="core_constraints.html#sqlalchemy.schema.ForeignKey" title="sqlalchemy.schema.ForeignKey"><code class="xref py py-class docutils literal"><span class="pre">ForeignKey</span></code></a> object, and we also illustrate the <code class="docutils literal"><span class="pre">mysql_engine=&apos;InnoDB&apos;</span></code> setting which, on a MySQL backend, ensures that the <code class="docutils literal"><span class="pre">InnoDB</span></code> engine supporting referential integrity is used. </span><span class="yiyi-st" id="yiyi-75">&#x5728;&#x4F7F;&#x7528;SQLite&#x65F6;&#xFF0C;&#x5E94;&#x4F7F;&#x7528;<a class="reference internal" href="dialects_sqlite.html#sqlite-foreign-keys"><span>Foreign Key Support</span></a>&#x4E2D;&#x4ECB;&#x7ECD;&#x7684;&#x914D;&#x7F6E;&#x542F;&#x7528;&#x53C2;&#x7167;&#x5B8C;&#x6574;&#x6027;&#x3002;</span></p><div class="admonition seealso"><p class="first admonition-title"><span class="yiyi-st" id="yiyi-76">&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x770B;</span></p><p><span class="yiyi-st" id="yiyi-77"><a class="reference internal" href="collections.html#passive-deletes"><span>Using Passive Deletes</span></a>  - &#x652F;&#x6301;&#x5177;&#x6709;&#x5173;&#x7CFB;&#x7684;ON DELETE CASCADE</span></p><p class="last"><span class="yiyi-st" id="yiyi-78"><a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapper.params.passive_updates" title="sqlalchemy.orm.mapper"><code class="xref py py-paramref docutils literal"><span class="pre">orm.mapper.passive_updates</span></code></a>  -  <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapper" title="sqlalchemy.orm.mapper"><code class="xref py py-func docutils literal"><span class="pre">mapper()</span></code></a></span></p></div><div class="section" id="simulating-limited-on-update-cascade-without-foreign-key-support"><h3><span class="yiyi-st" id="yiyi-79">&#x6A21;&#x62DF;&#x6709;&#x9650;ON UPDATE CASCADE&#xFF0C;&#x65E0;&#x5916;&#x952E;&#x652F;&#x6301;<a class="headerlink" href="#simulating-limited-on-update-cascade-without-foreign-key-support" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-80">&#x5728;&#x4F7F;&#x7528;&#x4E0D;&#x652F;&#x6301;&#x53C2;&#x7167;&#x5B8C;&#x6574;&#x6027;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4EE5;&#x53CA;&#x5177;&#x6709;&#x53EF;&#x53D8;&#x503C;&#x7684;&#x81EA;&#x7136;&#x4E3B;&#x952E;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;SQLAlchemy&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x529F;&#x80FD;&#xFF0C;&#x4EE5;&#x5141;&#x8BB8;&#x5C06;&#x4E3B;&#x952E;&#x503C;&#x4F20;&#x64AD;&#x5230;&#x5DF2;&#x7ECF;&#x5F15;&#x7528;&#x7684;&#x5916;&#x952E;&#x5230;<strong>&#x901A;&#x8FC7;&#x9488;&#x5BF9;&#x7ACB;&#x5373;&#x5F15;&#x7528;&#x5176;&#x503C;&#x5DF2;&#x66F4;&#x6539;&#x7684;&#x4E3B;&#x952E;&#x5217;&#x7684;&#x5916;&#x952E;&#x5217;&#x53D1;&#x51FA;UPDATE&#x8BED;&#x53E5;&#x6765;&#x9650;&#x5236;</strong>&#x8303;&#x56F4;&#x3002;</span><span class="yiyi-st" id="yiyi-81">&#x5F53;&#x4F7F;&#x7528;<code class="docutils literal"><span class="pre">MyISAM</span></code>&#x5B58;&#x50A8;&#x5F15;&#x64CE;&#x65F6;&#xFF0C;&#x6CA1;&#x6709;&#x5F15;&#x7528;&#x5B8C;&#x6574;&#x6027;&#x529F;&#x80FD;&#x7684;&#x4E3B;&#x8981;&#x5E73;&#x53F0;&#x662F;MySQL&#xFF0C;&#x800C;<code class="docutils literal"><span class="pre">PRAGMA</span> <span class="pre">foreign_keys = ON</span> / t2&gt;&#x7F16;&#x8BD1;&#x6307;&#x793A;&#x4E0D;&#x4F7F;&#x7528;&#x3002;</code></span><span class="yiyi-st" id="yiyi-82">Oracle&#x6570;&#x636E;&#x5E93;&#x4E5F;&#x4E0D;&#x652F;&#x6301;<code class="docutils literal"><span class="pre">ON</span> <span class="pre">UPDATE</span> <span class="pre">CASCADE</span></code>&#xFF0C;&#x4F46;&#x7531;&#x4E8E;&#x5B83;&#x4ECD;&#x7136;&#x5F3A;&#x5236;&#x5F15;&#x7528;&#x5B8C;&#x6574;&#x6027;&#xFF0C;&#x88AB;&#x6807;&#x8BB0;&#x4E3A;&#x53EF;&#x5EF6;&#x8FDF;&#xFF0C;&#x4EE5;&#x4FBF;SQLAlchemy&#x53EF;&#x4EE5;&#x53D1;&#x51FA;UPDATE&#x8BED;&#x53E5;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-83">&#x901A;&#x8FC7;&#x5C06;<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.passive_updates" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal"><span class="pre">passive_updates</span></code></a>&#x6807;&#x5FD7;&#x8BBE;&#x7F6E;&#x4E3A;<code class="docutils literal"><span class="pre">False</span></code>&#x6765;&#x542F;&#x7528;&#x8BE5;&#x529F;&#x80FD;&#xFF0C;&#x6700;&#x4F18;&#x9009;&#x4E3A;&#x4E00;&#x5BF9;&#x591A;&#x6216;&#x591A;&#x5BF9;&#x591A;<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal"><span class="pre">relationship()</span></code></a></span><span class="yiyi-st" id="yiyi-84">&#x5F53;&#x201C;&#x66F4;&#x65B0;&#x201D;&#x4E0D;&#x518D;&#x662F;&#x201C;&#x88AB;&#x52A8;&#x201D;&#x65F6;&#xFF0C;&#x8FD9;&#x8868;&#x660E;SQLAlchemy&#x5C06;&#x9488;&#x5BF9;&#x7531;&#x5177;&#x6709;&#x53D8;&#x5316;&#x7684;&#x4E3B;&#x952E;&#x503C;&#x7684;&#x7236;&#x5BF9;&#x8C61;&#x5F15;&#x7528;&#x7684;&#x96C6;&#x5408;&#x4E2D;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x5206;&#x522B;&#x53D1;&#x51FA;UPDATE&#x8BED;&#x53E5;&#x3002;</span><span class="yiyi-st" id="yiyi-85">&#x8FD9;&#x4E5F;&#x610F;&#x5473;&#x7740;&#x96C6;&#x5408;&#x5C06;&#x88AB;&#x5B8C;&#x5168;&#x52A0;&#x8F7D;&#x5230;&#x5185;&#x5B58;&#x4E2D;&#xFF08;&#x5982;&#x679C;&#x5C1A;&#x672A;&#x672C;&#x5730;&#x5B58;&#x5728;&#x7684;&#x8BDD;&#xFF09;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-86">&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x4F7F;&#x7528;<code class="docutils literal"><span class="pre">passive_updates=False</span></code>&#x7684;&#x6620;&#x5C04;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;user&apos;</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>

    <span class="c1"># passive_updates=False *only* needed if the database</span>
    <span class="c1"># does not implement ON UPDATE CASCADE</span>
    <span class="n">addresses</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">passive_updates</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;address&apos;</span>

    <span class="n">email</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&apos;user.username&apos;</span><span class="p">))</span></pre></div></div><p><span class="yiyi-st" id="yiyi-87"><code class="docutils literal"><span class="pre">passive_updates=False</span></code>&#x7684;&#x4E3B;&#x8981;&#x5C40;&#x9650;&#x6027;&#x5305;&#x62EC;&#xFF1A;</span></p><ul class="simple"><li><span class="yiyi-st" id="yiyi-88">&#x5B83;&#x6BD4;&#x76F4;&#x63A5;&#x6570;&#x636E;&#x5E93;ON UPDATE CASCADE&#x6267;&#x884C;&#x5F97;&#x66F4;&#x5DEE;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x9700;&#x8981;&#x4F7F;&#x7528;SELECT&#x5B8C;&#x5168;&#x9884;&#x52A0;&#x8F7D;&#x53D7;&#x5F71;&#x54CD;&#x7684;&#x96C6;&#x5408;&#xFF0C;&#x5E76;&#x4E14;&#x8FD8;&#x5FC5;&#x987B;&#x9488;&#x5BF9;&#x8FD9;&#x4E9B;&#x503C;&#x53D1;&#x51FA;UPDATE&#x8BED;&#x53E5;&#xFF0C;&#x5B83;&#x5C06;&#x5C1D;&#x8BD5;&#x5728;&#x201C;&#x6279;&#x5904;&#x7406;&#x201D;&#x4E2D;&#x8FD0;&#x884C;&#xFF0C;&#x4F46;&#x4ECD;&#x7136;&#x4EE5;&#x6BCF;&#x6B21;&#x8FD0;&#x884C;&#x5728;DBAPI&#x7EA7;&#x522B;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x3002;</span></li><li><span class="yiyi-st" id="yiyi-89">&#x8BE5;&#x529F;&#x80FD;&#x4E0D;&#x80FD;&#x201C;&#x7EA7;&#x8054;&#x201D;&#x591A;&#x4E2A;&#x7EA7;&#x522B;&#x3002;</span><span class="yiyi-st" id="yiyi-90">That is, if mapping X has a foreign key which refers to the primary key of mapping Y, but then mapping Y&#x2019;s primary key is itself a foreign key to mapping Z, <code class="docutils literal"><span class="pre">passive_updates=False</span></code> cannot cascade a change in primary key value from <code class="docutils literal"><span class="pre">Z</span></code> to <code class="docutils literal"><span class="pre">X</span></code>.</span></li><li><span class="yiyi-st" id="yiyi-91">&#x4EC5;&#x5728;&#x5173;&#x7CFB;&#x7684;&#x591A;&#x5BF9;&#x4E00;&#x4FA7;&#x914D;&#x7F6E;<code class="docutils literal"><span class="pre">passive_updates=False</span></code>&#x4E0D;&#x4F1A;&#x4EA7;&#x751F;&#x5B8C;&#x6574;&#x6548;&#x679C;&#xFF0C;&#x56E0;&#x4E3A;&#x5DE5;&#x4F5C;&#x5355;&#x5143;&#x4EC5;&#x901A;&#x8FC7;&#x5F53;&#x524D;&#x6807;&#x8BC6;&#x6620;&#x5C04;&#x641C;&#x7D22;&#x53EF;&#x80FD;&#x5F15;&#x7528;&#x8BE5;&#x5BF9;&#x8C61;&#x7684;&#x5BF9;&#x8C61;&#x6709;&#x4E00;&#x4E2A;&#x53D8;&#x5F02;&#x7684;&#x4E3B;&#x952E;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x6574;&#x4E2A;&#x6570;&#x636E;&#x5E93;&#x3002;</span></li></ul><p><span class="yiyi-st" id="yiyi-92">As virtually all databases other than Oracle now support <code class="docutils literal"><span class="pre">ON</span> <span class="pre">UPDATE</span> <span class="pre">CASCADE</span></code>, it is highly recommended that traditional <code class="docutils literal"><span class="pre">ON</span> <span class="pre">UPDATE</span> <span class="pre">CASCADE</span></code> support be used in the case that natural and mutable primary key values are in use.</span></p></div></div>