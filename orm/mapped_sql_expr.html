<h1><span class="yiyi-st" id="yiyi-49">SQL&#x8868;&#x8FBE;&#x5F0F;&#x4F5C;&#x4E3A;&#x6620;&#x5C04;&#x7684;&#x5C5E;&#x6027;<a class="headerlink" href="#sql-expressions-as-mapped-attributes" title="Permalink to this headline">&#xB6;</a></span></h1><p><span class="yiyi-st" id="yiyi-50">&#x6620;&#x5C04;&#x7C7B;&#x7684;&#x5C5E;&#x6027;&#x53EF;&#x4EE5;&#x94FE;&#x63A5;&#x5230;&#x53EF;&#x7528;&#x4E8E;&#x67E5;&#x8BE2;&#x7684;SQL&#x8868;&#x8FBE;&#x5F0F;&#x3002;</span></p><div class="section" id="using-a-hybrid"><h2><span class="yiyi-st" id="yiyi-51">&#x4F7F;&#x7528;&#x6DF7;&#x5408;<a class="headerlink" href="#using-a-hybrid" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-52">&#x5C06;&#x76F8;&#x5BF9;&#x7B80;&#x5355;&#x7684;SQL&#x8868;&#x8FBE;&#x5F0F;&#x94FE;&#x63A5;&#x5230;&#x7C7B;&#x7684;&#x6700;&#x7B80;&#x5355;&#x548C;&#x6700;&#x7075;&#x6D3B;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x4F7F;&#x7528;&#x6240;&#x8C13;&#x7684;&#x201C;&#x6DF7;&#x5408;&#x5C5E;&#x6027;&#x201D;&#xFF0C;&#x5982;<a class="reference internal" href="extensions_hybrid.html"><span>Hybrid Attributes</span></a>&#x90E8;&#x5206;&#x4E2D;&#x6240;&#x8FF0;&#x3002;</span><span class="yiyi-st" id="yiyi-53">&#x8BE5;&#x6DF7;&#x5408;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x65E2;&#x9002;&#x7528;&#x4E8E;Python&#x7EA7;&#x522B;&#x53C8;&#x9002;&#x7528;&#x4E8E;SQL&#x8868;&#x8FBE;&#x7EA7;&#x522B;&#x7684;&#x8868;&#x8FBE;&#x5F0F;&#x3002;</span><span class="yiyi-st" id="yiyi-54">&#x4F8B;&#x5982;&#xFF0C;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x6620;&#x5C04;&#x4E00;&#x4E2A;&#x7C7B;<code class="docutils literal"><span class="pre">User</span></code>&#xFF0C;&#x5B83;&#x5305;&#x542B;&#x5C5E;&#x6027;<code class="docutils literal"><span class="pre">firstname</span></code>&#x548C;<code class="docutils literal"><span class="pre">lastname</span></code>&#xFF0C;&#x5E76;&#x4E14;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x6DF7;&#x5408;&#xFF0C;&#x5B83;&#x5C06;&#x4E3A;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;<code class="docutils literal"><span class="pre">fullname</span></code>&#xFF0C;&#x8FD9;&#x662F;&#x4E24;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x8FDE;&#x63A5;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;user&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">firstname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">lastname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">fullname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstname</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastname</span></pre></div></div><p><span class="yiyi-st" id="yiyi-55">&#x4E0A;&#x9762;&#xFF0C;<code class="docutils literal"><span class="pre">fullname</span></code>&#x5C5E;&#x6027;&#x5728;&#x5B9E;&#x4F8B;&#x548C;&#x7C7B;&#x7EA7;&#x522B;&#x90FD;&#x88AB;&#x89E3;&#x91CA;&#xFF0C;&#x4EE5;&#x4FBF;&#x5B83;&#x53EF;&#x4EE5;&#x4ECE;&#x5B9E;&#x4F8B;&#x4E2D;&#x83B7;&#x5F97;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">some_user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">some_user</span><span class="o">.</span><span class="n">fullname</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-56">&#x4EE5;&#x53CA;&#x5728;&#x67E5;&#x8BE2;&#x4E2D;&#x53EF;&#x7528;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">some_user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">fullname</span> <span class="o">==</span> <span class="s2">&quot;John Smith&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></pre></div></div><p><span class="yiyi-st" id="yiyi-57">&#x5B57;&#x7B26;&#x4E32;&#x8FDE;&#x63A5;&#x7684;&#x4F8B;&#x5B50;&#x5F88;&#x7B80;&#x5355;&#xFF0C;Python&#x8868;&#x8FBE;&#x5F0F;&#x53EF;&#x4EE5;&#x5728;&#x5B9E;&#x4F8B;&#x548C;&#x7C7B;&#x7EA7;&#x522B;&#x53CC;&#x91CD;&#x4F7F;&#x7528;&#x3002;</span><span class="yiyi-st" id="yiyi-58">&#x901A;&#x5E38;&#xFF0C;&#x5FC5;&#x987B;&#x5C06;SQL&#x8868;&#x8FBE;&#x5F0F;&#x4E0E;Python&#x8868;&#x8FBE;&#x5F0F;&#x533A;&#x5206;&#x5F00;&#x6765;&#xFF0C;&#x8FD9;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<a class="reference internal" href="extensions_hybrid.html#sqlalchemy.ext.hybrid.hybrid_property.expression" title="sqlalchemy.ext.hybrid.hybrid_property.expression"><code class="xref py py-meth docutils literal"><span class="pre">hybrid_property.expression()</span></code></a>&#x6765;&#x5B9E;&#x73B0;&#x3002;</span><span class="yiyi-st" id="yiyi-59">&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x901A;&#x8FC7;Python&#x4E2D;&#x7684;<code class="docutils literal"><span class="pre">if</span></code>&#x8BED;&#x53E5;&#x548C;SQL&#x8868;&#x8FBE;&#x5F0F;&#x7684;<a class="reference internal" href="core_sqlelement.html#sqlalchemy.sql.expression.case" title="sqlalchemy.sql.expression.case"><code class="xref py py-func docutils literal"><span class="pre">sql.expression.case()</span></code></a>&#x6784;&#x9020;&#x6765;&#x8BF4;&#x660E;&#x6761;&#x4EF6;&#x9700;&#x8981;&#x5B58;&#x5728;&#x4E8E;&#x6DF7;&#x5408;&#x5185;&#x90E8;&#x7684;&#x60C5;&#x51B5;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">case</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;user&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">firstname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">lastname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">fullname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstname</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastname</span>

    <span class="nd">@fullname.expression</span>
    <span class="k">def</span> <span class="nf">fullname</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">case</span><span class="p">([</span>
            <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">firstname</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">firstname</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">cls</span><span class="o">.</span><span class="n">lastname</span><span class="p">),</span>
        <span class="p">],</span> <span class="n">else_</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">lastname</span><span class="p">)</span></pre></div></div></div><div class="section" id="using-column-property"><h2><span class="yiyi-st" id="yiyi-60">&#x4F7F;&#x7528;column_property <a class="headerlink" href="#using-column-property" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-61"><a class="reference internal" href="mapping_columns.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal"><span class="pre">orm.column_property()</span></code></a>&#x51FD;&#x6570;&#x53EF;&#x7528;&#x4E8E;&#x4EE5;&#x7C7B;&#x4F3C;&#x4E8E;&#x5B9A;&#x671F;&#x6620;&#x5C04;&#x7684;<a class="reference internal" href="core_metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal"><span class="pre">Column</span></code></a>&#x7684;&#x65B9;&#x5F0F;&#x6620;&#x5C04;SQL&#x8868;&#x8FBE;&#x5F0F;&#x3002;</span><span class="yiyi-st" id="yiyi-62">&#x4F7F;&#x7528;&#x8FD9;&#x79CD;&#x6280;&#x672F;&#xFF0C;&#x8BE5;&#x5C5E;&#x6027;&#x5728;&#x52A0;&#x8F7D;&#x65F6;&#x4E0E;&#x6240;&#x6709;&#x5176;&#x4ED6;&#x5217;&#x6620;&#x5C04;&#x5C5E;&#x6027;&#x4E00;&#x8D77;&#x52A0;&#x8F7D;&#x3002;</span><span class="yiyi-st" id="yiyi-63">&#x8FD9;&#x5728;&#x67D0;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#x6BD4;&#x6DF7;&#x5408;&#x4F7F;&#x7528;&#x66F4;&#x6709;&#x4F18;&#x52BF;&#xFF0C;&#x56E0;&#x4E3A;&#x8BE5;&#x503C;&#x53EF;&#x4EE5;&#x4E0E;&#x5BF9;&#x8C61;&#x7684;&#x7236;&#x884C;&#x540C;&#x65F6;&#x52A0;&#x8F7D;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x5F53;&#x8868;&#x8FBE;&#x5F0F;&#x94FE;&#x63A5;&#x5230;&#x5176;&#x4ED6;&#x8868;&#x65F6;&#xFF08;&#x901A;&#x5E38;&#x4F5C;&#x4E3A;&#x76F8;&#x5173;&#x5B50;&#x67E5;&#x8BE2;&#xFF09;&#x6765;&#x8BBF;&#x95EE;&#x901A;&#x5E38;&#x4E0D;&#x4F1A;&#x5728;&#x5DF2;&#x7ECF;&#x52A0;&#x8F7D;&#x7684;&#x5BF9;&#x8C61;&#x4E0A;&#x53EF;&#x7528;&#x7684;&#x6570;&#x636E;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-64">Disadvantages to using <a class="reference internal" href="mapping_columns.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal"><span class="pre">orm.column_property()</span></code></a> for SQL expressions include that the expression must be compatible with the SELECT statement emitted for the class as a whole, and there are also some configurational quirks which can occur when using <a class="reference internal" href="mapping_columns.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal"><span class="pre">orm.column_property()</span></code></a> from declarative mixins.</span></p><p><span class="yiyi-st" id="yiyi-65">&#x6211;&#x4EEC;&#x7684;&#x201C;&#x5168;&#x540D;&#x201D;&#x793A;&#x4F8B;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<a class="reference internal" href="mapping_columns.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal"><span class="pre">orm.column_property()</span></code></a>&#x8868;&#x793A;&#x5982;&#x4E0B;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">column_property</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;user&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">firstname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">lastname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">column_property</span><span class="p">(</span><span class="n">firstname</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">lastname</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-66">&#x76F8;&#x5173;&#x7684;&#x5B50;&#x67E5;&#x8BE2;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x3002;</span><span class="yiyi-st" id="yiyi-67">&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x4F7F;&#x7528;<a class="reference internal" href="core_selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal"><span class="pre">select()</span></code></a>&#x6784;&#x9020;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;SELECT&#xFF0C;&#x5B83;&#x5C06;&#x7279;&#x5B9A;<code class="docutils literal"><span class="pre">User</span></code>&#x53EF;&#x7528;&#x7684;<code class="docutils literal"><span class="pre">Address</span></code>&#x5BF9;&#x8C61;&#x7684;&#x8BA1;&#x6570;&#x94FE;&#x63A5;&#x5728;&#x4E00;&#x8D77;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">column_property</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">func</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">ForeignKey</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;address&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&apos;user.id&apos;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;user&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">address_count</span> <span class="o">=</span> <span class="n">column_property</span><span class="p">(</span>
        <span class="n">select</span><span class="p">([</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span><span class="o">.</span>\
            <span class="n">where</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user_id</span><span class="o">==</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">correlate_except</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span>
    <span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-68">&#x5728;&#x4E0A;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x4E86;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x7684;<a class="reference internal" href="core_selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal"><span class="pre">select()</span></code></a>&#x7ED3;&#x6784;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">select</span><span class="p">([</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span><span class="o">.</span>\
    <span class="n">where</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user_id</span><span class="o">==</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">correlate_except</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-69">The meaning of the above statement is, select the count of <code class="docutils literal"><span class="pre">Address.id</span></code> rows where the <code class="docutils literal"><span class="pre">Address.user_id</span></code> column is equated to <code class="docutils literal"><span class="pre">id</span></code>, which in the context of the <code class="docutils literal"><span class="pre">User</span></code> class is the <a class="reference internal" href="core_metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal"><span class="pre">Column</span></code></a> named <code class="docutils literal"><span class="pre">id</span></code> (note that <code class="docutils literal"><span class="pre">id</span></code> is also the name of a Python built in function, which is not what we want to use here - if we were outside of the <code class="docutils literal"><span class="pre">User</span></code> class definition, we&#x2019;d use <code class="docutils literal"><span class="pre">User.id</span></code>).</span></p><p><span class="yiyi-st" id="yiyi-70"><code class="xref py py-meth docutils literal"><span class="pre">select.correlate_except()</span></code>&#x6307;&#x793A;&#x8868;&#x660E;&#x53EF;&#x4EE5;&#x4ECE;FROM&#x5217;&#x8868;&#x4E2D;&#x7701;&#x7565;&#x6B64;<a class="reference internal" href="core_selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal"><span class="pre">select()</span></code></a>&#x7684;FROM&#x5B50;&#x53E5;&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#xFF08;&#x5373;&#xFF0C;&#x4E0E;&#x5C01;&#x95ED;&#x7684;SELECT&#x9488;&#x5BF9;<code class="docutils literal"><span class="pre">User</span></code>&#x7684;&#x58F0;&#x660E;&#xFF09;&#x9664;&#x4E86;&#x4E0E;<code class="docutils literal"><span class="pre">Address</span></code>&#x5BF9;&#x5E94;&#x7684;&#x58F0;&#x660E;&#x4E4B;&#x5916;&#x3002;</span><span class="yiyi-st" id="yiyi-71">This isn&#x2019;t strictly necessary, but prevents <code class="docutils literal"><span class="pre">Address</span></code> from being inadvertently omitted from the FROM list in the case of a long string of joins between <code class="docutils literal"><span class="pre">User</span></code> and <code class="docutils literal"><span class="pre">Address</span></code> tables where SELECT statements against <code class="docutils literal"><span class="pre">Address</span></code> are nested.</span></p><p><span class="yiyi-st" id="yiyi-72">&#x5982;&#x679C;&#x5BFC;&#x5165;&#x95EE;&#x9898;&#x963B;&#x6B62;<a class="reference internal" href="mapping_columns.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal"><span class="pre">column_property()</span></code></a>&#x4E0E;&#x8BE5;&#x7C7B;&#x5185;&#x8054;&#x5B9A;&#x4E49;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x5728;&#x4E24;&#x8005;&#x90FD;&#x914D;&#x7F6E;&#x540E;&#x5C06;&#x5176;&#x5206;&#x914D;&#x7ED9;&#x7C7B;&#x3002;</span><span class="yiyi-st" id="yiyi-73">&#x5728;Declarative&#x4E2D;&#xFF0C;&#x8FD9;&#x5177;&#x6709;&#x8C03;&#x7528;<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapper.Mapper.add_property" title="sqlalchemy.orm.mapper.Mapper.add_property"><code class="xref py py-meth docutils literal"><span class="pre">Mapper.add_property()</span></code></a>&#x5728;&#x4E8B;&#x5B9E;&#x4E4B;&#x540E;&#x6DFB;&#x52A0;&#x5176;&#x4ED6;&#x5C5E;&#x6027;&#x7684;&#x6548;&#x679C;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">User</span><span class="o">.</span><span class="n">address_count</span> <span class="o">=</span> <span class="n">column_property</span><span class="p">(</span>
        <span class="n">select</span><span class="p">([</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span><span class="o">.</span>\
            <span class="n">where</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user_id</span><span class="o">==</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-74">&#x5BF9;&#x4E8E;&#x591A;&#x5BF9;&#x591A;&#x5173;&#x7CFB;&#xFF0C;&#x4F7F;&#x7528;<a class="reference internal" href="core_sqlelement.html#sqlalchemy.sql.expression.and_" title="sqlalchemy.sql.expression.and_"><code class="xref py py-func docutils literal"><span class="pre">and_()</span></code></a>&#x5C06;&#x5173;&#x8054;&#x8868;&#x7684;&#x5B57;&#x6BB5;&#x8FDE;&#x63A5;&#x5230;&#x5173;&#x7CFB;&#x4E2D;&#x7684;&#x4E24;&#x4E2A;&#x8868;&#xFF0C;&#x8FD9;&#x91CC;&#x7528;&#x7ECF;&#x5178;&#x6620;&#x5C04;&#x6765;&#x8BF4;&#x660E;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">and_</span>

<span class="n">mapper</span><span class="p">(</span><span class="n">Author</span><span class="p">,</span> <span class="n">authors</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&apos;book_count&apos;</span><span class="p">:</span> <span class="n">column_property</span><span class="p">(</span>
                        <span class="n">select</span><span class="p">([</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">books</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)],</span>
                            <span class="n">and_</span><span class="p">(</span>
                                <span class="n">book_authors</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">author_id</span><span class="o">==</span><span class="n">authors</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                <span class="n">book_authors</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">book_id</span><span class="o">==</span><span class="n">books</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span>
                            <span class="p">)))</span>
    <span class="p">})</span></pre></div></div></div><div class="section" id="using-a-plain-descriptor"><h2><span class="yiyi-st" id="yiyi-75">&#x4F7F;&#x7528;&#x666E;&#x901A;&#x63CF;&#x8FF0;&#x7B26;<a class="headerlink" href="#using-a-plain-descriptor" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-76">&#x5982;&#x679C;SQL&#x67E5;&#x8BE2;&#x6BD4;<a class="reference internal" href="mapping_columns.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal"><span class="pre">orm.column_property()</span></code></a>&#x6216;<a class="reference internal" href="extensions_hybrid.html#sqlalchemy.ext.hybrid.hybrid_property" title="sqlalchemy.ext.hybrid.hybrid_property"><code class="xref py py-class docutils literal"><span class="pre">hybrid_property</span></code></a>&#x53EF;&#x4EE5;&#x63D0;&#x4F9B;&#x7684;&#x66F4;&#x7CBE;&#x7EC6;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4F5C;&#x4E3A;&#x5C5E;&#x6027;&#x8BBF;&#x95EE;&#x7684;&#x5E38;&#x89C4;Python&#x51FD;&#x6570;&#xFF0C;&#x5047;&#x8BBE;&#x8BE5;&#x8868;&#x8FBE;&#x5F0F;&#x53EA;&#x9700;&#x8981;&#x5728;&#x5DF2;&#x7ECF;&#x52A0;&#x8F7D;&#x7684;&#x5B9E;&#x4F8B;&#x4E0A;&#x53EF;&#x7528;&#x3002;</span><span class="yiyi-st" id="yiyi-77">&#x8BE5;&#x51FD;&#x6570;&#x4F7F;&#x7528;Python&#x81EA;&#x5DF1;&#x7684;<code class="docutils literal"><span class="pre">@property</span></code>&#x4FEE;&#x9970;&#x5668;&#x8FDB;&#x884C;&#x4FEE;&#x9970;&#xFF0C;&#x4EE5;&#x5C06;&#x5176;&#x6807;&#x8BB0;&#x4E3A;&#x53EA;&#x8BFB;&#x5C5E;&#x6027;&#x3002;</span><span class="yiyi-st" id="yiyi-78">Within the function, <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.object_session" title="sqlalchemy.orm.session.object_session"><code class="xref py py-func docutils literal"><span class="pre">object_session()</span></code></a> is used to locate the <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> corresponding to the current object, which is then used to emit a query:</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">object_session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">func</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&apos;user&apos;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">firstname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">lastname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">address_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">scalar</span><span class="p">(</span>
                <span class="n">select</span><span class="p">([</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span><span class="o">.</span>\
                    <span class="n">where</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user_id</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="p">)</span></pre></div></div><p><span class="yiyi-st" id="yiyi-79">&#x666E;&#x901A;&#x63CF;&#x8FF0;&#x7B26;&#x65B9;&#x6CD5;&#x4F5C;&#x4E3A;&#x6700;&#x540E;&#x7684;&#x624B;&#x6BB5;&#x662F;&#x6709;&#x7528;&#x7684;&#xFF0C;&#x4F46;&#x5728;&#x901A;&#x5E38;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6DF7;&#x5408;&#x6027;&#x548C;&#x5217;&#x5C5E;&#x6027;&#x65B9;&#x6CD5;&#x7684;&#x6027;&#x80FD;&#x8F83;&#x5DEE;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x9700;&#x8981;&#x5728;&#x6BCF;&#x6B21;&#x8BBF;&#x95EE;&#x65F6;&#x53D1;&#x51FA;SQL&#x67E5;&#x8BE2;&#x3002;</span></p></div>