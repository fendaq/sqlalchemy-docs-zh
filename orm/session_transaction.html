<h1><span class="yiyi-st" id="yiyi-55">&#x4E8B;&#x52A1;&#x548C;&#x8FDE;&#x63A5;&#x7BA1;&#x7406;<a class="headerlink" href="#transactions-and-connection-management" title="Permalink to this headline">&#xB6;</a></span></h1><div class="section" id="managing-transactions"><h2><span class="yiyi-st" id="yiyi-56">&#x7BA1;&#x7406;&#x4EA4;&#x6613;<a class="headerlink" href="#managing-transactions" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-57">&#x53EF;&#x4EE5;&#x8BF4;&#x65B0;&#x6784;&#x5EFA;&#x7684;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x5904;&#x4E8E;&#x201C;&#x5F00;&#x59CB;&#x201D;&#x72B6;&#x6001;&#x3002;</span><span class="yiyi-st" id="yiyi-58">&#x5728;&#x6B64;&#x72B6;&#x6001;&#x4E0B;&#xFF0C;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x5C1A;&#x672A;&#x4E0E;&#x4EFB;&#x4F55;&#x53EF;&#x80FD;&#x4E0E;&#x5176;&#x5173;&#x8054;&#x7684;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x5BF9;&#x8C61;&#x5EFA;&#x7ACB;&#x4EFB;&#x4F55;&#x8FDE;&#x63A5;&#x6216;&#x4E8B;&#x52A1;&#x72B6;&#x6001;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-59">&#x7136;&#x540E;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x63A5;&#x6536;&#x8BF7;&#x6C42;&#x4EE5;&#x64CD;&#x4F5C;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;&#x3002;</span><span class="yiyi-st" id="yiyi-60">Typically, this means it is called upon to execute SQL statements using a particular <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>, which may be via <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.query" title="sqlalchemy.orm.session.Session.query"><code class="xref py py-meth docutils literal"><span class="pre">Session.query()</span></code></a>, <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.execute" title="sqlalchemy.orm.session.Session.execute"><code class="xref py py-meth docutils literal"><span class="pre">Session.execute()</span></code></a>, or within a flush operation of pending data, which occurs when such state exists and <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.commit" title="sqlalchemy.orm.session.Session.commit"><code class="xref py py-meth docutils literal"><span class="pre">Session.commit()</span></code></a> or <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.flush" title="sqlalchemy.orm.session.Session.flush"><code class="xref py py-meth docutils literal"><span class="pre">Session.flush()</span></code></a> is called.</span></p><p><span class="yiyi-st" id="yiyi-61">&#x5F53;&#x6536;&#x5230;&#x8FD9;&#x4E9B;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x9047;&#x5230;&#x7684;&#x6BCF;&#x4E2A;&#x65B0;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x90FD;&#x4E0E;&#x7531;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x7EF4;&#x62A4;&#x7684;&#x6B63;&#x5728;&#x8FDB;&#x884C;&#x7684;&#x4E8B;&#x52A1;&#x72B6;&#x6001;&#x76F8;&#x5173;&#x8054;&#x3002;</span><span class="yiyi-st" id="yiyi-62">&#x5F53;&#x64CD;&#x4F5C;&#x7B2C;&#x4E00;&#x4E2A;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x65F6;&#xFF0C;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x53EF;&#x4EE5;&#x8BF4;&#x5DF2;&#x7ECF;&#x79BB;&#x5F00;&#x201C;&#x5F00;&#x59CB;&#x201D;&#x72B6;&#x6001;&#x5E76;&#x8FDB;&#x5165;&#x201C;&#x4E8B;&#x52A1;&#x6027;&#x201D;&#x72B6;&#x6001;&#x3002;</span><span class="yiyi-st" id="yiyi-63">&#x5BF9;&#x4E8E;&#x9047;&#x5230;&#x7684;&#x6BCF;&#x4E2A;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#xFF0C;&#x90FD;&#x6709;&#x4E00;&#x4E2A;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a>&#x4E0E;&#x5B83;&#x5173;&#x8054;&#xFF0C;&#x5B83;&#x901A;&#x8FC7;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine.contextual_connect" title="sqlalchemy.engine.Engine.contextual_connect"><code class="xref py py-meth docutils literal"><span class="pre">Engine.contextual_connect()</span></code></a>&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x3002;</span><span class="yiyi-st" id="yiyi-64">&#x5982;&#x679C;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a>&#x76F4;&#x63A5;&#x4E0E;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x76F8;&#x5173;&#x8054;&#xFF08;&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="#session-external-transaction"><span>Joining a Session into an External Transaction (such as for test suites)</span></a>&#x8FD9;&#x4E2A;&#xFF09;&#xFF0C;&#x5B83;&#x88AB;&#x76F4;&#x63A5;&#x6DFB;&#x52A0;&#x5230;&#x4E8B;&#x52A1;&#x72B6;&#x6001;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-65">&#x5BF9;&#x4E8E;&#x6BCF;&#x4E2A;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a>&#xFF0C;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x8FD8;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Transaction" title="sqlalchemy.engine.Transaction"><code class="xref py py-class docutils literal"><span class="pre">Transaction</span></code></a>&#x5BF9;&#x8C61;&#xFF0C;&#x8BE5;&#x5BF9;&#x8C61;&#x901A;&#x8FC7;&#x8C03;&#x7528;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection.begin" title="sqlalchemy.engine.Connection.begin"><code class="xref py py-meth docutils literal"><span class="pre">Connection.begin()</span></code></a>&#x5728;&#x6BCF;&#x4E2A;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a>&#x4E0A;&#xFF0C;&#x6216;&#x8005;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x4F7F;&#x7528;&#x6807;&#x8BB0;<code class="docutils literal"><span class="pre">twophase=True</span></code>&#x5EFA;&#x7ACB;&#x4E86;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x5BF9;&#x8C61;&#xFF0C;&#x5219;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.TwoPhaseTransaction" title="sqlalchemy.engine.TwoPhaseTransaction"><code class="xref py py-class docutils literal"><span class="pre">TwoPhaseTransaction</span></code></a>&#x5BF9;&#x8C61;&#x901A;&#x8FC7;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection.begin_twophase" title="sqlalchemy.engine.Connection.begin_twophase"><code class="xref py py-meth docutils literal"><span class="pre">Connection.begin_twophase()</span></code></a>&#x83B7;&#x53D6;&#x3002;</span><span class="yiyi-st" id="yiyi-66">&#x8FD9;&#x4E9B;&#x4E8B;&#x52A1;&#x5168;&#x90E8;&#x88AB;&#x63D0;&#x4EA4;&#x6216;&#x56DE;&#x6EDA;&#xFF0C;&#x5BF9;&#x5E94;&#x4E8E;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.commit" title="sqlalchemy.orm.session.Session.commit"><code class="xref py py-meth docutils literal"><span class="pre">Session.commit()</span></code></a>&#x548C;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.rollback" title="sqlalchemy.orm.session.Session.rollback"><code class="xref py py-meth docutils literal"><span class="pre">Session.rollback()</span></code></a>&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x3002;</span><span class="yiyi-st" id="yiyi-67">&#x5982;&#x679C;&#x9002;&#x7528;&#xFF0C;&#x63D0;&#x4EA4;&#x64CD;&#x4F5C;&#x8FD8;&#x4F1A;&#x5BF9;&#x6240;&#x6709;&#x4E8B;&#x52A1;&#x8C03;&#x7528;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.TwoPhaseTransaction.prepare" title="sqlalchemy.engine.TwoPhaseTransaction.prepare"><code class="xref py py-meth docutils literal"><span class="pre">TwoPhaseTransaction.prepare()</span></code></a>&#x65B9;&#x6CD5;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-68">When the transactional state is completed after a rollback or commit, the <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> <a class="reference internal" href="glossary.html#term-releases"><span class="xref std std-term">releases</span></a> all <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Transaction" title="sqlalchemy.engine.Transaction"><code class="xref py py-class docutils literal"><span class="pre">Transaction</span></code></a> and <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a> resources, and goes back to the &#x201C;begin&#x201D; state, which will again invoke new <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a> and <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Transaction" title="sqlalchemy.engine.Transaction"><code class="xref py py-class docutils literal"><span class="pre">Transaction</span></code></a> objects as new requests to emit SQL statements are received.</span></p><p><span class="yiyi-st" id="yiyi-69">&#x4E0B;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x8BF4;&#x660E;&#x4E86;&#x8FD9;&#x4E2A;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="c1"># new session.   no connections are in use.</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># first query.  a Connection is acquired</span>
    <span class="c1"># from the Engine, and a Transaction</span>
    <span class="c1"># started.</span>
    <span class="n">item1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Item</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># second query.  the same Connection/Transaction</span>
    <span class="c1"># are used.</span>
    <span class="n">item2</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Item</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># pending changes are created.</span>
    <span class="n">item1</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s1">&apos;bar&apos;</span>
    <span class="n">item2</span><span class="o">.</span><span class="n">bar</span> <span class="o">=</span> <span class="s1">&apos;foo&apos;</span>

    <span class="c1"># commit.  The pending changes above</span>
    <span class="c1"># are flushed via flush(), the Transaction</span>
    <span class="c1"># is committed, the Connection object closed</span>
    <span class="c1"># and discarded, the underlying DBAPI connection</span>
    <span class="c1"># returned to the connection pool.</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># on rollback, the same closure of state</span>
    <span class="c1"># as that of commit proceeds.</span>
    <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="k">raise</span></pre></div></div><div class="section" id="using-savepoint"><h3><span class="yiyi-st" id="yiyi-70">&#x4F7F;&#x7528;SAVEPOINT <a class="headerlink" href="#using-savepoint" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-71">&#x5982;&#x679C;&#x5E95;&#x5C42;&#x5F15;&#x64CE;&#x652F;&#x6301;SAVEPOINT&#x4E8B;&#x52A1;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.begin_nested" title="sqlalchemy.orm.session.Session.begin_nested"><code class="xref py py-meth docutils literal"><span class="pre">begin_nested()</span></code></a>&#x65B9;&#x6CD5;&#x63CF;&#x8FF0;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span>

<span class="n">session</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span> <span class="c1"># establish a savepoint</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">u3</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>  <span class="c1"># rolls back u3, keeps u1 and u2</span>

<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span> <span class="c1"># commits u1 and u2</span></pre></div></div><p><span class="yiyi-st" id="yiyi-72"><a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.begin_nested" title="sqlalchemy.orm.session.Session.begin_nested"><code class="xref py py-meth docutils literal"><span class="pre">begin_nested()</span></code></a> may be called any number of times, which will issue a new SAVEPOINT with a unique identifier for each call. </span><span class="yiyi-st" id="yiyi-73">&#x5BF9;&#x4E8E;&#x6BCF;&#x4E2A;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.begin_nested" title="sqlalchemy.orm.session.Session.begin_nested"><code class="xref py py-meth docutils literal"><span class="pre">begin_nested()</span></code></a>&#x8C03;&#x7528;&#xFF0C;&#x5FC5;&#x987B;&#x53D1;&#x51FA;&#x76F8;&#x5E94;&#x7684;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.rollback" title="sqlalchemy.orm.session.Session.rollback"><code class="xref py py-meth docutils literal"><span class="pre">rollback()</span></code></a>&#x6216;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.commit" title="sqlalchemy.orm.session.Session.commit"><code class="xref py py-meth docutils literal"><span class="pre">commit()</span></code></a>&#x3002;</span><span class="yiyi-st" id="yiyi-74">&#xFF08;&#x4F46;&#x662F;&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5982;&#x679C;&#x8FD4;&#x56DE;&#x503C;&#x7528;&#x4F5C;&#x4E0A;&#x4E0B;&#x6587;&#x7BA1;&#x7406;&#x5668;&#xFF0C;&#x5373;&#x5728;with-statement&#x4E2D;&#xFF0C;&#x5219;&#x6B64;&#x9000;&#x56DE;/&#x63D0;&#x4EA4;&#x7531;&#x4E0A;&#x4E0B;&#x6587;&#x7BA1;&#x7406;&#x5668;&#x5728;&#x9000;&#x51FA;&#x4E0A;&#x4E0B;&#x6587;&#x65F6;&#x53D1;&#x51FA;&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x5E94;&#x663E;&#x5F0F;&#x6DFB;&#x52A0;&#x3002;&#xFF09;</span></p><p><span class="yiyi-st" id="yiyi-75">&#x5F53;&#x8C03;&#x7528;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.begin_nested" title="sqlalchemy.orm.session.Session.begin_nested"><code class="xref py py-meth docutils literal"><span class="pre">begin_nested()</span></code></a>&#x65F6;&#xFF0C;&#x5C06;&#x65E0;&#x6761;&#x4EF6;&#x53D1;&#x5E03;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.flush" title="sqlalchemy.orm.session.Session.flush"><code class="xref py py-meth docutils literal"><span class="pre">flush()</span></code></a>&#xFF08;&#x4E0D;&#x7BA1;<code class="docutils literal"><span class="pre">autoflush</span></code>&#x8BBE;&#x7F6E;&#x5982;&#x4F55;&#xFF09;&#x3002;</span><span class="yiyi-st" id="yiyi-76">&#x8FD9;&#x662F;&#x4E3A;&#x4E86;&#x5F53;&#x53D1;&#x751F;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.rollback" title="sqlalchemy.orm.session.Session.rollback"><code class="xref py py-meth docutils literal"><span class="pre">rollback()</span></code></a>&#x65F6;&#xFF0C;&#x4F1A;&#x8BDD;&#x7684;&#x5B8C;&#x6574;&#x72B6;&#x6001;&#x5DF2;&#x8FC7;&#x671F;&#xFF0C;&#x4ECE;&#x800C;&#x5BFC;&#x81F4;&#x6240;&#x6709;&#x540E;&#x7EED;&#x7684;&#x5C5E;&#x6027;/&#x5B9E;&#x4F8B;&#x8BBF;&#x95EE;&#x90FD;&#x5F15;&#x7528;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x7684;&#x5B8C;&#x6574;&#x72B6;&#x6001;&#x5728;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.begin_nested" title="sqlalchemy.orm.session.Session.begin_nested"><code class="xref py py-meth docutils literal"><span class="pre">begin_nested()</span></code></a>&#x4E4B;&#x524D;&#x88AB;&#x8C03;&#x7528;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-77"><a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.begin_nested" title="sqlalchemy.orm.session.Session.begin_nested"><code class="xref py py-meth docutils literal"><span class="pre">begin_nested()</span></code></a>, in the same manner as the less often used <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.begin" title="sqlalchemy.orm.session.Session.begin"><code class="xref py py-meth docutils literal"><span class="pre">begin()</span></code></a> method, returns a transactional object which also works as a context manager. </span><span class="yiyi-st" id="yiyi-78">&#x5B83;&#x53EF;&#x4EE5;&#x7B80;&#x6D01;&#x5730;&#x7528;&#x4E8E;&#x5355;&#x4E2A;&#x8BB0;&#x5F55;&#x63D2;&#x5165;&#xFF0C;&#x4EE5;&#x4FBF;&#x6355;&#x83B7;&#x552F;&#x4E00;&#x7EA6;&#x675F;&#x4F8B;&#x5916;&#x7B49;&#x60C5;&#x51B5;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">():</span>
            <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Skipped record </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">record</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div></div></div><div class="section" id="autocommit-mode"><h3><span class="yiyi-st" id="yiyi-79">&#x81EA;&#x52A8;&#x63D0;&#x4EA4;&#x6A21;&#x5F0F;<a class="headerlink" href="#autocommit-mode" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-80">The example of <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> transaction lifecycle illustrated at the start of <a class="reference internal" href="#unitofwork-transaction"><span>Managing Transactions</span></a> applies to a <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> configured in the default mode of <code class="docutils literal"><span class="pre">autocommit=False</span></code>. </span><span class="yiyi-st" id="yiyi-81">Constructing a <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> with <code class="docutils literal"><span class="pre">autocommit=True</span></code> produces a <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> placed into &#x201C;autocommit&#x201D; mode, where each SQL statement invoked by a <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.query" title="sqlalchemy.orm.session.Session.query"><code class="xref py py-meth docutils literal"><span class="pre">Session.query()</span></code></a> or <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.execute" title="sqlalchemy.orm.session.Session.execute"><code class="xref py py-meth docutils literal"><span class="pre">Session.execute()</span></code></a> occurs using a new connection from the connection pool, discarding it after results have been iterated. </span><span class="yiyi-st" id="yiyi-82"><a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.flush" title="sqlalchemy.orm.session.Session.flush"><code class="xref py py-meth docutils literal"><span class="pre">Session.flush()</span></code></a>&#x64CD;&#x4F5C;&#x4ECD;&#x7136;&#x53D1;&#x751F;&#x5728;&#x5355;&#x4E2A;&#x4E8B;&#x52A1;&#x7684;&#x8303;&#x56F4;&#x5185;&#xFF0C;&#x5C3D;&#x7BA1;&#x6B64;&#x4E8B;&#x52A1;&#x5728;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.flush" title="sqlalchemy.orm.session.Session.flush"><code class="xref py py-meth docutils literal"><span class="pre">Session.flush()</span></code></a>&#x64CD;&#x4F5C;&#x5B8C;&#x6210;&#x540E;&#x5173;&#x95ED;&#x3002;</span></p><div class="admonition warning"><p class="first admonition-title"><span class="yiyi-st" id="yiyi-83">&#x8B66;&#x544A;</span></p><p><span class="yiyi-st" id="yiyi-84">&#x201C;autocommit&#x201D; mode should <strong>not be considered for general use</strong>. </span><span class="yiyi-st" id="yiyi-85">&#x5982;&#x679C;&#x4F7F;&#x7528;&#xFF0C;&#x5B83;&#x5E94;&#x8BE5;&#x603B;&#x662F;&#x4E0E;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.begin" title="sqlalchemy.orm.session.Session.begin"><code class="xref py py-meth docutils literal"><span class="pre">Session.begin()</span></code></a>&#x548C;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.commit" title="sqlalchemy.orm.session.Session.commit"><code class="xref py py-meth docutils literal"><span class="pre">Session.commit()</span></code></a>&#x7684;&#x7528;&#x6CD5;&#x76F8;&#x7ED3;&#x5408;&#xFF0C;&#x4EE5;&#x786E;&#x4FDD;&#x4E8B;&#x52A1;&#x5212;&#x5206;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-86">&#x5728;&#x5212;&#x5B9A;&#x7684;&#x4E8B;&#x52A1;&#x4E4B;&#x5916;&#x6267;&#x884C;&#x67E5;&#x8BE2;&#x662F;&#x4F20;&#x7EDF;&#x7684;&#x4F7F;&#x7528;&#x6A21;&#x5F0F;&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x67D0;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#x53EF;&#x80FD;&#x4F1A;&#x5BFC;&#x81F4;&#x5E76;&#x53D1;&#x8FDE;&#x63A5;&#x68C0;&#x51FA;&#x3002;</span></p><p class="last"><span class="yiyi-st" id="yiyi-87">&#x5728;&#x6CA1;&#x6709;&#x5212;&#x5206;&#x7684;&#x4E8B;&#x52A1;&#x65F6;&#xFF0C;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x65E0;&#x6CD5;&#x5C31;&#x81EA;&#x52A8;&#x5C4F;&#x853D;&#x4F55;&#x65F6;&#x53D1;&#x751F;&#x4EE5;&#x53CA;&#x4F55;&#x65F6;&#x5E94;&#x8BE5;&#x53D1;&#x751F;&#x81EA;&#x52A8;&#x8FC7;&#x671F;&#x505A;&#x51FA;&#x9002;&#x5F53;&#x7684;&#x51B3;&#x5B9A;&#xFF0C;&#x56E0;&#x6B64;&#x5E94;&#x4F7F;&#x7528;<code class="docutils literal"><span class="pre">autoflush =&#x5047;&#xFF0C;</span> <span class="pre">expire_on_commit =&#x5047;</span></code>&#x3002;</span></p></div><p><span class="yiyi-st" id="yiyi-88">&#x201C;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;&#x201D;&#x7684;&#x73B0;&#x4EE3;&#x7528;&#x6CD5;&#x9002;&#x7528;&#x4E8E;&#x9700;&#x8981;&#x5728;&#x201C;&#x5F00;&#x59CB;&#x201D;&#x72B6;&#x6001;&#x53D1;&#x751F;&#x65F6;&#x4E13;&#x95E8;&#x63A7;&#x5236;&#x7684;&#x6846;&#x67B6;&#x96C6;&#x6210;&#x3002;</span><span class="yiyi-st" id="yiyi-89">&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.begin" title="sqlalchemy.orm.session.Session.begin"><code class="xref py py-meth docutils literal"><span class="pre">Session.begin()</span></code></a>&#x65B9;&#x6CD5;&#x5C06;<code class="docutils literal"><span class="pre">autocommit=True</span></code>&#x914D;&#x7F6E;&#x7684;&#x4F1A;&#x8BDD;&#x7F6E;&#x4E8E;&#x201C;&#x5F00;&#x59CB;&#x201D;&#x72B6;&#x6001;&#x3002;</span><span class="yiyi-st" id="yiyi-90">After the cycle completes upon <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.commit" title="sqlalchemy.orm.session.Session.commit"><code class="xref py py-meth docutils literal"><span class="pre">Session.commit()</span></code></a> or <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.rollback" title="sqlalchemy.orm.session.Session.rollback"><code class="xref py py-meth docutils literal"><span class="pre">Session.rollback()</span></code></a>, connection and transaction resources are <a class="reference internal" href="glossary.html#term-released"><span class="xref std std-term">released</span></a> and the <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> goes back into &#x201C;autocommit&#x201D; mode, until <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.begin" title="sqlalchemy.orm.session.Session.begin"><code class="xref py py-meth docutils literal"><span class="pre">Session.begin()</span></code></a> is called again:</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">item1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Item</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">item2</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Item</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">item1</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s1">&apos;bar&apos;</span>
    <span class="n">item2</span><span class="o">.</span><span class="n">bar</span> <span class="o">=</span> <span class="s1">&apos;foo&apos;</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="k">raise</span></pre></div></div><p><span class="yiyi-st" id="yiyi-91"><a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.begin" title="sqlalchemy.orm.session.Session.begin"><code class="xref py py-meth docutils literal"><span class="pre">Session.begin()</span></code></a>&#x65B9;&#x6CD5;&#x8FD8;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x6807;&#x8BB0;&#xFF0C;&#x8BE5;&#x6807;&#x8BB0;&#x4E0E;Python 2.6 <code class="docutils literal"><span class="pre">with</span></code>&#x8BED;&#x53E5;&#x517C;&#x5BB9;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
    <span class="n">item1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Item</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">item2</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Item</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">item1</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s1">&apos;bar&apos;</span>
    <span class="n">item2</span><span class="o">.</span><span class="n">bar</span> <span class="o">=</span> <span class="s1">&apos;foo&apos;</span></pre></div></div><div class="section" id="using-subtransactions-with-autocommit"><h4><span class="yiyi-st" id="yiyi-92">&#x5BF9;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;&#x4F7F;&#x7528;Subtransactions <a class="headerlink" href="#using-subtransactions-with-autocommit" title="Permalink to this headline">&#xB6;</a></span></h4><p><span class="yiyi-st" id="yiyi-93">&#x5B50;&#x4E8B;&#x52A1;&#x8868;&#x793A;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.begin" title="sqlalchemy.orm.session.Session.begin"><code class="xref py py-meth docutils literal"><span class="pre">Session.begin()</span></code></a>&#x65B9;&#x6CD5;&#x4E0E;<code class="docutils literal"><span class="pre">subtransactions=True</span></code>&#x6807;&#x5FD7;&#x7684;&#x7ED3;&#x5408;&#x4F7F;&#x7528;&#x3002;</span><span class="yiyi-st" id="yiyi-94">&#x8FD9;&#x4EA7;&#x751F;&#x4E86;&#x4E00;&#x4E2A;&#x975E;&#x4E8B;&#x52A1;&#x6027;&#x7684;&#x5206;&#x9694;&#x7ED3;&#x6784;&#xFF0C;&#x5141;&#x8BB8;&#x5C06;&#x8C03;&#x7528;&#x5D4C;&#x5957;&#x5230;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.begin" title="sqlalchemy.orm.session.Session.begin"><code class="xref py py-meth docutils literal"><span class="pre">begin()</span></code></a>&#x548C;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.commit" title="sqlalchemy.orm.session.Session.commit"><code class="xref py py-meth docutils literal"><span class="pre">commit()</span></code></a>&#x3002;</span><span class="yiyi-st" id="yiyi-95">&#x5B83;&#x7684;&#x76EE;&#x7684;&#x662F;&#x5141;&#x8BB8;&#x6784;&#x5EFA;&#x53EF;&#x4EE5;&#x5728;&#x4E8B;&#x52A1;&#x5185;&#x8FD0;&#x884C;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x800C;&#x4E0D;&#x4F9D;&#x8D56;&#x4E8E;&#x4EFB;&#x4F55;&#x542F;&#x52A8;&#x4E8B;&#x52A1;&#x7684;&#x5916;&#x90E8;&#x4EE3;&#x7801;&#xFF0C;&#x4EE5;&#x53CA;&#x5728;&#x5DF2;&#x7ECF;&#x5212;&#x5B9A;&#x4E8B;&#x52A1;&#x7684;&#x5757;&#x5185;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-96"><code class="docutils literal"><span class="pre">subtransactions=True</span></code> is generally only useful in conjunction with autocommit, and is equivalent to the pattern described at <a class="reference internal" href="core_connections.html#connections-nested-transactions"><span>Nesting of Transaction Blocks</span></a>, where any number of functions can call <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection.begin" title="sqlalchemy.engine.Connection.begin"><code class="xref py py-meth docutils literal"><span class="pre">Connection.begin()</span></code></a> and <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Transaction.commit" title="sqlalchemy.engine.Transaction.commit"><code class="xref py py-meth docutils literal"><span class="pre">Transaction.commit()</span></code></a> as though they are the initiator of the transaction, but in fact may be participating in an already ongoing transaction:</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># method_a starts a transaction and calls method_b</span>
<span class="k">def</span> <span class="nf">method_a</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="n">session</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">subtransactions</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">method_b</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># transaction is committed here</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span> <span class="c1"># rolls back the transaction</span>
        <span class="k">raise</span>

<span class="c1"># method_b also starts a transaction, but when</span>
<span class="c1"># called from method_a participates in the ongoing</span>
<span class="c1"># transaction.</span>
<span class="k">def</span> <span class="nf">method_b</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="n">session</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">subtransactions</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">SomeObject</span><span class="p">(</span><span class="s1">&apos;bat&apos;</span><span class="p">,</span> <span class="s1">&apos;lala&apos;</span><span class="p">))</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># transaction is not committed yet</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span> <span class="c1"># rolls back the transaction, in this case</span>
                           <span class="c1"># the one that was initiated in method_a().</span>
        <span class="k">raise</span>

<span class="c1"># create a Session and call method_a</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">autocommit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">method_a</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div></div><p><span class="yiyi-st" id="yiyi-97">&#x5B50;&#x8FDB;&#x7A0B;&#x4F7F;&#x7528;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.flush" title="sqlalchemy.orm.session.Session.flush"><code class="xref py py-meth docutils literal"><span class="pre">Session.flush()</span></code></a>&#x8FDB;&#x7A0B;&#x6765;&#x786E;&#x4FDD;&#x5237;&#x65B0;&#x64CD;&#x4F5C;&#x53D1;&#x751F;&#x5728;&#x4E8B;&#x52A1;&#x4E2D;&#xFF0C;&#x800C;&#x4E0D;&#x7BA1;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;&#x3002;</span><span class="yiyi-st" id="yiyi-98">&#x5F53;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;&#x88AB;&#x7981;&#x7528;&#x65F6;&#xFF0C;&#x5B83;&#x4ECD;&#x7136;&#x6709;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x5F3A;&#x5236;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x8FDB;&#x5165;&#x201C;&#x6302;&#x8D77;&#x56DE;&#x6EDA;&#x201D;&#x72B6;&#x6001;&#xFF0C;&#x56E0;&#x4E3A;&#x5931;&#x8D25;&#x7684;&#x5237;&#x65B0;&#x65E0;&#x6CD5;&#x5728;&#x64CD;&#x4F5C;&#x4E2D;&#x6062;&#x590D;&#xFF0C;&#x6700;&#x7EC8;&#x7528;&#x6237;&#x4ECD;&#x7136;&#x7EF4;&#x6301;&#x201C;&#x6574;&#x4E2A;&#x4EA4;&#x6613;&#x7684;&#x8303;&#x56F4;&#x201C;&#x3002;</span></p></div></div><div class="section" id="enabling-two-phase-commit"><h3><span class="yiyi-st" id="yiyi-99">&#x542F;&#x7528;&#x4E24;&#x9636;&#x6BB5;&#x63D0;&#x4EA4;<a class="headerlink" href="#enabling-two-phase-commit" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-100">&#x5BF9;&#x4E8E;&#x652F;&#x6301;&#x4E24;&#x9636;&#x6BB5;&#x64CD;&#x4F5C;&#x7684;&#x540E;&#x7AEF;&#xFF08;&#x5F53;&#x524D;MySQL&#x548C;PostgreSQL&#xFF09;&#xFF0C;&#x53EF;&#x4EE5;&#x6307;&#x793A;&#x4F1A;&#x8BDD;&#x4F7F;&#x7528;&#x4E24;&#x9636;&#x6BB5;&#x63D0;&#x4EA4;&#x8BED;&#x4E49;&#x3002;</span><span class="yiyi-st" id="yiyi-101">&#x8FD9;&#x5C06;&#x534F;&#x8C03;&#x8DE8;&#x6570;&#x636E;&#x5E93;&#x7684;&#x4E8B;&#x52A1;&#x63D0;&#x4EA4;&#xFF0C;&#x4EE5;&#x4FBF;&#x5728;&#x6240;&#x6709;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x63D0;&#x4EA4;&#x6216;&#x56DE;&#x6EDA;&#x4E8B;&#x52A1;&#x3002;</span><span class="yiyi-st" id="yiyi-102">&#x60A8;&#x8FD8;&#x53EF;&#x4EE5;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.prepare" title="sqlalchemy.orm.session.Session.prepare"><code class="xref py py-meth docutils literal"><span class="pre">prepare()</span></code></a>&#x4F1A;&#x8BDD;&#x4EE5;&#x4E0E;&#x672A;&#x7531;SQLAlchemy&#x7BA1;&#x7406;&#x7684;&#x4EA4;&#x6613;&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#x3002;</span><span class="yiyi-st" id="yiyi-103">&#x8981;&#x4F7F;&#x7528;&#x4E24;&#x9636;&#x6BB5;&#x4E8B;&#x52A1;&#xFF0C;&#x8BF7;&#x5728;&#x4F1A;&#x8BDD;&#x4E2D;&#x8BBE;&#x7F6E;&#x6807;&#x5FD7;<code class="docutils literal"><span class="pre">twophase=True</span></code>&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">engine1</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&apos;postgresql://db1&apos;</span><span class="p">)</span>
<span class="n">engine2</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&apos;postgresql://db2&apos;</span><span class="p">)</span>

<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">twophase</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># bind User operations to engine 1, Account operations to engine 2</span>
<span class="n">Session</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">binds</span><span class="o">=</span><span class="p">{</span><span class="n">User</span><span class="p">:</span><span class="n">engine1</span><span class="p">,</span> <span class="n">Account</span><span class="p">:</span><span class="n">engine2</span><span class="p">})</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

<span class="c1"># .... work with accounts and users</span>

<span class="c1"># commit.  session will issue a flush to all DBs, and a prepare step to all DBs,</span>
<span class="c1"># before committing both transactions</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div></div></div><div class="section" id="setting-transaction-isolation-levels"><h3><span class="yiyi-st" id="yiyi-104">&#x8BBE;&#x7F6E;&#x4E8B;&#x52A1;&#x9694;&#x79BB;&#x7EA7;&#x522B;<a class="headerlink" href="#setting-transaction-isolation-levels" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-105"><a class="reference internal" href="glossary.html#term-isolation"><span class="xref std std-term">Isolation</span></a> refers to the behavior of the transaction at the database level in relation to other transactions occurring concurrently. </span><span class="yiyi-st" id="yiyi-106">&#x6709;&#x56DB;&#x79CD;&#x4F17;&#x6240;&#x5468;&#x77E5;&#x7684;&#x9694;&#x79BB;&#x6A21;&#x5F0F;&#xFF0C;&#x901A;&#x5E38;Python DBAPI&#x5141;&#x8BB8;&#x901A;&#x8FC7;&#x660E;&#x786E;&#x7684;API&#x6216;&#x901A;&#x8FC7;&#x7279;&#x5B9A;&#x4E8E;&#x6570;&#x636E;&#x5E93;&#x7684;&#x8C03;&#x7528;&#x6765;&#x57FA;&#x4E8E;&#x6BCF;&#x4E2A;&#x8FDE;&#x63A5;&#x6765;&#x8BBE;&#x7F6E;&#x8FD9;&#x4E9B;&#x6A21;&#x5F0F;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-107">SQLAlchemy&#x7684;&#x65B9;&#x8A00;&#x5728;&#x6BCF;&#x4E2A;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x6216;per <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a>&#x57FA;&#x7840;&#x4E0A;&#x652F;&#x6301;&#x53EF;&#x8BBE;&#x7F6E;&#x7684;&#x9694;&#x79BB;&#x6A21;&#x5F0F;&#xFF0C;&#x5728;<a class="reference internal" href="core_engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal"><span class="pre">create_engine()</span></code></a>&#x5728;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection.execution_options" title="sqlalchemy.engine.Connection.execution_options"><code class="xref py py-meth docutils literal"><span class="pre">Connection.execution_options()</span></code></a>&#x7EA7;&#x522B;&#x3002;</span></p><p><span class="yiyi-st" id="yiyi-108">&#x5F53;&#x4F7F;&#x7528;ORM <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x65F6;&#xFF0C;&#x5B83;&#x5145;&#x5F53;&#x5F15;&#x64CE;&#x548C;&#x8FDE;&#x63A5;&#x7684;<em>&#x5916;&#x89C2;</em>&#xFF0C;&#x4F46;&#x4E0D;&#x76F4;&#x63A5;&#x66B4;&#x9732;&#x4E8B;&#x52A1;&#x9694;&#x79BB;&#x3002;</span><span class="yiyi-st" id="yiyi-109">&#x56E0;&#x6B64;&#xFF0C;&#x4E3A;&#x4E86;&#x5F71;&#x54CD;&#x4E8B;&#x52A1;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x6839;&#x636E;&#x60C5;&#x51B5;&#x5BF9;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x6216;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a>&#x6267;&#x884C;&#x64CD;&#x4F5C;&#x3002;</span></p><div class="admonition seealso"><p class="first admonition-title"><span class="yiyi-st" id="yiyi-110">&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x770B;</span></p><p><span class="yiyi-st" id="yiyi-111"><a class="reference internal" href="core_engines.html#sqlalchemy.create_engine.params.isolation_level" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal"><span class="pre">create_engine.isolation_level</span></code></a></span></p><p><span class="yiyi-st" id="yiyi-112"><a class="reference internal" href="dialects_sqlite.html#sqlite-isolation-level"><span>SQLite Transaction Isolation</span></a></span></p><p><span class="yiyi-st" id="yiyi-113"><a class="reference internal" href="dialects_postgresql.html#postgresql-isolation-level"><span>Postgresql Isolation Level</span></a></span></p><p class="last"><span class="yiyi-st" id="yiyi-114"><a class="reference internal" href="dialects_mysql.html#mysql-isolation-level"><span>MySQL Isolation Level</span></a></span></p></div><div class="section" id="setting-isolation-engine-wide"><h4><span class="yiyi-st" id="yiyi-115">&#x8BBE;&#x7F6E;&#x9694;&#x79BB;&#x5F15;&#x64CE;&#x8303;&#x56F4;<a class="headerlink" href="#setting-isolation-engine-wide" title="Permalink to this headline">&#xB6;</a></span></h4><p><span class="yiyi-st" id="yiyi-116">&#x8981;&#x5728;&#x5168;&#x5C40;&#x8303;&#x56F4;&#x5185;&#x8BBE;&#x7F6E;&#x5177;&#x6709;&#x7279;&#x5B9A;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x7684;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x6216;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.sessionmaker" title="sqlalchemy.orm.session.sessionmaker"><code class="xref py py-class docutils literal"><span class="pre">sessionmaker</span></code></a>&#xFF0C;&#x8BF7;&#x4F7F;&#x7528;<a class="reference internal" href="core_engines.html#sqlalchemy.create_engine.params.isolation_level" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal"><span class="pre">create_engine.isolation_level</span></code></a>&#x53C2;&#x6570;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>

<span class="n">eng</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span>
    <span class="s2">&quot;postgresql://scott:tiger@localhost/test&quot;</span><span class="p">,</span>
    <span class="n">isolation_level</span><span class="o">=</span><span class="s1">&apos;REPEATABLE_READ&apos;</span><span class="p">)</span>

<span class="n">maker</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">eng</span><span class="p">)</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">maker</span><span class="p">()</span></pre></div></div></div><div class="section" id="setting-isolation-for-individual-sessions"><h4><span class="yiyi-st" id="yiyi-117">&#x4E3A;&#x5355;&#x4E2A;&#x4F1A;&#x8BDD;&#x8BBE;&#x7F6E;&#x9694;&#x79BB;<a class="headerlink" href="#setting-isolation-for-individual-sessions" title="Permalink to this headline">&#xB6;</a></span></h4><p><span class="yiyi-st" id="yiyi-118">&#x5F53;&#x6211;&#x4EEC;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x65F6;&#xFF0C;&#x65E0;&#x8BBA;&#x662F;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x8FD8;&#x662F;&#x5F53;&#x6211;&#x4EEC;&#x8C03;&#x7528;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.sessionmaker" title="sqlalchemy.orm.session.sessionmaker"><code class="xref py py-class docutils literal"><span class="pre">sessionmaker</span></code></a>&#x751F;&#x6210;&#x7684;&#x53EF;&#x8C03;&#x7528;&#x5BF9;&#x8C61;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x90FD;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code class="docutils literal"><span class="pre">bind</span></code>&#x76F4;&#x63A5;&#x53C2;&#x6570;&#xFF0C;&#x8986;&#x76D6;&#x5DF2;&#x6709;&#x7684;&#x7ED1;&#x5B9A;&#x3002;</span><span class="yiyi-st" id="yiyi-119">&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06;&#x5176;&#x4E0E;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine.execution_options" title="sqlalchemy.engine.Engine.execution_options"><code class="xref py py-meth docutils literal"><span class="pre">Engine.execution_options()</span></code></a>&#x65B9;&#x6CD5;&#x7ED3;&#x5408;&#x4F7F;&#x7528;&#xFF0C;&#x4EE5;&#x751F;&#x6210;&#x539F;&#x59CB;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal"><span class="pre">Engine</span></code></a>&#x7684;&#x526F;&#x672C;&#xFF0C;&#x4EE5;&#x6DFB;&#x52A0;&#x6B64;&#x9009;&#x9879;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">session</span> <span class="o">=</span> <span class="n">maker</span><span class="p">(</span>
    <span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">isolation_level</span><span class="o">=</span><span class="s1">&apos;SERIALIZABLE&apos;</span><span class="p">))</span></pre></div></div><p><span class="yiyi-st" id="yiyi-120">&#x5BF9;&#x4E8E;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x6216;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.sessionmaker" title="sqlalchemy.orm.session.sessionmaker"><code class="xref py py-class docutils literal"><span class="pre">sessionmaker</span></code></a>&#x914D;&#x7F6E;&#x4E86;&#x591A;&#x4E2A;&#x201C;&#x7ED1;&#x5B9A;&#x201D;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5B8C;&#x5168;&#x91CD;&#x65B0;&#x6307;&#x5B9A;<code class="docutils literal"><span class="pre">binds</span></code>&#x53C2;&#x6570;&#xFF0C;&#x6216;&#x8005;if&#x6211;&#x4EEC;&#x53EA;&#x60F3;&#x66FF;&#x6362;&#x7279;&#x5B9A;&#x7684;&#x7ED1;&#x5B9A;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.bind_mapper" title="sqlalchemy.orm.session.Session.bind_mapper"><code class="xref py py-meth docutils literal"><span class="pre">Session.bind_mapper()</span></code></a>&#x6216;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.bind_table" title="sqlalchemy.orm.session.Session.bind_table"><code class="xref py py-meth docutils literal"><span class="pre">Session.bind_table()</span></code></a>&#x65B9;&#x6CD5;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">session</span> <span class="o">=</span> <span class="n">maker</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">bind_mapper</span><span class="p">(</span>
    <span class="n">User</span><span class="p">,</span> <span class="n">user_engine</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">isolation_level</span><span class="o">=</span><span class="s1">&apos;SERIALIZABLE&apos;</span><span class="p">))</span></pre></div></div><p><span class="yiyi-st" id="yiyi-121">&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#x7684;&#x5355;&#x4E2A;&#x4EA4;&#x6613;&#x65B9;&#x6CD5;&#x3002;</span></p></div><div class="section" id="setting-isolation-for-individual-transactions"><h4><span class="yiyi-st" id="yiyi-122">&#x8BBE;&#x7F6E;&#x5355;&#x4E2A;&#x4E8B;&#x52A1;&#x7684;&#x9694;&#x79BB;<a class="headerlink" href="#setting-isolation-for-individual-transactions" title="Permalink to this headline">&#xB6;</a></span></h4><p><span class="yiyi-st" id="yiyi-123">&#x5173;&#x4E8E;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#x7684;&#x4E00;&#x4E2A;&#x5173;&#x952E;&#x8B66;&#x544A;&#x662F;&#x8BE5;&#x8BBE;&#x7F6E;&#x65E0;&#x6CD5;&#x5728;&#x4E8B;&#x52A1;&#x5DF2;&#x7ECF;&#x5F00;&#x59CB;&#x7684;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a>&#x4E0A;&#x5B89;&#x5168;&#x5730;&#x4FEE;&#x6539;&#x3002;</span><span class="yiyi-st" id="yiyi-124">&#x6570;&#x636E;&#x5E93;&#x65E0;&#x6CD5;&#x66F4;&#x6539;&#x6B63;&#x5728;&#x8FDB;&#x884C;&#x7684;&#x4E8B;&#x52A1;&#x7684;&#x9694;&#x79BB;&#x7EA7;&#x522B;&#xFF0C;&#x5E76;&#x4E14;&#x67D0;&#x4E9B;DBAPI&#x548C;SQLAlchemy&#x65B9;&#x8A00;&#x5728;&#x6B64;&#x533A;&#x57DF;&#x4E2D;&#x5177;&#x6709;&#x4E0D;&#x4E00;&#x81F4;&#x7684;&#x884C;&#x4E3A;&#x3002;</span><span class="yiyi-st" id="yiyi-125">&#x6709;&#x4E9B;&#x53EF;&#x80FD;&#x4F1A;&#x9690;&#x5F0F;&#x5730;&#x53D1;&#x51FA;ROLLBACK&#xFF0C;&#x6709;&#x4E9B;&#x53EF;&#x80FD;&#x9690;&#x5F0F;&#x5730;&#x53D1;&#x51FA;COMMIT&#xFF0C;&#x6709;&#x4E9B;&#x53EF;&#x80FD;&#x4F1A;&#x5728;&#x4E0B;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x4E4B;&#x524D;&#x5FFD;&#x7565;&#x8BE5;&#x8BBE;&#x7F6E;&#x3002;</span><span class="yiyi-st" id="yiyi-126">&#x56E0;&#x6B64;&#xFF0C;&#x5982;&#x679C;&#x5728;&#x4E8B;&#x52A1;&#x5DF2;&#x7ECF;&#x5728;&#x4F7F;&#x7528;&#x65F6;&#x8BBE;&#x7F6E;&#x6B64;&#x9009;&#x9879;&#xFF0C;&#x5219;SQLAlchemy&#x4F1A;&#x53D1;&#x51FA;&#x8B66;&#x544A;&#x3002;</span><span class="yiyi-st" id="yiyi-127"><a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x5BF9;&#x8C61;&#x4E0D;&#x4E3A;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x7528;&#x4E8E;&#x4E8B;&#x52A1;&#x5C1A;&#x672A;&#x5F00;&#x59CB;&#x7684;&#x4E8B;&#x52A1;&#x4E2D;&#x7684;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a>&#x3002;</span><span class="yiyi-st" id="yiyi-128">So here, we need to pass execution options to the <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> at the start of a transaction by passing <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.connection.params.execution_options" title="sqlalchemy.orm.session.Session.connection"><code class="xref py py-paramref docutils literal"><span class="pre">Session.connection.execution_options</span></code></a> provided by the <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.connection" title="sqlalchemy.orm.session.Session.connection"><code class="xref py py-meth docutils literal"><span class="pre">Session.connection()</span></code></a> method:</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">sess</span><span class="o">.</span><span class="n">connection</span><span class="p">(</span><span class="n">execution_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&apos;isolation_level&apos;</span><span class="p">:</span> <span class="s1">&apos;SERIALIZABLE&apos;</span><span class="p">})</span>

<span class="c1"># work with session</span>

<span class="c1"># commit transaction.  the connection is released</span>
<span class="c1"># and reverted to its previous isolation level.</span>
<span class="n">sess</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div></div><p><span class="yiyi-st" id="yiyi-129">&#x4EE5;&#x4E0A;&#xFF0C;&#x6211;&#x4EEC;&#x9996;&#x5148;&#x4F7F;&#x7528;&#x6784;&#x9020;&#x51FD;&#x6570;&#x6216;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.sessionmaker" title="sqlalchemy.orm.session.sessionmaker"><code class="xref py py-class docutils literal"><span class="pre">sessionmaker</span></code></a>&#x751F;&#x6210;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x3002;</span><span class="yiyi-st" id="yiyi-130">&#x7136;&#x540E;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x8C03;&#x7528;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.connection" title="sqlalchemy.orm.session.Session.connection"><code class="xref py py-meth docutils literal"><span class="pre">Session.connection()</span></code></a>&#x660E;&#x786E;&#x5730;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x7684;&#x5F00;&#x59CB;&#xFF0C;&#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x5728;&#x4E8B;&#x52A1;&#x5F00;&#x59CB;&#x4E4B;&#x524D;&#x4F20;&#x9012;&#x7ED9;&#x8FDE;&#x63A5;&#x7684;&#x6267;&#x884C;&#x9009;&#x9879;&#x3002;</span><span class="yiyi-st" id="yiyi-131">If we are working with a <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> that has multiple binds or some other custom scheme for <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.get_bind" title="sqlalchemy.orm.session.Session.get_bind"><code class="xref py py-meth docutils literal"><span class="pre">Session.get_bind()</span></code></a>, we can pass additional arguments to <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.connection" title="sqlalchemy.orm.session.Session.connection"><code class="xref py py-meth docutils literal"><span class="pre">Session.connection()</span></code></a> in order to affect how the bind is procured:</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">sess</span> <span class="o">=</span> <span class="n">my_sesssionmaker</span><span class="p">()</span>

<span class="c1"># set up a transaction for the bind associated with</span>
<span class="c1"># the User mapper</span>
<span class="n">sess</span><span class="o">.</span><span class="n">connection</span><span class="p">(</span>
    <span class="n">mapper</span><span class="o">=</span><span class="n">User</span><span class="p">,</span>
    <span class="n">execution_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&apos;isolation_level&apos;</span><span class="p">:</span> <span class="s1">&apos;SERIALIZABLE&apos;</span><span class="p">})</span>

<span class="c1"># work with session</span>

<span class="c1"># commit transaction.  the connection is released</span>
<span class="c1"># and reverted to its previous isolation level.</span>
<span class="n">sess</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div></div><p><span class="yiyi-st" id="yiyi-132"><a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.connection.params.execution_options" title="sqlalchemy.orm.session.Session.connection"><code class="xref py py-paramref docutils literal"><span class="pre">Session.connection.execution_options</span></code></a>&#x53C2;&#x6570;&#x4EC5;&#x5728;&#x9488;&#x5BF9;&#x4E8B;&#x52A1;&#x4E2D;&#x7279;&#x5B9A;&#x7ED1;&#x5B9A;&#x7684;<strong>&#x7B2C;&#x4E00;&#x6B21;</strong>&#x8C03;&#x7528;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.connection" title="sqlalchemy.orm.session.Session.connection"><code class="xref py py-meth docutils literal"><span class="pre">Session.connection()</span></code></a>&#x65F6;&#x624D;&#x88AB;&#x63A5;&#x53D7;&#x3002;</span><span class="yiyi-st" id="yiyi-133">&#x5982;&#x679C;&#x4E8B;&#x52A1;&#x5DF2;&#x7ECF;&#x5728;&#x76EE;&#x6807;&#x8FDE;&#x63A5;&#x4E0A;&#x5F00;&#x59CB;&#xFF0C;&#x5219;&#x4F1A;&#x53D1;&#x51FA;&#x8B66;&#x544A;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">eng</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select 1&quot;</span><span class="p">)</span>
<span class="go">&lt;sqlalchemy.engine.result.ResultProxy object at 0x1017a6c50&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">connection</span><span class="p">(</span><span class="n">execution_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&apos;isolation_level&apos;</span><span class="p">:</span> <span class="s1">&apos;SERIALIZABLE&apos;</span><span class="p">})</span>
<span class="go">sqlalchemy/orm_session.py:310: SAWarning: Connection is already established</span>
<span class="go">for the given bind; execution_options ignored</span></pre></div></div><div class="versionadded"><p><span class="yiyi-st" id="yiyi-134"><span class="versionmodified">&#x7248;&#x672C;0.9.9&#x65B0;&#x589E;&#xFF1A;</span>&#x5C06;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.connection.params.execution_options" title="sqlalchemy.orm.session.Session.connection"><code class="xref py py-paramref docutils literal"><span class="pre">Session.connection.execution_options</span></code></a>&#x53C2;&#x6570;&#x6DFB;&#x52A0;&#x5230;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.connection" title="sqlalchemy.orm.session.Session.connection"><code class="xref py py-meth docutils literal"><span class="pre">Session.connection()</span></code></a>&#x3002;</span></p></div></div></div><div class="section" id="tracking-transaction-state-with-events"><h3><span class="yiyi-st" id="yiyi-135">&#x4F7F;&#x7528;&#x4E8B;&#x4EF6;&#x8DDF;&#x8E2A;&#x4E8B;&#x52A1;&#x72B6;&#x6001;<a class="headerlink" href="#tracking-transaction-state-with-events" title="Permalink to this headline">&#xB6;</a></span></h3><p><span class="yiyi-st" id="yiyi-136">&#x6709;&#x5173;&#x4F1A;&#x8BDD;&#x4E8B;&#x52A1;&#x72B6;&#x6001;&#x66F4;&#x6539;&#x7684;&#x53EF;&#x7528;&#x4E8B;&#x4EF6;&#x6302;&#x94A9;&#x7684;&#x6982;&#x8FF0;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a class="reference internal" href="session_events.html#session-transaction-events"><span>Transaction Events</span></a>&#x90E8;&#x5206;&#x3002;</span></p></div></div><div class="section" id="joining-a-session-into-an-external-transaction-such-as-for-test-suites"><h2><span class="yiyi-st" id="yiyi-137">&#x5C06;&#x4F1A;&#x8BDD;&#x52A0;&#x5165;&#x5916;&#x90E8;&#x4E8B;&#x52A1;&#xFF08;&#x4F8B;&#x5982;&#x6D4B;&#x8BD5;&#x5957;&#x4EF6;&#xFF09;<a class="headerlink" href="#joining-a-session-into-an-external-transaction-such-as-for-test-suites" title="Permalink to this headline">&#xB6;</a></span></h2><p><span class="yiyi-st" id="yiyi-138">If a <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a> is being used which is already in a transactional state (i.e. has a <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Transaction" title="sqlalchemy.engine.Transaction"><code class="xref py py-class docutils literal"><span class="pre">Transaction</span></code></a> established), a <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> can be made to participate within that transaction by just binding the <a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a> to that <a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a>. </span><span class="yiyi-st" id="yiyi-139">&#x901A;&#x5E38;&#x7684;&#x57FA;&#x672C;&#x539F;&#x7406;&#x662F;&#x6D4B;&#x8BD5;&#x5957;&#x4EF6;&#x5141;&#x8BB8;ORM&#x4EE3;&#x7801;&#x4F7F;&#x7528;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x81EA;&#x7531;&#x8FD0;&#x884C;&#xFF0C;&#x5305;&#x62EC;&#x8C03;&#x7528;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.commit" title="sqlalchemy.orm.session.Session.commit"><code class="xref py py-meth docutils literal"><span class="pre">Session.commit()</span></code></a>&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x5176;&#x4E2D;&#x6574;&#x4E2A;&#x6570;&#x636E;&#x5E93;&#x4EA4;&#x4E92;&#x88AB;&#x56DE;&#x6EDA;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="c1"># global application scope.  create Session class, engine</span>
<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&apos;postgresql://...&apos;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SomeTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># connect to the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

        <span class="c1"># begin a non-ORM transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>

        <span class="c1"># bind an individual Session to the connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># use the session in tests.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Foo</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># rollback - everything that happened with the</span>
        <span class="c1"># Session above (including calls to commit())</span>
        <span class="c1"># is rolled back.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>

        <span class="c1"># return connection to the Engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div></div><p><span class="yiyi-st" id="yiyi-140">&#x5728;&#x4E0A;&#x9762;&#xFF0C;&#x6211;&#x4EEC;&#x53D1;&#x5E03;&#x4E86;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.commit" title="sqlalchemy.orm.session.Session.commit"><code class="xref py py-meth docutils literal"><span class="pre">Session.commit()</span></code></a>&#x4EE5;&#x53CA;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Transaction.rollback" title="sqlalchemy.engine.Transaction.rollback"><code class="xref py py-meth docutils literal"><span class="pre">Transaction.rollback()</span></code></a>&#x3002;</span><span class="yiyi-st" id="yiyi-141">&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;<a class="reference internal" href="core_connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal"><span class="pre">Connection</span></code></a>&#x5BF9;&#x8C61;&#x7EF4;&#x62A4;<em>subtransactions</em>&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x6216;&#x5D4C;&#x5957;&#x7684;begin / commit-or-rollback&#x5BF9;&#xFF0C;&#x5176;&#x4E2D;&#x53EA;&#x6709;&#x6700;&#x5916;&#x9762;&#x7684;begin / commit&#x5BF9;&#x5B9E;&#x9645;&#x4E0A;&#x63D0;&#x4EA4;&#x4E8B;&#x52A1;&#xFF0C;&#x6216;&#x8005;&#x5982;&#x679C;&#x6700;&#x5916;&#x9762;&#x7684;&#x5757;&#x56DE;&#x6EDA;&#xFF0C;&#x5219;&#x6240;&#x6709;&#x5185;&#x5BB9;&#x90FD;&#x56DE;&#x6EDA;&#x3002;</span></p><div class="topic"><p class="topic-title first"><span class="yiyi-st" id="yiyi-142">&#x652F;&#x6301;&#x56DE;&#x6EDA;&#x6D4B;&#x8BD5;</span></p><p><span class="yiyi-st" id="yiyi-143">&#x9664;&#x4E86;&#x9700;&#x8981;&#x5728;&#x6D4B;&#x8BD5;&#x672C;&#x8EAB;&#x8303;&#x56F4;&#x5185;&#x5B9E;&#x9645;&#x8C03;&#x7528;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session.rollback" title="sqlalchemy.orm.session.Session.rollback"><code class="xref py py-meth docutils literal"><span class="pre">Session.rollback()</span></code></a>&#x7684;&#x6D4B;&#x8BD5;&#x5916;&#xFF0C;&#x4E0A;&#x8FF0;&#x914D;&#x65B9;&#x9002;&#x7528;&#x4E8E;&#x4EFB;&#x4F55;&#x7C7B;&#x578B;&#x7684;&#x6570;&#x636E;&#x5E93;&#x542F;&#x7528;&#x6D4B;&#x8BD5;&#x3002;</span><span class="yiyi-st" id="yiyi-144">&#x4E0A;&#x9762;&#x7684;&#x914D;&#x65B9;&#x53EF;&#x4EE5;&#x6269;&#x5C55;&#xFF0C;&#x4F7F;&#x5F97;<a class="reference internal" href="session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><code class="xref py py-class docutils literal"><span class="pre">Session</span></code></a>&#x603B;&#x662F;&#x8FD0;&#x884C;&#x5728;&#x6BCF;&#x4E2A;&#x4E8B;&#x52A1;&#x5F00;&#x59CB;&#x65F6;&#x5EFA;&#x7ACB;&#x7684;SAVEPOINT&#x8303;&#x56F4;&#x5185;&#x7684;&#x6240;&#x6709;&#x64CD;&#x4F5C;&#xFF0C;&#x4EE5;&#x4FBF;&#x6D4B;&#x8BD5;&#x8FD8;&#x53EF;&#x4EE5;&#x5C06;&#x201C;&#x4E8B;&#x52A1;&#x201D;&#x56DE;&#x6EDA;&#x4E3A;&#x540C;&#x65F6;&#x4ECD;&#x7136;&#x4FDD;&#x7559;&#x5728;&#x4ECE;&#x672A;&#x72AF;&#x4E0B;&#x7684;&#x8F83;&#x5927;&#x201C;&#x4EA4;&#x6613;&#x201D;&#x7684;&#x8303;&#x56F4;&#x5185;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;&#x4E24;&#x4E2A;&#x989D;&#x5916;&#x4E8B;&#x4EF6;&#xFF1A;</span></p><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">event</span>


<span class="k">class</span> <span class="nc">SomeTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># connect to the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

        <span class="c1"># begin a non-ORM transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>

        <span class="c1"># bind an individual Session to the connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>

        <span class="c1"># start the session in a SAVEPOINT...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span>

        <span class="c1"># then each time that SAVEPOINT ends, reopen it</span>
        <span class="nd">@event.listens_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="s2">&quot;after_transaction_end&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">restart_savepoint</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">transaction</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">nested</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">transaction</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>

                <span class="c1"># ensure that state is expired the way</span>
                <span class="c1"># session.commit() at the top level normally does</span>
                <span class="c1"># (optional step)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">expire_all</span><span class="p">()</span>

                <span class="n">session</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span>

    <span class="c1"># ... the tearDown() method stays the same</span></pre></div></div></div></div>